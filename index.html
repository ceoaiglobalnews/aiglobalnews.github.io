<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AIGLOBALNEWS</title>
<style>
  :root{
    --bg:#0f1623; --card:#121b2b; --ink:#e9eef7; --muted:#a6b0c3;
    --pill:#1f2c45; --accent:#3b82f6; --accent-ink:#fff; --ok:#22c55e; --err:#ef4444;
    --border:rgba(255,255,255,.08);
  }
  [data-theme="light"]{
    --bg:#f6f8fc; --card:#ffffff; --ink:#0b1220; --muted:#5b6474;
    --pill:#e9eef7; --accent:#2563eb; --accent-ink:#fff; --border:rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  .wrap{max-width:880px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:12px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
  .badge{width:28px;height:28px;border-radius:9px;background:var(--accent);color:var(--accent-ink);display:grid;place-items:center;font-weight:700}
  .toolbar{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{padding:8px 12px;border-radius:999px;background:var(--pill);color:var(--ink);border:1px solid var(--border);cursor:pointer}
  .chip.active{background:var(--accent);color:var(--accent-ink)}
  .spacer{flex:1}
  .btn{background:var(--pill);border:1px solid var(--border);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .searchbar{display:flex;gap:8px;margin:12px 0}
  .searchbar input{flex:1;border:1px solid var(--border);background:var(--card);color:var(--ink);padding:10px 12px;border-radius:12px}
  .hint{font-size:.9rem;color:var(--muted);margin:10px 0}
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px 10px;margin:12px 0;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
  }
  .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:.9rem}
  .title{margin:.3rem 0 .4rem}
  .title a{color:var(--ink);text-decoration:none;font-weight:800}
  .title a:hover{text-decoration:underline}
  .deck{color:var(--muted)}
  .actions{
    margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;
    align-items:center;justify-content:flex-start
  }
  .pill{
    border:1px solid var(--border);background:var(--pill);color:var(--ink);
    height:38px;border-radius:10px;padding:0 10px;display:flex;gap:8px;align-items:center;cursor:pointer;
    font-weight:600
  }
  .pill.small{height:34px;font-size:.92rem}
  .pill.primary{background:var(--accent);color:var(--accent-ink);border-color:transparent}
  .reveal{
    margin-top:10px;border-top:1px dashed var(--border);padding-top:10px;display:none
  }
  .reveal.open{display:block}
  .status{color:var(--muted)}
  .small{font-size:.95rem}
  .loadmore{margin:18px auto 40px;display:block}
  .footer{margin:28px 0 60px;color:var(--muted);font-size:.9rem}
  .settings-row{display:flex;gap:10px;align-items:center}
  .settings-row input{
    flex:1;border:1px solid var(--border);background:var(--card);color:var(--ink);
    padding:8px 10px;border-radius:10px
  }
  @media (max-width:560px){
    .pill{height:36px;padding:0 10px}
    .pill span{display:none} /* icon-only at very small widths */
  }
</style>
</head>
<body>
  <div class="wrap" id="app" data-theme="dark">
    <header>
      <div class="logo"><div class="badge">AI</div> <div>AIGLOBALNEWS</div></div>
      <div class="spacer"></div>
      <button class="btn" id="themeToggle" title="Toggle theme">üåì</button>
      <button class="btn" id="openSettings" title="Settings">‚öôÔ∏è</button>
    </header>

    <div class="toolbar" id="sections">
      <!-- chips will render here -->
    </div>

    <div class="searchbar">
      <input id="q" placeholder="Search headlines‚Ä¶" />
      <button class="btn" id="refreshBtn">Refresh</button>
    </div>

    <div class="hint" id="banner"></div>

    <div id="news"></div>

    <button class="btn loadmore" id="loadMore" style="display:none">Load more</button>

    <div class="footer">¬© AIGLOBALNEWS ¬∑ Summaries are informational. Always cite and link sources.</div>
  </div>

  <!-- Settings modal (simple) -->
  <div id="settingsModal" style="position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);">
    <div class="wrap" style="max-width:600px;margin:10vh auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px">
      <h3 style="margin-top:0">Settings</h3>
      <div class="settings-row">
        <label style="min-width:110px;color:var(--muted)">Worker URL</label>
        <input id="workerInput" placeholder="https://YOUR-NAME.workers.dev" />
      </div>
      <div class="settings-row" style="margin-top:10px">
        <div class="spacer"></div>
        <button class="btn" id="saveSettings">Save</button>
        <button class="btn" id="closeSettings">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // -------------------- STATE --------------------
  const S = {
    base: (localStorage.getItem('agl:worker') || '').trim(),
    cat: (localStorage.getItem('agl:cat') || 'all'),
    page: 1,
    q: '',
    loading: false,
    dark: (localStorage.getItem('agl:theme') || 'dark')
  };

  // -------------------- DOM --------------------
  const app = document.getElementById('app');
  const newsEL = document.getElementById('news');
  const loadMoreBtn = document.getElementById('loadMore');
  const qEL = document.getElementById('q');
  const refreshBtn = document.getElementById('refreshBtn');
  const themeToggle = document.getElementById('themeToggle');
  const openSettings = document.getElementById('openSettings');
  const settingsModal = document.getElementById('settingsModal');
  const workerInput = document.getElementById('workerInput');
  const saveSettings = document.getElementById('saveSettings');
  const closeSettings = document.getElementById('closeSettings');
  const banner = document.getElementById('banner');
  const sectionsEL = document.getElementById('sections');

  const CATS = ['all','nhs','workforce','digital','economy','politics'];

  // -------------------- UI INIT --------------------
  renderChips();
  setTheme(S.dark);
  qEL.value = '';
  banner.innerHTML = S.base
    ? 'UK headlines (cached & de-duplicated). Use üîé <b>Fact-check</b> & ‚ú® <b>AI Summary</b>; üìé <b>Copy</b> or üì§ <b>Share</b>.'
    : 'Paste your Cloudflare Worker base URL in <b>Settings</b> to load headlines.';

  if (S.base) loadNews(true);

  // -------------------- EVENTS --------------------
  themeToggle.addEventListener('click', () => {
    setTheme(app.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
  });

  openSettings.addEventListener('click', () => {
    workerInput.value = S.base || '';
    settingsModal.style.display = 'block';
  });

  closeSettings.addEventListener('click', () => settingsModal.style.display = 'none');

  saveSettings.addEventListener('click', () => {
    const v = (workerInput.value || '').trim().replace(/\/+$/,'');
    S.base = v;
    localStorage.setItem('agl:worker', v);
    settingsModal.style.display = 'none';
    banner.innerHTML = v
      ? 'UK headlines (cached & de-duplicated). Use üîé <b>Fact-check</b> & ‚ú® <b>AI Summary</b>; üìé <b>Copy</b> or üì§ <b>Share</b>.'
      : 'Paste your Cloudflare Worker base URL in <b>Settings</b> to load headlines.';
    if (v) loadNews(true);
  });

  refreshBtn.addEventListener('click', () => loadNews(true));
  loadMoreBtn.addEventListener('click', () => loadNews());

  qEL.addEventListener('keydown', e => {
    if (e.key === 'Enter') loadNews(true);
  });

  sectionsEL.addEventListener('click', (e) => {
    const el = e.target.closest('.chip');
    if (!el) return;
    const next = el.dataset.cat;
    if (next && next !== S.cat) {
      S.cat = next;
      localStorage.setItem('agl:cat', S.cat);
      renderChips();
      loadNews(true);
    }
  });

  // -------------------- RENDER --------------------
  function renderChips(){
    sectionsEL.innerHTML = CATS.map(c => `
      <button class="chip ${S.cat===c?'active':''}" data-cat="${c}">${label(c)}</button>
    `).join('');
  }
  function label(c){ return ({all:'All', nhs:'NHS', workforce:'Workforce', digital:'Digital', economy:'Economy', politics:'Politics'})[c] || c }

  function setTheme(t){
    app.setAttribute('data-theme', t);
    localStorage.setItem('agl:theme', t);
  }

  // -------------------- DATA --------------------
  async function loadNews(reset=false){
    if (!S.base){ newsEL.innerHTML = ''; return; }
    if (S.loading) return;
    try{
      S.loading = true;
      if (reset){
        S.page = 1;
        newsEL.innerHTML = '';
        loadMoreBtn.style.display = 'none';
      }
      const url = `${S.base}/aggregate?cat=${encodeURIComponent(S.cat)}&page=${S.page}&q=${encodeURIComponent(qEL.value||'')}`;
      const r = await fetch(url, { headers:{ 'Accept':'application/json' }, mode:'cors' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      const items = (data && (data.articles||data.items||[])) || [];
      if (!items.length && S.page===1){
        newsEL.innerHTML = `<div class="card"><div class="status">No headlines found.</div></div>`;
        return;
      }
      items.forEach(a => renderCard(a));
      S.page++;
      loadMoreBtn.style.display = items.length ? 'block' : 'none';
    }catch(err){
      console.error(err);
      newsEL.innerHTML = `<div class="card"><div class="status" style="color:var(--err)">Couldn't load headlines. Check your Worker URL and logs.</div></div>`;
    }finally{
      S.loading = false;
    }
  }

  function renderCard(a){
    const host = safeHost(a.source || (a.url ? tryHost(a.url) : ''));
    const t = (a.title||'').replace(/^<!\[CDATA\[/,'').replace(/\]\]>$/,'').trim();
    const d = (a.description||'').trim();

    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <div class="meta"><span>${host}</span> ¬∑ <span>${fmtDate(a.publishedAt)}</span></div>
      <h3 class="title"><a href="${a.url}" target="_blank" rel="noopener">${escapeHtml(t)}</a></h3>
      ${d ? `<div class="deck">${escapeHtml(d)}</div>`:''}
      <div class="actions" role="group">
        <button type="button" class="pill small" data-act="fact">üîé <span>Fact-check</span></button>
        <button type="button" class="pill small primary" data-act="sum">‚ú® <span>AI Summary</span></button>
        <button type="button" class="pill small" data-act="copy">üìé <span>Copy</span></button>
        <button type="button" class="pill small" data-act="share">üì§ <span>Share</span></button>
      </div>
      <div class="reveal"></div>
    `;
    const reveal = card.querySelector('.reveal');
    const acts = card.querySelector('.actions');

    acts.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button.pill'); if (!btn) return;
      ev.preventDefault(); ev.stopPropagation();
      const act = btn.dataset.act;

      if (act === 'copy'){
        try{ await navigator.clipboard.writeText(a.url); toast(reveal,'Link copied ‚úì'); }
        catch{ toast(reveal,'Copy failed'); }
        return;
      }

      if (act === 'share'){
        if (navigator.share){
          try{ await navigator.share({ title:t, text:t, url:a.url }); }
          catch{} // user canceled
        } else {
          try{ await navigator.clipboard.writeText(a.url); toast(reveal,'Link copied ‚úì'); }
          catch{ toast(reveal,'Share not available'); }
        }
        return;
      }

      if (act === 'sum'){
        btn.disabled = true;
        reveal.classList.add('open');
        reveal.innerHTML = `<div class="status">‚è≥ Summarising‚Ä¶</div>`;
        try{
          const sumUrl = pickFirst(
            `${S.base}/ai?q=${encodeURIComponent(`${t} ‚Äî ${a.url}`)}`,
            `${S.base}/aisummary?q=${encodeURIComponent(`${t} ‚Äî ${a.url}`)}`
          );
          const r = await fetch(sumUrl, { mode:'cors', headers:{'Accept':'application/json, text/plain'}});
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const ct = (r.headers.get('content-type')||'');
          const data = ct.includes('application/json') ? await r.json() : await r.text();
          const txt = typeof data === 'object' && data && (data.ai || data.summary || data.text)
            ? (data.ai || data.summary || data.text)
            : String(data||'').trim();
          reveal.innerHTML = txt
            ? `<div class="small">${escapeHtml(txt)}</div>${closer()}`
            : `<div class="status">No summary available.</div>${closer()}`;
        }catch(err){
          reveal.innerHTML = `<div class="status" style="color:var(--err)">Summary failed. ${escapeHtml(err.message||'')}</div>${closer()}`;
        }finally{
          btn.disabled = false;
        }
        return;
      }

      if (act === 'fact'){
        btn.disabled = true;
        reveal.classList.add('open');
        reveal.innerHTML = `<div class="status">‚è≥ Checking Fact Check Tools‚Ä¶</div>`;
        try{
          const fc = `${S.base}/factcheck?q=${encodeURIComponent(`${t} ${a.url}`)}&wiki=1&claims=json`;
          const r = await fetch(fc, { mode:'cors', headers:{'Accept':'application/json, text/plain'}, referrerPolicy:'no-referrer' });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const ct = (r.headers.get('content-type')||'');
          const data = ct.includes('application/json') ? await r.json() : await r.text();

          // Worker custom shape
          if (typeof data === 'object' && data && (data.ok || data.proof || data.wiki || data.ai)){
            let html = '';
            if (data.proof) html += row('‚úÖ Proof', link(data.proof));
            if (data.wiki)  html += row('üìö Wikipedia', link(data.wiki));
            if (data.ai)    html += `<div class="small" style="margin-top:6px"><b>AI note</b>: ${escapeHtml(data.ai)}</div>`;
            reveal.innerHTML = html ? html + closer() : noMatches(t) + closer();
            btn.disabled = false; return;
          }

          // Google Fact Check Tools style: {claims:[]}
          if (typeof data === 'object' && data && Array.isArray(data.claims)){
            if (!data.claims.length){ reveal.innerHTML = noMatches(t) + closer(); btn.disabled=false; return; }
            reveal.innerHTML = data.claims.slice(0,4).map(c => `
              <div class="small" style="margin:6px 0">
                <div><b>${escapeHtml(c.text || c.claim || '')}</b></div>
                ${c.claimant ? `<div>By: ${escapeHtml(c.claimant)}</div>`:''}
                ${c.url ? `<div>Source: ${link(c.url)}</div>`:''}
                ${c.rating ? `<div>Rating: ${escapeHtml(c.rating)}</div>`:''}
              </div>`).join('') + closer();
            btn.disabled = false; return;
          }

          // Plain text
          const ttxt = String(data||'').trim();
          reveal.innerHTML = ttxt
            ? `<pre class="small" style="white-space:pre-wrap">${escapeHtml(ttxt)}</pre>${closer()}`
            : noMatches(t) + closer();

        }catch(err){
          reveal.innerHTML = `<div class="status" style="color:var(--err)">Fact-check failed. ${escapeHtml(err.message||'')}</div>${closer()}`;
        }finally{
          btn.disabled = false;
        }
      }
    });

    newsEL.appendChild(card);
  }

  // -------------------- HELPERS --------------------
  function closer(){ return `<div style="margin-top:8px"><button class="btn" onclick="this.closest('.reveal').classList.remove('open')">Close</button></div>` }
  function row(label, val){ return `<div class="small" style="margin:4px 0"><b>${label}:</b> ${val}</div>` }
  function link(u){ try{ const h=new URL(u).hostname; return `<a href="${u}" target="_blank" rel="noopener">${h}</a>` }catch{ return `<a href="${u}" target="_blank" rel="noopener">${u}</a>` } }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]) }
  function tryHost(u){ try{ return new URL(u).hostname }catch{ return '' } }
  function safeHost(h){ return h.replace(/^feeds\./,'').replace(/^www\./,'') }
  function fmtDate(iso){
    if (!iso) return '';
    try{ const d=new Date(iso); return d.toLocaleString([], { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) }
    catch{ return '' }
  }
  function toast(reveal, msg){
    reveal.classList.add('open');
    reveal.innerHTML = `<div class="status">${escapeHtml(msg)}</div>${closer()}`;
  }
  function pickFirst(...urls){ return urls[0]; } // left for future fallback switching
})();
</script>
</body>
</html>
