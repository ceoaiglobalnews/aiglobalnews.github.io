<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AIGLOBALNEWS</title>
<meta name="color-scheme" content="light dark"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #0b1220;
    --card:#111a2b;
    --elev:#0f1726;
    --text:#e6edf7;
    --muted:#a8b3c7;
    --brand:#3b82f6;         /* accent */
    --ok:#10b981;
    --warn:#f59e0b;
    --err:#ef4444;
    --border:rgba(255,255,255,.08);
    --chip:#1d2840;
    --btn:#16213a;
    --btn-text:#dbe6ff;
  }
  :root.light{
    --bg:#f5f7fb; --card:#fff; --elev:#fff; --text:#0b1220; --muted:#4b5563;
    --border:rgba(2,6,23,.1); --chip:#eef2ff; --btn:#e8efff; --btn-text:#0b1220;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);font:400 16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .logo{
    height:36px;width:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#60a5fa);
    display:grid;place-items:center;font-weight:800;color:white
  }
  .title{font-weight:800;letter-spacing:.5px}
  .spacer{flex:1}
  .icon-btn{border:1px solid var(--border);background:var(--card);color:var(--text);height:36px;width:36px;border-radius:10px;display:grid;place-items:center;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chips{margin:8px 0 10px}
  .chip{background:var(--chip);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer}
  .chip.active{background:var(--brand);color:#fff;border-color:transparent}
  .searchbar{display:flex;gap:8px;margin:8px 0 6px}
  .searchbar input{flex:1;height:40px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:0 12px}
  .btn{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:var(--btn);color:var(--btn-text);cursor:pointer}
  .hint{font-size:13px;color:var(--muted);border:1px dashed var(--border);background:var(--elev);padding:10px 12px;border-radius:12px}

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 10px 24px rgba(0,0,0,.18)}
  .meta{font-size:13px;color:var(--muted);display:flex;gap:10px;align-items:center;margin-bottom:4px}
  .titleln{font-weight:700;font-size:20px;margin:3px 0 6px}
  .desc{color:var(--muted);margin-bottom:10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{
    display:flex;align-items:center;gap:8px;border-radius:12px;padding:10px 12px;border:1px solid var(--border);
    background:var(--btn);color:var(--btn-text);cursor:pointer;user-select:none
  }
  .pill.fact{--btn: #111c32}
  .pill.ai{background:var(--brand);border-color:transparent;color:#fff}
  .pill.share{}
  .panel{margin-top:10px;border-top:1px solid var(--border);padding-top:10px;display:none}
  .panel.open{display:block}
  .panel .close-link{color:var(--muted);font-size:13px;cursor:pointer}
  .panel h4{margin:0 0 6px}
  .small{font-size:13px;color:var(--muted)}
  .center{display:grid;place-items:center}
  .loadmore{margin:18px auto 40px}

  .toast{position:fixed;inset:auto 16px 16px auto;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  @media (max-width:640px){
    .actions{gap:6px}
    .pill{flex:1;justify-content:center}
    .titleln{font-size:18px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AI</div>
      <div class="title">AIGLOBALNEWS</div>
      <div class="spacer"></div>
      <button class="icon-btn" id="themeBtn" title="Toggle theme">üåô</button>
      <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
    </header>

    <div class="row chips" id="sections">
      <button class="chip active" data-sec="all">All</button>
      <button class="chip" data-sec="nhs">NHS</button>
      <button class="chip" data-sec="workforce">Workforce</button>
      <button class="chip" data-sec="digital">Digital</button>
      <button class="chip" data-sec="economy">Economy</button>
      <button class="chip" data-sec="politics">Politics</button>
    </div>

    <div class="searchbar">
      <input id="search" placeholder="Search headlines‚Ä¶"/>
      <button class="btn" id="refreshBtn">Refresh</button>
    </div>

    <div class="hint">
      UK headlines (cached & de-duplicated). Use üîé <b>Fact-check</b> (Google Fact Check + Worker fallback),
      ‚ú® <b>AI Summary</b> for quick context, and üì© <b>Share</b> for native share. Summaries are informational; always read the source.
    </div>

    <div id="news"></div>
    <div class="center"><button class="btn loadmore" id="loadMore">Load more</button></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Minimal settings modal -->
  <dialog id="settingsDlg" style="border:none;border-radius:16px;padding:0;background:var(--card);color:var(--text);max-width:520px;width:92%;">
    <div style="padding:18px;border-bottom:1px solid var(--border);font-weight:700">Settings</div>
    <form method="dialog" style="padding:16px 18px;display:grid;gap:10px">
      <label style="font-size:14px;color:var(--muted)">Cloudflare Worker base URL</label>
      <input id="workerInput" placeholder="https://your-worker.workers.dev" style="height:42px;border-radius:12px;border:1px solid var(--border);background:var(--elev);color:var(--text);padding:0 12px"/>
      <div class="small">Stored in this browser (localStorage). If a default is baked into the page, you won‚Äôt be asked again.</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn" value="cancel">Close</button>
        <button class="btn" id="saveWorker" value="default">Save</button>
      </div>
    </form>
  </dialog>

<script>
/* ========= CONFIG =========
   Hard-code your Worker base. Visitors use this by default.
   Example: https://aiglobalnews-worker.YOURNAME.workers.dev
*/
const DEFAULT_WORKER_BASE = "https://aiglobalnews-worker.bmbotelho.workers.dev"; // <-- set yours

/* ====== Theme ====== */
const root = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
function applyTheme(t){ t==='light' ? root.classList.add('light') : root.classList.remove('light'); }
applyTheme(localStorage.getItem('theme')|| (matchMedia('(prefers-color-scheme:light)').matches?'light':'dark'));
themeBtn.onclick=()=>{ const t = root.classList.contains('light')?'dark':'light'; localStorage.setItem('theme',t); applyTheme(t); };

/* ====== Worker base handling (hard-coded first, user override second) ====== */
function getWorkerBase(){
  // If you want ‚Äúno prompts for anyone‚Äù, keep DEFAULT_WORKER_BASE valid.
  // If a user saved an override, use it.
  const saved = localStorage.getItem('workerBase');
  return (saved && /^https?:\/\//.test(saved)) ? saved.replace(/\/$/,'') : DEFAULT_WORKER_BASE.replace(/\/$/,'');
}

/* ====== UI bits ====== */
const newsEL = document.getElementById('news');
const loadBtn = document.getElementById('loadMore');
const refreshBtn = document.getElementById('refreshBtn');
const toastEL = document.getElementById('toast');
const searchEL = document.getElementById('search');
const settingsBtn = document.getElementById('settingsBtn');
const settingsDlg = document.getElementById('settingsDlg');
const workerInput = document.getElementById('workerInput');
document.getElementById('saveWorker').onclick = (e)=>{
  e.preventDefault();
  const v = workerInput.value.trim();
  if(!/^https?:\/\//.test(v)){ return showToast('Enter a valid URL'); }
  localStorage.setItem('workerBase', v.replace(/\/$/,''));
  settingsDlg.close(); showToast('Worker URL saved');
  resetAndLoad(true);
};
settingsBtn.onclick = ()=>{ workerInput.value = getWorkerBase(); settingsDlg.showModal(); };

function showToast(msg){
  toastEL.textContent = msg; toastEL.classList.add('show');
  setTimeout(()=>toastEL.classList.remove('show'),1800);
}

/* ====== State ====== */
let page=1, section='all', q='';

/* ====== Fetch helpers ====== */
async function fetchJSON(url){
  const r = await fetch(url, {mode:'cors', headers:{'Accept':'application/json'}});
  if(!r.ok) throw new Error(`${r.status}`);
  return r.json();
}

/* ====== Rendering ====== */
function cardTemplate(item, idx){
  const safeId = `card-${Date.now()}-${idx}`;
  const pub = new Date(item.publishedAt||Date.now()).toLocaleString();
  return `
  <article class="card" id="${safeId}">
    <div class="meta"><span>${item.source||''}</span> ‚Ä¢ <span>${pub}</span></div>
    <div class="titleln"><a href="${item.url}" target="_blank" rel="noopener">${item.title}</a></div>
    ${item.description?`<div class="desc">${item.description}</div>`:''}
    <div class="actions">
      <button class="pill fact" data-act="fact" data-url="${encodeURIComponent(item.url)}" data-title="${encodeURIComponent(item.title)}">üîé Fact-check</button>
      <button class="pill ai" data-act="ai" data-title="${encodeURIComponent(item.title)}" data-url="${encodeURIComponent(item.url)}">‚ú® AI Summary</button>
      <button class="pill share" data-act="share" data-url="${encodeURIComponent(item.url)}" data-title="${encodeURIComponent(item.title)}">üì© Share</button>
    </div>
    <div class="panel" data-panel></div>
  </article>`;
}

function attachCardHandlers(card){
  const panel = card.querySelector('[data-panel]');
  card.querySelectorAll('.pill').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const act = btn.dataset.act;
      if(act==='share') return doShare(decodeURIComponent(btn.dataset.title), decodeURIComponent(btn.dataset.url));
      if(panel.classList.contains('open') && panel.dataset.kind===act){ // toggle close
        panel.classList.remove('open'); panel.innerHTML='';
        return;
      }
      panel.dataset.kind = act;
      panel.innerHTML = `<div class="small">Working‚Ä¶</div>`;
      panel.classList.add('open');
      try{
        if(act==='fact') await renderFact(panel, decodeURIComponent(btn.dataset.title));
        if(act==='ai') await renderAI(panel, decodeURIComponent(btn.dataset.title), decodeURIComponent(btn.dataset.url));
      }catch(err){
        panel.innerHTML = `<div class="small" style="color:var(--err)">Something went wrong. ${err.message||''}</div>`;
      }
      panel.insertAdjacentHTML('beforeend', `<div class="small" style="margin-top:8px"><span class="close-link">Close</span></div>`);
      panel.querySelector('.close-link').onclick = ()=>{ panel.classList.remove('open'); panel.innerHTML=''; };
    });
  });
}

/* ====== Actions ====== */
async function renderFact(panel, title){
  const base = getWorkerBase();
  // Try Google Fact Check via Worker
  try{
    const j = await fetchJSON(`${base}/factcheck?q=${encodeURIComponent(title)}`);
    if(j && j.claims && j.claims.length){
      const parts = j.claims.slice(0,3).map(c=>`<li><b>${c.text}</b> ‚Äî <a href="${c.url}" target="_blank" rel="noopener">${c.publisher||'source'}</a> (${c.rating||'rating'})</li>`);
      panel.innerHTML = `<h4>Fact-check</h4><ul>${parts.join('')}</ul>`;
      return;
    }
  }catch(e){ /* swallow and fallback */ }
  // Fallback: Worker credibility scan
  try{
    const j2 = await fetchJSON(`${base}/credibility?q=${encodeURIComponent(title)}`);
    panel.innerHTML = `<h4>AI credibility scan</h4><div>${(j2 && j2.ai) ? j2.ai : 'No signals found.'}</div>`;
  }catch(e){
    panel.innerHTML = `<div class="small">No direct matches in Google Fact Check Tools. Try official sources.</div>`;
  }
}

async function renderAI(panel, title, url){
  const base = getWorkerBase();
  const j = await fetchJSON(`${base}/ai?q=${encodeURIComponent(`${title}. URL: ${url}`)}`);
  panel.innerHTML = `<h4>AI Summary</h4><div>${j && (j.ai||j.summary) ? (j.ai||j.summary) : 'No summary returned.'}</div>`;
}

async function doShare(title, url){
  const full = decodeURIComponent(url);
  if(navigator.share){
    try{ await navigator.share({title: decodeURIComponent(title), url: full}); }
    catch(e){ /* user cancelled */ }
  }else{
    try{
      await navigator.clipboard.writeText(full);
      showToast('Link copied');
    }catch(_){ showToast('Copy failed'); }
  }
}

/* ====== Load news ====== */
async function loadNews(reset=false){
  const base = getWorkerBase();
  const url = `${base}/aggregate?page=${page}&section=${encodeURIComponent(section)}&q=${encodeURIComponent(q||'')}`;
  const data = await fetchJSON(url);
  if(reset) newsEL.innerHTML='';
  const items = (data && data.articles)||[];
  if(!items.length && page===1){
    newsEL.innerHTML = `<div class="hint" style="border-style:solid;color:var(--err)">Couldn't load headlines. Check logs.</div>`;
    return;
  }
  const start = newsEL.childElementCount;
  items.forEach((it,i)=> newsEL.insertAdjacentHTML('beforeend', cardTemplate(it, start+i)));
  // wire up handlers for newly added cards
  [...newsEL.children].slice(start).forEach(attachCardHandlers);
}

function resetAndLoad(force=false){
  if(force){ page=1; }
  newsEL.innerHTML=''; page=1; loadNews(true).catch(()=>showToast('Failed to load'));
}

/* ====== Events ====== */
document.getElementById('sections').addEventListener('click', (e)=>{
  const b = e.target.closest('.chip'); if(!b) return;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  b.classList.add('active'); section = b.dataset.sec; resetAndLoad(true);
});
refreshBtn.onclick = ()=> resetAndLoad(true);
document.getElementById('loadMore').onclick = ()=>{ page++; loadNews().catch(()=>showToast('Failed')); };
searchEL.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ q=searchEL.value.trim(); resetAndLoad(true);} });

/* ====== First load ====== */
resetAndLoad(true);
</script>
</body>
</html>
