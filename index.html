<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIGLOBALNEWS</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --text:#0f172a; --muted:#475569; --brand:#1d4ed8;
      --chip:#e2e8f0; --chip-text:#0f172a; --btn:#0f172a; --btn-text:#fff; --ok:#16a34a; --err:#dc2626;
      --ring: rgba(29,78,216,.25);
    }
    .dark{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --brand:#60a5fa;
      --chip:#111827; --chip-text:#e5e7eb; --btn:#1f2937; --btn-text:#e5e7eb; --ring: rgba(96,165,250,.25);
    }
    html,body{height:100%}
    body{
      margin:0; font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--text);
    }
    .container{max-width:980px; margin:0 auto; padding:20px 16px 72px}
    header{display:flex; align-items:center; gap:12px; margin-bottom:12px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
    .logo .dot{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:var(--brand); color:#fff; font-weight:900}
    .spacer{flex:1}
    .toggle{display:flex; align-items:center; gap:8px; user-select:none}
    .toggle input{appearance:none; width:44px; height:26px; border-radius:20px; background:var(--chip); position:relative; outline:none; cursor:pointer}
    .toggle input:before{content:""; position:absolute; left:3px; top:3px; width:20px; height:20px; border-radius:999px; background:#fff; transition:transform .2s}
    .toggle input:checked:before{transform: translateX(18px)}
    /* chips */
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 14px}
    .chip{border:none; background:var(--chip); color:var(--chip-text); padding:8px 12px; border-radius:999px; cursor:pointer}
    .chip.active{background:var(--brand); color:#fff}
    /* search + refresh */
    .controls{display:flex; gap:8px; align-items:center; margin:6px 0 14px}
    .controls input{
      flex:1; padding:12px 14px; border-radius:12px; background:var(--card); color:var(--text);
      border:1px solid transparent; outline:none; box-shadow:0 0 0 0 var(--ring);
    }
    .controls input:focus{border-color:var(--brand); box-shadow:0 0 0 6px var(--ring)}
    .btn{border:none; background:var(--btn); color:var(--btn-text); padding:10px 14px; border-radius:12px; cursor:pointer}
    /* helper text */
    .tip{font-size:.9rem; color:var(--muted); margin-bottom:10px}
    .tip a{color:inherit}
    /* cards */
    .list{display:grid; gap:16px}
    .card{
      background:var(--card); border-radius:18px; padding:14px 14px 10px; border:1px solid rgba(148,163,184,.2)
    }
    .meta{font-size:.8rem; color:var(--muted); margin-bottom:6px}
    .title{font-weight:700; font-size:1.05rem; margin:0 0 6px}
    .title a{color:var(--text); text-decoration:none}
    .desc{color:var(--muted); margin:0 0 10px}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:8px 12px; border-radius:12px; background:var(--chip); color:var(--chip-text); border:none; cursor:pointer}
    .pill.primary{background:var(--brand); color:#fff}
    .result{margin-top:10px; padding:10px; border-radius:12px; background:rgba(148,163,184,.12); color:var(--text); white-space:pre-wrap}
    .result.ok{border-left:4px solid var(--ok)}
    .result.err{border-left:4px solid var(--err)}
    .center{display:grid; place-items:center; margin:18px 0}
    .error{color:var(--err); background:rgba(220,38,38,.08); border:1px solid rgba(220,38,38,.25); padding:12px 14px; border-radius:12px}
    @media (max-width:560px){
      header{gap:8px}
      .logo .dot{width:32px; height:32px}
      .logo{font-size:1rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="dot">AI</div>
        <div>AIGLOBALNEWS</div>
      </div>
      <div class="spacer"></div>
      <label class="toggle" title="Dark/Light">
        ðŸŒ™/ðŸŒž
        <input id="themeToggle" type="checkbox" />
      </label>
    </header>

    <nav class="chips" id="sections">
      <!-- Sections injected -->
    </nav>

    <div class="controls">
      <input id="q" type="search" placeholder="Search headlinesâ€¦" />
      <button class="btn" id="refreshBtn">Refresh</button>
    </div>

    <p class="tip">
      Use ðŸ”Ž <strong>Fact-check</strong> (Google Fact Check + Worker fallback),
      âœ¨ <strong>AI Summary</strong> for quick context, and ðŸ”— <strong>Share</strong> for native share.
      Summaries are informational; always read the source.
    </p>

    <div id="status"></div>
    <div class="list" id="list"></div>
    <div class="center"><button class="pill" id="loadMore">Load more</button></div>
  </div>

  <script>
    // ---------------------------
    // Theme toggle (persisted)
    // ---------------------------
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') { root.classList.add('dark'); themeToggle.checked = true; }
    themeToggle.addEventListener('change', () => {
      if (themeToggle.checked) { root.classList.add('dark'); localStorage.setItem('theme','dark'); }
      else { root.classList.remove('dark'); localStorage.setItem('theme','light'); }
    });

    // ---------------------------
    // App state
    // ---------------------------
    const state = {
      section: 'all',
      page: 1,
      q: ''
    };

    const SECTIONS = [
      ['all','All'], ['nhs','NHS'], ['workforce','Workforce'],
      ['digital','Digital'], ['economy','Economy'], ['politics','Politics']
    ];

    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const loadMoreBtn = document.getElementById('loadMore');
    const qEl = document.getElementById('q');

    // Build section chips
    const sectionsEl = document.getElementById('sections');
    for (const [val, label] of SECTIONS) {
      const b = document.createElement('button');
      b.className = 'chip' + (val===state.section?' active':'');
      b.textContent = label;
      b.dataset.section = val;
      b.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        b.classList.add('active');
        state.section = val;
        state.page = 1;
        fetchAndRender({reset:true});
      });
      sectionsEl.appendChild(b);
    }

    // Search + refresh
    qEl.addEventListener('keydown', (e)=> {
      if (e.key === 'Enter') { state.q = qEl.value.trim(); state.page = 1; fetchAndRender({reset:true}); }
    });
    document.getElementById('refreshBtn').addEventListener('click', () => {
      state.q = qEl.value.trim(); state.page = 1; fetchAndRender({reset:true});
    });
    loadMoreBtn.addEventListener('click', () => { state.page++; fetchAndRender(); });

    // ---------------------------
    // Helpers
    // ---------------------------
    const API = {
      aggregate: (page, section, q) =>
        `/aggregate?page=${encodeURIComponent(page)}&section=${encodeURIComponent(section)}&q=${encodeURIComponent(q||'')}`,
      summary: (url) => `/summary?url=${encodeURIComponent(url)}`,
      factcheck: (url) => `/factcheck?url=${encodeURIComponent(url)}`
    };

    function el(tag, className, text){ const e=document.createElement(tag); if(className) e.className=className; if(text!=null) e.textContent=text; return e; }

    // Defensive normaliser: accepts many shapes
    function normalise(item){
      const title = item.title || item.headline || item.name || '';
      const link  = item.link || item.url || item.href || '';
      const source = item.source?.name || item.source || new URL(link||'http://example.com').hostname;
      const date = item.published_at || item.pubDate || item.date || item.publishedAt || '';
      const descHTML = item.description || item.summary || item.snippet || '';
      const desc = stripTags(descHTML).trim();
      return { title: cleanCDATA(title), link, source, date, desc, rawDesc: descHTML };
    }
    function stripTags(html){
      const tmp=document.createElement('div'); tmp.innerHTML=html||''; return tmp.textContent||tmp.innerText||'';
    }
    function cleanCDATA(s){ return String(s||'').replace(/^<!\[CDATA\[/,'').replace(/\]\]>$/,''); }

    function showError(message){
      statusEl.innerHTML = `<div class="error">${message}</div>`;
    }
    function clearError(){ statusEl.innerHTML = ''; }

    // ---------------------------
    // Fetch + render
    // ---------------------------
    async function fetchAndRender({reset} = {}){
      try{
        clearError();
        if (reset) listEl.innerHTML = '';
        const url = API.aggregate(state.page, state.section, state.q);
        const res = await fetch(url, { method:'GET' });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();

        // Accept a few shapes: {items: [...]}, {articles: [...]}, direct array
        const items = Array.isArray(data) ? data
                     : Array.isArray(data.items) ? data.items
                     : Array.isArray(data.articles) ? data.articles
                     : [];

        if (items.length === 0 && state.page === 1){
          showError('No headlines right now. Try a different section or search.');
          return;
        }

        for (const raw of items){
          const it = normalise(raw);
          listEl.appendChild(renderCard(it));
        }
      }catch(err){
        console.error(err);
        showError(`Couldn't load headlines. ${err.message}`);
      }
    }

    function renderCard(it){
      const card = el('article','card');
      const meta = el('div','meta', `${it.source || 'Unknown source'} ${it.date? ' â€¢ ' + new Date(it.date).toLocaleString():''}`);
      const title = document.createElement('h3'); title.className='title';
      const a = document.createElement('a'); a.href = it.link || '#'; a.target='_blank'; a.rel='noopener noreferrer';
      a.textContent = it.title || '(untitled)';
      title.appendChild(a);

      const desc = el('p','desc', it.desc);

      const row = el('div','row');
      const fc = el('button','pill','Fact-check'); fc.addEventListener('click', ()=> runTool(fc, API.factcheck(it.link), 'fact'));
      const sm = el('button','pill primary','AI Summary'); sm.addEventListener('click', ()=> runTool(sm, API.summary(it.link), 'summary'));
      const sh = el('button','pill','Share'); sh.addEventListener('click', ()=> doShare(it));

      row.append(fc, sm, sh);

      const result = el('div','result'); result.style.display='none';

      card.append(meta, title, desc, row, result);
      return card;
    }

    async function runTool(btn, url, kind){
      const card = btn.closest('.card');
      const result = card.querySelector('.result');
      result.style.display = 'block';
      result.className = 'result';
      result.textContent = (kind==='summary' ? 'Summarisingâ€¦' : 'Checkingâ€¦');

      try{
        const res = await fetch(url, { method: 'GET' });
        if (!res.ok){
          const text = await res.text();
          throw new Error(`${res.status} ${res.statusText}: ${text.slice(0,120)}`);
        }
        // Accept either JSON {text: "..."} or plain text
        let out;
        const ctype = res.headers.get('content-type') || '';
        if (ctype.includes('application/json')){
          const j = await res.json();
          out = j.text || j.summary || JSON.stringify(j, null, 2);
        }else{
          out = await res.text();
        }
        result.classList.add('ok');
        result.textContent = out.trim() || '(no result)';
      }catch(err){
        result.classList.add('err');
        result.textContent = `Error: ${err.message}`;
      }
    }

    async function doShare(it){
      const text = `${it.title}\n${it.link}`;
      try{
        if (navigator.share){
          await navigator.share({ title: it.title, text, url: it.link });
        }else{
          await navigator.clipboard.writeText(text);
          alert('Link copied to clipboard.');
        }
      }catch(_){}
    }

    // Kick off
    fetchAndRender({reset:true});
  </script>
</body>
</html>
