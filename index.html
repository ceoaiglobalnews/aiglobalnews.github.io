<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIGLOBALNEWS</title>
  <style>
    :root{
      --bg:#0e1420; --card:#111927; --muted:#8da2b8; --text:#e9eef5;
      --brand:#3b82f6; --brand-2:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#1b2433;color:var(--muted);border:1px solid #1f2a3a}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    .tab{padding:6px 12px;border-radius:999px;border:1px solid #1f2a3a;background:#121b2a;color:var(--muted);cursor:pointer}
    .tab.active{color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent}
    .row{display:flex;gap:8px;align-items:center}
    .search{flex:1;position:relative}
    .search input{width:100%;padding:10px 12px 10px 36px;border-radius:10px;border:1px solid #243144;background:#0a1220;color:var(--text)}
    .search:before{content:"ðŸ”Ž";position:absolute;left:10px;top:8px;opacity:.7}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #263349;background:#121b2a;color:#cfe0fb;cursor:pointer}
    .btn.brand{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff}
    .hint{font-size:13px;color:var(--muted);margin:10px 0}
    .grid{display:grid;gap:14px;margin:16px 0 40px}
    .card{background:var(--card);border:1px solid #1b2434;border-radius:var(--radius);padding:14px}
    .src{font-size:12px;color:var(--muted)}
    .title{margin:6px 0 8px}
    .title a{color:#fff;text-decoration:none}
    .title a:hover{text-decoration:underline}
    .deck{color:#c6d4e3}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;border:1px solid #253247;background:#0f1726;color:#e6f0ff;cursor:pointer}
    .pill.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#fff}
    .result{margin-top:10px;border-top:1px dashed #243148;padding-top:10px;color:#dbe7f8;font-size:15px}
    .error{color:#ffd5d5}
    .muted{color:var(--muted)}
    .center{display:flex;justify-content:center;margin:12px 0}
    footer{margin:48px 0 32px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:560px){
      .pill{padding:7px 9px}
      .title{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span class="chip">AI</span> AIGLOBALNEWS</div>
      <div class="chip">UK headlines (cached &amp; de-duped)</div>
    </header>

    <div class="tabs" id="tabs">
      <button class="tab active" data-s="all">All</button>
      <button class="tab" data-s="nhs">NHS</button>
      <button class="tab" data-s="workforce">Workforce</button>
      <button class="tab" data-s="digital">Digital</button>
      <button class="tab" data-s="economy">Economy</button>
      <button class="tab" data-s="politics">Politics</button>
    </div>

    <div class="row">
      <div class="search"><input id="q" placeholder="Search headlinesâ€¦"></div>
      <button class="btn" id="refresh">Refresh</button>
    </div>

    <p class="hint">
      Use ðŸ”Ž <strong>Fact-check</strong> (Google Fact Check + Worker fallback), âœ¨ <strong>AI Summary</strong> for quick context, and ðŸ”— <strong>Share</strong> for native share.
    </p>

    <div id="status" class="muted" style="min-height:18px;"></div>

    <div class="grid" id="list"></div>

    <div class="center"><button class="btn brand" id="more">Load more</button></div>

    <footer>Â© AIGLOBALNEWS Â· Built with Cloudflare Workers & GitHub Pages.</footer>
  </div>

  <script>
    /*
      HOW FETCHING WORKS (robust, no prompts):
      1) Try same-origin:   https://aiglobalnews.co.uk/aggregate?...  (needs CF Routes)
      2) Fallback to Worker https://<your>.workers.dev/aggregate?...   (CORS enabled on Worker)
    */
    const SAME_ORIGIN = location.origin;                                // try routes first
    const BACKUP_WORKER = "https://aiglobalnews-worker.bmbotelho.workers.dev"; // <â€” keep this
    const ENDPOINTS = { list: "/aggregate", fact: "/factcheck", sum: "/summary" };

    let section = "all";
    let page = 1;
    let query = "";

    const els = {
      tabs: document.getElementById("tabs"),
      q: document.getElementById("q"),
      refresh: document.getElementById("refresh"),
      more: document.getElementById("more"),
      list: document.getElementById("list"),
      status: document.getElementById("status"),
    };

    function pill(text, cls=""){ const b=document.createElement("button"); b.className=`pill ${cls}`.trim(); b.textContent=text; return b; }
    function fmtDate(iso){ try{ const d=new Date(iso); return d.toLocaleString(undefined,{hour12:false}); }catch{ return ""; } }

    async function tryFetch(base, path, params){
      const url = new URL(base.replace(/\/$/,"")+path);
      if(params) Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
      const res = await fetch(url, {mode:"cors"});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function fetchJSON(path, params){
      // 1) same-origin route
      try { return await tryFetch(SAME_ORIGIN, path, params); }
      catch (e1) {
        console.warn("Same-origin route failed:", e1?.message || e1);
        // 2) workers.dev fallback
        try { return await tryFetch(BACKUP_WORKER, path, params); }
        catch (e2) {
          console.error("Worker fallback failed:", e2?.message || e2);
          throw e2;
        }
      }
    }

    async function load(reset=false){
      if(reset){ page=1; els.list.innerHTML=""; }
      els.status.textContent = "Loadingâ€¦";
      try{
        const data = await fetchJSON(ENDPOINTS.list, { page, section, q: query || "" });
        if(!data?.ok) throw new Error("API not ok");

        const items = Array.isArray(data.articles) ? data.articles : [];
        if(reset && items.length===0){
          els.list.innerHTML="";
          els.status.innerHTML = `<span class="error">No headlines found for "${section}"</span>`;
          return;
        }
        items.forEach(renderCard);
        page++;
        els.status.textContent = "";
      }catch(err){
        els.status.innerHTML = `<span class="error">Couldn't load headlines. ${err?.message||err}</span>`;
      }
    }

    function renderCard(a){
      const card = document.createElement("div");
      card.className="card";

      const src = document.createElement("div");
      src.className="src";
      src.textContent = `${a.source || ""}  â€¢  ${fmtDate(a.publishedAt)||""}`;
      card.appendChild(src);

      const title = document.createElement("h3");
      title.className="title";
      if(a.url){
        const link=document.createElement("a");
        link.href=a.url; link.target="_blank"; link.rel="noopener";
        link.textContent=(a.title||"").replace(/^<!\[CDATA\[(.*)\]\]>$/,"$1");
        title.appendChild(link);
      }else{
        title.textContent=(a.title||"").replace(/^<!\[CDATA\[(.*)\]\]>$/,"$1");
      }
      card.appendChild(title);

      if(a.description){
        const deck=document.createElement("div");
        deck.className="deck";
        deck.textContent=a.description;
        card.appendChild(deck);
      }

      const actions=document.createElement("div");
      actions.className="actions";

      const btnFact = pill("Fact-check");
      const btnSum  = pill("AI Summary","primary");
      const btnShare= pill("Share");

      actions.append(btnFact, btnSum, btnShare);
      card.appendChild(actions);

      const result = document.createElement("div");
      result.className="result"; result.style.display="none";
      card.appendChild(result);

      btnFact.onclick = async ()=>{
        result.style.display="block";
        result.innerHTML = `<span class="muted">Checking sourcesâ€¦</span>`;
        try{
          const out = await fetchJSON(ENDPOINTS.fact, { q: a.title||a.description||"", url: a.url||"" });
          if(out?.ok && Array.isArray(out.matches) && out.matches.length){
            const rows = out.matches.map(m=>`â€¢ <a href="${m.url}" target="_blank" rel="noopener">${m.title||m.url}</a> â€” ${m.rating||""}`).join("<br>");
            result.innerHTML = rows;
          }else if(out?.ok && Array.isArray(out.related) && out.related.length){
            const rows = out.related.slice(0,5).map(m=>`â€¢ <a href="${m.url}" target="_blank" rel="noopener">${m.title||m.url}</a>`).join("<br>");
            result.innerHTML = rows || `<span class="muted">No direct matches. Try official sources.</span>`;
          }else{
            result.innerHTML = `<span class="muted">No direct matches in Google Fact Check Tools. Try official sources.</span>`;
          }
        }catch(e){
          result.innerHTML = `<span class="error">Fact-check failed: ${e?.message||e}</span>`;
        }
      };

      btnSum.onclick = async ()=>{
        result.style.display="block";
        result.innerHTML = `<span class="muted">Summarisingâ€¦</span>`;
        try{
          const out = await fetchJSON(ENDPOINTS.sum, { url: a.url||"", title: a.title||"", desc: a.description||"" });
          if(out?.ok && out.summary){
            result.textContent = out.summary;
          }else{
            result.innerHTML = `<span class="error">AI summary unavailable.</span>`;
          }
        }catch(e){
          result.innerHTML = `<span class="error">AI summary failed: ${e?.message||e}</span>`;
        }
      };

      btnShare.onclick = async ()=>{
        const url = a.url || location.href;
        const text = a.title || "AIGLOBALNEWS";
        if(navigator.share){
          try{ await navigator.share({title:text,text, url}); }catch{}
        }else{
          try{
            await navigator.clipboard.writeText(url);
            btnShare.textContent="Copied";
            setTimeout(()=>btnShare.textContent="Share",1200);
          }catch{}
        }
      };

      // collapse on second click anywhere inside result
      result.onclick = ()=>{ result.style.display="none"; };

      els.list.appendChild(card);
    }

    // UI events
    els.tabs.addEventListener("click", (e)=>{
      const b=e.target.closest("button.tab"); if(!b) return;
      [...els.tabs.children].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      section=b.dataset.s||"all";
      load(true);
    });
    els.refresh.onclick = ()=> load(true);
    els.more.onclick = ()=> load(false);
    els.q.addEventListener("input", (e)=>{ query=e.target.value.trim(); });

    // kick off
    load(true);
  </script>
</body>
</html>
