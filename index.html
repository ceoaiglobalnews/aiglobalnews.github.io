<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AIGLOBALNEWS</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    /* ===== THEME VARIABLES ===== */
    :root {
      --bg:#0b1220; --card:#121a2b; --text:#e7edf8; --muted:#9fb0cf;
      --accent:#4da3ff; --accent-2:#7bc6ff; --border:#1e2a44;
      --btn:#18243d; --btn-text:#e7edf8; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    :root.light {
      --bg:#f6f8fc; --card:#fff; --text:#0d1b2a; --muted:#546380;
      --accent:#0b6bcb; --accent-2:#389cff; --border:#dbe5f4;
      --btn:#eef4ff; --btn-text:#0d1b2a; --shadow:0 6px 20px rgba(15,29,61,.08);
    }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    a { color:var(--accent); text-decoration:none }
    a:hover{text-decoration:underline}
    .wrap{max-width:900px;margin:auto;padding:16px}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:10}
    .brand{font-weight:800;display:flex;align-items:center;gap:8px}
    .pillbar{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}
    .pill{padding:6px 12px;border-radius:999px;background:var(--card);border:1px solid var(--border);cursor:pointer}
    .pill.active{background:var(--accent);color:#fff;border:0}
    .row{display:flex;gap:8px}
    .search{flex:1;display:flex;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:4px 8px}
    .search input{flex:1;background:transparent;border:0;color:var(--text)}
    .btn{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--btn);color:var(--btn-text);cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin:10px 0;box-shadow:var(--shadow)}
    .meta{font-size:.8rem;color:var(--muted);margin-bottom:4px}
    .title{font-weight:700;margin:4px 0}
    .actions{display:flex;gap:6px;margin-top:8px}
    .action{flex:1;padding:8px;background:var(--btn);border:1px solid var(--border);border-radius:6px;text-align:center;cursor:pointer}
    .action.primary{background:var(--accent);color:#fff;border:0}
    .result{margin-top:8px;padding:8px;border:1px solid var(--border);border-radius:6px}
    .close{cursor:pointer;color:var(--muted);float:right}
    .toggle{margin-left:auto}
  </style>
</head>
<body>
<header class="wrap">
  <div style="display:flex;align-items:center;gap:10px">
    <div class="brand">üì∞ AIGLOBALNEWS</div>
    <div class="toggle">
      <label><input id="themeSwitch" type="checkbox"/> üåô/‚òÄÔ∏è</label>
    </div>
  </div>
  <div class="pillbar" id="sections"></div>
  <div class="row">
    <div class="search"><input id="q" placeholder="Search..."></div>
    <button id="refreshBtn" class="btn">Refresh</button>
  </div>
</header>

<div class="wrap">
  <main id="feed"></main>
  <div style="text-align:center;margin:10px"><button id="loadMore" class="btn">Load more</button></div>
</div>

<script>
const API_BASE = ""; // same-origin Worker
const SECTIONS = [
  {key:"all",label:"All"},{key:"nhs",label:"NHS"},{key:"workforce",label:"Workforce"},
  {key:"digital",label:"Digital"},{key:"economy",label:"Economy"},{key:"politics",label:"Politics"}
];
let page=1,section="all",query="",loading=false;

const feed=document.getElementById("feed"),
      q=document.getElementById("q"),
      refreshBtn=document.getElementById("refreshBtn"),
      loadMoreBtn=document.getElementById("loadMore");

function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
const clean=s=>(s||"").replace(/^<!\[CDATA\[/,"").replace(/\]\]>$/,"").trim();
const fmtTime=iso=>{try{return new Date(iso).toLocaleString()}catch{return ""}};

function pillbar(){
  const secWrap=document.getElementById("sections");
  SECTIONS.forEach(s=>{
    const b=document.createElement("button");
    b.className="pill"+(s.key===section?" active":"");
    b.textContent=s.label;
    b.onclick=()=>{document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));b.classList.add("active");section=s.key;page=1;feed.innerHTML="";load(true)};
    secWrap.appendChild(b);
  })
}
pillbar();

refreshBtn.onclick=()=>{page=1;feed.innerHTML="";load(true)};
q.oninput=debounce(()=>{query=q.value.trim();page=1;feed.innerHTML="";load(true)},400);
loadMoreBtn.onclick=()=>load(false);

async function api(path,params={}){
  const url=new URL(path,location.origin);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r=await fetch(url); if(!r.ok) throw new Error(r.status); return r.json();
}

async function load(reset=false){
  if(loading) return; loading=true; loadMoreBtn.textContent="Loading‚Ä¶";
  try{
    const data=await api("/aggregate",{page,section,q:query});
    if(reset) feed.innerHTML="";
    (data.articles||[]).forEach(addCard); page++;
  }catch(e){console.error(e);if(page===1) feed.innerHTML="<div>Couldn't load headlines.</div>"}finally{
    loading=false; loadMoreBtn.textContent="Load more";
  }
}

function addCard(a){
  const card=document.createElement("div");card.className="card";
  card.innerHTML=`<div class="meta">${a.source||""} ¬∑ ${fmtTime(a.publishedAt)}</div>
  <div class="title">${a.url?`<a href="${a.url}" target="_blank">${clean(a.title)}</a>`:clean(a.title)}</div>
  <div class="desc">${a.description||""}</div>`;
  const actions=document.createElement("div");actions.className="actions";
  const res=document.createElement("div");res.className="result";res.hidden=true;
  const resBody=document.createElement("div");const close=document.createElement("span");close.className="close";close.textContent="Close";close.onclick=()=>res.hidden=true;
  res.appendChild(close);res.appendChild(resBody);
  [["Fact-check",""],["AI Summary","primary"],["Share",""]].forEach(([lbl,cls])=>{
    const b=document.createElement("button");b.className="action "+cls;b.textContent=lbl;
    b.onclick=async()=>{
      res.hidden=false;resBody.textContent="Loading‚Ä¶";
      if(lbl==="Fact-check"){try{const d=await api("/factcheck",{url:a.url,q:a.title});resBody.textContent=JSON.stringify(d)}catch{resBody.textContent="Fact-check failed"}} 
      if(lbl==="AI Summary"){try{const d=await api("/summary",{url:a.url,title:a.title});resBody.textContent=d.summary||"No summary"}catch{resBody.textContent="Summary failed"}}
      if(lbl==="Share"){if(navigator.share){navigator.share({title:a.title,url:a.url})}else{navigator.clipboard.writeText(a.url);alert("Link copied")}}
    };
    actions.appendChild(b);
  });
  card.appendChild(actions);card.appendChild(res);feed.appendChild(card);
}

// Theme toggle
const root=document.documentElement,switchEl=document.getElementById("themeSwitch");
const saved=localStorage.getItem("theme");if(saved==="light")root.classList.add("light");
switchEl.checked=root.classList.contains("light");
switchEl.onchange=()=>{if(switchEl.checked){root.classList.add("light");localStorage.setItem("theme","light")}else{root.classList.remove("light");localStorage.setItem("theme","dark")}};
load(true);
</script>
</body>
</html>
