<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AIGLOBALNEWS</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0e1523; --card:#111b2e; --text:#e6ebf5; --muted:#9fb0c9;
    --accent:#4da2ff; --accent-2:#7dd3fc; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --chip:#0f243f;
  }
  [data-theme="light"]{
    --bg:#f6f7fb; --card:#ffffff; --text:#0b1320; --muted:#5a6a83;
    --accent:#2563eb; --accent-2:#0891b2; --chip:#e9eef9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
  a{color:inherit}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:12px;padding:8px 0 12px}
  .logo{display:inline-grid;place-items:center;width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));font-weight:800}
  h1{font-size:20px;margin:0}
  .spacer{flex:1}
  .icon-btn{background:var(--card);border:1px solid rgba(255,255,255,.08);color:var(--text);width:40px;height:40px;border-radius:12px;display:grid;place-items:center;cursor:pointer}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
  .chip{background:var(--chip);border:1px solid rgba(255,255,255,.06);padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--text);user-select:none}
  .chip.active{outline:2px solid var(--accent)}
  .search-row{display:flex;gap:8px;align-items:center}
  .search{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:var(--card);color:var(--text)}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:var(--card);cursor:pointer;color:var(--text)}
  .list{display:flex;flex-direction:column;gap:12px;margin:12px 0 40px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 14px 10px}
  .meta{color:var(--muted);font-size:13px;margin-bottom:6px;display:flex;gap:10px;flex-wrap:wrap}
  .title{font-weight:760;font-size:20px;margin:0 0 8px}
  .desc{color:var(--muted);margin:0 0 10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{flex:1 1 160px;min-width:150px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);display:flex;gap:8px;align-items:center;justify-content:center;cursor:pointer}
  .pill.primary{background:var(--accent);border-color:transparent;color:#fff}
  .pill:disabled{opacity:.6;cursor:default}
  .reveal{margin-top:10px;border-top:1px dashed rgba(255,255,255,.12);padding-top:10px;display:none}
  .reveal.open{display:block}
  .small{font-size:13px;color:var(--muted)}
  .status{font-size:13px;margin-top:6px}
  .center{display:grid;place-items:center}
  .loadmore{display:block;margin:10px auto 0}
  @media (max-width:520px){
    .title{font-size:18px}
    .pill{flex:1 1 calc(50% - 4px);min-width:auto}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">AI</div>
    <h1>AIGLOBALNEWS</h1>
    <div class="spacer"></div>
    <button id="themeBtn" class="icon-btn" title="Toggle theme">üåó</button>
    <button id="settingsBtn" class="icon-btn" title="Settings">‚öôÔ∏è</button>
  </header>

  <div class="controls">
    <div id="cats" class="controls" style="padding:0">
      <div class="chip active" data-cat="all">All</div>
      <div class="chip" data-cat="nhs">NHS</div>
      <div class="chip" data-cat="workforce">Workforce</div>
      <div class="chip" data-cat="digital">Digital</div>
      <div class="chip" data-cat="economy">Economy</div>
      <div class="chip" data-cat="politics">Politics</div>
    </div>
  </div>

  <div class="controls search-row">
    <input id="q" class="search" placeholder="Search headlines..." />
    <button id="refreshBtn" class="btn">Refresh</button>
  </div>

  <p class="small">UK headlines (cached & de-duplicated). Use üîé <b>Fact-check</b> & ‚ú® <b>AI Summary</b>. üìé <b>Copy link</b> copies the article URL.</p>

  <div id="list" class="list"></div>

  <div class="center"><button id="loadMore" class="btn loadmore">Load more</button></div>
</div>

<script>
/*** CONFIG *******************************************************************/
const WORKER_BASE =
  'https://aiglobalnews-worker.bmbotelho.workers.dev';  // ‚Üê put your Worker URL here
const PAGE_SIZE = 20;

/*** THEME ********************************************************************/
const root = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
(function initTheme(){
  const saved = localStorage.getItem('agn_theme') || 'dark';
  if (saved === 'light') root.setAttribute('data-theme','light');
  themeBtn.addEventListener('click', ()=>{
    const now = root.getAttribute('data-theme')==='light' ? 'dark' : 'light';
    if (now==='light') root.setAttribute('data-theme','light'); else root.removeAttribute('data-theme');
    localStorage.setItem('agn_theme', now);
  });
})();

/*** STATE ********************************************************************/
let page = 1;
let category = 'all';
let query = '';

/*** UTIL *********************************************************************/
const fmtTime = iso => {
  try{
    const d = new Date(iso);
    return d.toLocaleString([], {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
  }catch{ return ''; }
};
const el = (html) => {
  const d = document.createElement('div'); d.innerHTML = html.trim(); return d.firstElementChild;
};

async function fetchJSONorText(url){
  const r = await fetch(url, {mode:'cors', headers:{'Accept':'application/json, text/plain'}})
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const ct = r.headers.get('content-type') || '';
  if (ct.includes('application/json')) return await r.json();
  return await r.text();
}

/*** RENDER *******************************************************************/
const list = document.getElementById('list');
function cardTpl(a, idx){
  const id = 'reveal_' + (Date.now()+idx).toString(36);
  const host = new URL(a.url).hostname.replace(/^www\./,'');
  return `
  <article class="card">
    <div class="meta">
      <span>${host}</span> ‚Ä¢ <span>${fmtTime(a.publishedAt) || ''}</span>
    </div>
    <h2 class="title"><a href="${a.url}" target="_blank" rel="noopener">${a.title}</a></h2>
    ${a.description ? `<p class="desc">${a.description}</p>` : ``}

    <div class="actions">
      <button class="pill" data-act="fact" data-url="${encodeURIComponent(a.url)}" data-title="${encodeURIComponent(a.title)}">üîé Fact-check</button>
      <button class="pill primary" data-act="sum" data-url="${encodeURIComponent(a.url)}" data-title="${encodeURIComponent(a.title)}">‚ú® AI Summary</button>
      <button class="pill" data-act="copy" data-url="${encodeURIComponent(a.url)}">üìé Copy link</button>
      <button class="pill" data-act="share" data-url="${encodeURIComponent(a.url)}" data-title="${encodeURIComponent(a.title)}">üì§ Share</button>
    </div>

    <div id="${id}" class="reveal"></div>
  </article>`;
}

function attachActions(scope){
  scope.querySelectorAll('.pill').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const act = btn.dataset.act;
      const url = decodeURIComponent(btn.dataset.url || '');
      const title = decodeURIComponent(btn.dataset.title || '');
      const reveal = btn.closest('.card').querySelector('.reveal');
      try{
        if (act==='copy'){
          await navigator.clipboard.writeText(url);
          btn.textContent = '‚úÖ Copied'; setTimeout(()=>btn.textContent='üìé Copy link',1200);
          return;
        }
        if (act==='share'){
          if (navigator.share){
            try{ await navigator.share({title, url}); }catch{}
          }else{
            await navigator.clipboard.writeText(url);
            alert('Link copied to clipboard');
          }
          return;
        }
        if (act==='fact'){
          btn.disabled = true; reveal.classList.add('open'); reveal.innerHTML = `<div class="status">‚è≥ Checking Fact Check Tools‚Ä¶</div>`;
          const fcUrl = `${WORKER_BASE}/factcheck?q=${encodeURIComponent(title)} ${encodeURIComponent(url)}&wiki=1&claims=json`;
          const data = await fetchJSONorText(fcUrl);
          renderFactCheck(reveal, data, title, url);
        }
        if (act==='sum'){
          btn.disabled = true; reveal.classList.add('open'); reveal.innerHTML = `<div class="status">‚è≥ Summarising‚Ä¶</div>`;
          const sUrl = `${WORKER_BASE}/aisummary?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
          const data = await fetchJSONorText(sUrl);
          renderSummary(reveal, data);
        }
      }catch(err){
        console.error(err);
        reveal.classList.add('open');
        reveal.innerHTML = `<div class="status" style="color:var(--err)">‚ö†Ô∏è ${act==='fact'?'Fact-check':'Summary'} failed. ${err.message || ''}</div>`;
      }finally{
        btn.disabled = false;
      }
    });
  });
}

function renderFactCheck(reveal, data, title, url){
  // Support JSON or plain text
  let html = '';
  if (typeof data === 'string'){
    const t = data.trim();
    if (!t || t==='{}') {
      html = `<div class="status">No direct matches in Google Fact Check Tools. Try official sources:
        <a href="https://news.google.com/search?q=${encodeURIComponent(title)}" target="_blank" rel="noopener">Google News</a>,
        <a href="https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(title)}" target="_blank" rel="noopener">Wikipedia</a>.
      </div>`;
    } else {
      html = `<pre class="small" style="white-space:pre-wrap">${escapeHtml(t)}</pre>`;
    }
  } else if (data && Array.isArray(data.claims) && data.claims.length){
    html = `<div class="small"><b>Matches:</b></div>` +
      data.claims.slice(0,4).map(c=>`
        <div class="small" style="margin:6px 0">
          <div><b>${escapeHtml(c.text || c.claim || '')}</b></div>
          ${c.claimant? `<div>By: ${escapeHtml(c.claimant)}</div>`:''}
          ${c.claimDate? `<div>Date: ${escapeHtml(c.claimDate)}</div>`:''}
          ${c.url? `<div>Source: <a href="${c.url}" target="_blank" rel="noopener">${new URL(c.url).hostname}</a></div>`:''}
          ${c.rating? `<div>Rating: ${escapeHtml(c.rating)}</div>`:''}
        </div>
      `).join('');
  } else {
    html = `<div class="status">No direct matches in Google Fact Check Tools. Try official sources:
      <a href="https://news.google.com/search?q=${encodeURIComponent(title)}" target="_blank" rel="noopener">Google News</a>,
      <a href="https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(title)}" target="_blank" rel="noopener">Wikipedia</a>.
    </div>`;
  }
  reveal.innerHTML = html + `<div style="margin-top:8px"><button class="btn" onclick="this.closest('.reveal').classList.remove('open')">Close</button></div>`;
}

function renderSummary(reveal, data){
  let text = '';
  if (typeof data === 'string') text = data.trim();
  else if (data && (data.summary || data.ai || data.text)) text = (data.summary || data.ai || data.text).trim();
  reveal.innerHTML = text
    ? `<div style="white-space:pre-wrap">${escapeHtml(text)}</div><div style="margin-top:8px"><button class="btn" onclick="this.closest('.reveal').classList.remove('open')">Close</button></div>`
    : `<div class="status">No summary available.</div>`;
}

function escapeHtml(s){return s.replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}

/*** DATA *********************************************************************/
async function load(pageToLoad=1, reset=false){
  const params = new URLSearchParams();
  if (category && category!=='all') params.set('category', category);
  if (query) params.set('q', query);
  params.set('page', pageToLoad);
  params.set('pageSize', PAGE_SIZE);

  const url = `${WORKER_BASE}/aggregate?${params.toString()}`;
  const data = await fetchJSONorText(url);

  let articles = [];
  if (typeof data === 'string'){
    try{ articles = JSON.parse(data).articles || []; }catch{ articles = []; }
  } else {
    articles = data.articles || [];
  }

  if (reset) list.innerHTML = '';
  if (!articles.length && reset){
    list.innerHTML = `<div class="status">No headlines found. Check your Worker logs.</div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  articles.forEach((a,i)=>frag.appendChild(el(cardTpl(a,i))));
  list.appendChild(frag);
  attachActions(list);
}

/*** EVENTS *******************************************************************/
document.getElementById('cats').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  category = chip.dataset.cat || 'all';
  page = 1;
  load(page, true).catch(err => {
    console.error(err);
    list.innerHTML = `<div class="status" style="color:var(--err)">Couldn‚Äôt load headlines. Check your Worker URL and logs.</div>`;
  });
});

document.getElementById('refreshBtn').addEventListener('click', ()=>{
  query = document.getElementById('q').value.trim();
  page = 1;
  load(page, true).catch(err => {
    console.error(err);
    list.innerHTML = `<div class="status" style="color:var(--err)">Couldn‚Äôt load headlines. Check your Worker URL and logs.</div>`;
  });
});

document.getElementById('q').addEventListener('keydown', (e)=>{
  if (e.key==='Enter') document.getElementById('refreshBtn').click();
});

document.getElementById('loadMore').addEventListener('click', ()=>{
  page += 1;
  load(page, false).catch(err => {
    console.error(err);
    page -= 1;
  });
});

/*** KICKOFF ******************************************************************/
load(1, true).catch(err=>{
  console.error(err);
  list.innerHTML = `<div class="status" style="color:var(--err)">Couldn‚Äôt load headlines. Check your Worker URL and logs.</div>`;
});
</script>
</body>
</html>
