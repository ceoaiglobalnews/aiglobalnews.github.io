<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIGLOBALNEWS â€¢ UK Headlines</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --brand:#3b82f6; --brand-2:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --chip:#1f2937; --chip-active:#334155; --border:#1f2937;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --card:#ffffff; --text:#0b1020; --muted:#5b636f; --chip:#e9eef6; --chip-active:#dbe7ff; --border:#e5e7eb; }
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:960px;margin:0 auto;padding:16px 14px 80px}
    /* Header */
    .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-bottom:12px}
    .brand{font-weight:800;letter-spacing:.2px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--border);background:var(--chip);color:inherit;border-radius:999px;padding:8px 12px;cursor:pointer}
    .chip.active{background:var(--chip-active);border-color:transparent}
    .tools{display:flex;gap:8px;align-items:center}
    #search{min-width:190px;flex:1;border:1px solid var(--border);background:var(--card);color:inherit;border-radius:10px;padding:10px 12px}
    .btn{border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;background:var(--card);color:inherit}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent}
    .center{display:flex;justify-content:center;margin-top:16px}
    /* Note & errors */
    .note,.error,.toast{border:1px solid var(--border);background:var(--card);padding:10px 12px;border-radius:12px;margin:10px 0}
    .error{border-color:var(--danger)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:10}
    .muted{color:var(--muted)}
    .warn{color:var(--warn)}
    /* Cards */
    .list{display:grid;gap:12px}
    .card{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:14px}
    .meta{color:var(--muted);font-size:.86rem;margin-bottom:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .dot{opacity:.5}
    .title{margin:0 0 6px 0;font-size:1.05rem;line-height:1.35}
    .desc{margin:0 0 10px 0;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .result{margin-top:10px;border:1px dashed var(--border);border-radius:12px;padding:10px}
    .fc-line{display:flex;gap:8px;align-items:center;padding:4px 0;border-bottom:1px dashed var(--border)}
    .fc-line:last-child{border:none}
    .fc-src{color:var(--muted);font-size:.86rem}
    .link{border:none;background:none;color:var(--brand);padding:8px 0;cursor:pointer}
    /* Mobile tweaks */
    @media (max-width:640px){
      #search{min-width:0}
      .tools{grid-column:1/-1}
      .bar{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="bar">
      <div class="brand">ðŸ¤– AIGLOBALNEWS</div>
      <div class="tools">
        <input id="search" placeholder="Search headlinesâ€¦" />
        <button id="refresh" class="btn">Refresh</button>
      </div>
      <nav class="chips">
        <button class="chip active" data-section="all">All</button>
        <button class="chip" data-section="nhs">NHS</button>
        <button class="chip" data-section="workforce">Workforce</button>
        <button class="chip" data-section="digital">Digital</button>
        <button class="chip" data-section="economy">Economy</button>
        <button class="chip" data-section="politics">Politics</button>
      </nav>
    </header>

    <p class="note">
      UK headlines (cached &amp; de-duplicated). Use ðŸ”Ž <strong>Fact-check</strong> (Google Fact Check + worker fallback),
      âœ¨ <strong>AI Summary</strong> for quick context, and ðŸ”— <strong>Share</strong> for native share.
      Summaries are informational; always read the source.
    </p>

    <div id="errors" class="error" hidden></div>

    <main id="news" class="list"></main>
    <div class="center"><button id="loadMore" class="btn ghost">Load more</button></div>

    <div id="toast" class="toast" hidden></div>
  </div>

  <script>
  /** ========= AIGLOBALNEWS frontend (GitHub Pages) =========
   * UI calls your backend at workers.dev (no settings dialog).
   * Update WORKER_BASE if your workers.dev hostname differs.
   */
  const WORKER_BASE = "https://aiglobalnews-worker.bmbotelho.workers.dev"; // <-- your Worker

  let page = 1;
  let section = "all";
  let query = "";

  // ---------- tiny helpers ----------
  const escapeHTML = s => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  function fmtTime(iso){ try{const d=new Date(iso);return d.toLocaleString([], { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit"});}catch{return "";} }
  function toast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.hidden=false; setTimeout(()=>t.hidden=true,2000); }
  function showError(msg){ const e=document.getElementById("errors"); e.textContent=msg; e.hidden=false; setTimeout(()=>e.hidden=true,5000); }

  async function apiGET(path, params = {}) {
    const url = new URL(WORKER_BASE + path);
    Object.entries(params).forEach(([k,v]) => v!=null && url.searchParams.set(k,v));
    const r = await fetch(url, { headers:{Accept:"application/json"} });
    if (!r.ok) throw new Error(`${path} ${r.status}`);
    return r.json();
  }
  async function apiPOST(path, body) {
    const r = await fetch(WORKER_BASE + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    let data; try{ data = await r.json(); } catch{ data = { ok:false, error:String(r.status) }; }
    return { ok:r.ok, status:r.status, data };
  }

  // ---------- load + render ----------
  async function loadHeadlines(reset=false){
    try{
      if (reset){ page=1; document.getElementById("news").innerHTML=""; }
      const res = await apiGET("/aggregate", { page, section, q: query });
      if (!res?.ok) throw new Error("aggregate not ok");
      renderHeadlines(res.articles || []);
      page++;
    }catch(err){ showError(`Couldn't load headlines. ${err?.message || err}`); }
  }

  function renderHeadlines(items){
    const list = document.getElementById("news");
    if (!items.length && page===1){ list.innerHTML = `<div class="muted">No headlines found.</div>`; return; }
    for (const [i,a] of items.entries()){
      const id = `n_${Date.now()}_${i}_${Math.random().toString(36).slice(2,6)}`;
      const urlHTML = a.url
        ? `<a href="${a.url}" target="_blank" rel="noopener" class="headline">${escapeHTML(a.title||"Read more")}</a>`
        : `<span class="headline">${escapeHTML(a.title||"(no title)")}</span>`;
      const card = document.createElement("article");
      card.className="card";
      card.innerHTML = `
        <div class="meta"><span class="src">${escapeHTML(a.source||"")}</span><span class="dot">â€¢</span><span class="time">${fmtTime(a.publishedAt)}</span></div>
        <h3 class="title">${urlHTML}</h3>
        ${a.description ? `<p class="desc">${escapeHTML(a.description)}</p>` : ""}
        <div class="actions">
          <button class="btn ghost fact">ðŸ”Ž Fact-check</button>
          <button class="btn primary sum">âœ¨ AI Summary</button>
          <button class="btn ghost share">ðŸ”— Share</button>
        </div>
        <div class="result" id="${id}" hidden></div>
        <button class="link close" data-target="${id}" hidden>Close</button>
      `;
      list.appendChild(card);

      const item = { id, url:a.url, title:a.title, source:a.source };
      card.querySelector(".fact").addEventListener("click", ()=>{ openResult(id); doFactCheck(item); });
      card.querySelector(".sum").addEventListener("click",  ()=>{ openResult(id); doSummary(item);  });
      card.querySelector(".share").addEventListener("click",()=> shareItem(a));
      card.querySelector(".close").addEventListener("click", ()=> closeResult(id));
    }
  }

  function ensureResultBox(id){
    const el = document.getElementById(id);
    el.hidden=false;
    const closeBtn = el.nextElementSibling;
    if (closeBtn?.dataset?.target===id) closeBtn.hidden=false;
    return el;
  }
  function openResult(id){ ensureResultBox(id); }
  function closeResult(id){
    const el = document.getElementById(id); if (!el) return;
    el.innerHTML=""; el.hidden=true;
    const closeBtn = el.nextElementSibling;
    if (closeBtn?.dataset?.target===id) closeBtn.hidden=true;
  }

  async function doSummary(item){
    const box = ensureResultBox(item.id);
    box.innerHTML = `<div class="muted">Summarisingâ€¦</div>`;
    const { ok, status, data } = await apiPOST("/summary", { url:item.url, title:item.title, source:item.source });
    if (!ok){
      if (status===402 || data?.error?.includes("credits")){
        box.innerHTML = `<div class="warn">AI summary temporarily unavailable (free plan limit). Read the article via the link above.</div>`;
      } else {
        box.innerHTML = `<div class="warn">Summary failed. ${data?.error || status}</div>`;
      }
      return;
    }
    const txt = (data?.summary||"").trim();
    box.innerHTML = txt ? `<div class="summary">${escapeHTML(txt)}</div>` : `<div class="muted">No summary returned.</div>`;
  }

  async function doFactCheck(item){
    const box = ensureResultBox(item.id);
    box.innerHTML = `<div class="muted">Checking factsâ€¦</div>`;
    try{
      const res = await apiGET("/factcheck", { q:item.title });
      if (res?.ok && Array.isArray(res.matches) && res.matches.length){
        box.innerHTML = res.matches.slice(0,3).map(m=>`
          <div class="fc-line">
            <a href="${m.url}" target="_blank" rel="noopener">${escapeHTML(m.title||m.claim||m.url)}</a>
            <span class="fc-src">${escapeHTML(m.site||m.publisher||"")}</span>
          </div>`).join("");
      } else {
        box.innerHTML = `
          <div class="muted">No direct matches in Google Fact Check Tools.</div>
          <div class="fc-suggest">
            Try:
            <a target="_blank" rel="noopener" href="https://news.google.com/search?q=${encodeURIComponent(item.title)}">Google&nbsp;News</a> Â·
            <a target="_blank" rel="noopener" href="https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(item.title)}">Wikipedia</a>
          </div>`;
      }
    }catch(e){
      box.innerHTML = `<div class="warn">Fact-check failed. ${e?.message||e}</div>`;
    }
  }

  function shareItem(a){
    const shareData = { title:a.title||"AIGLOBALNEWS", text:a.title||"", url:a.url||location.href };
    if (navigator.share) navigator.share(shareData).catch(()=>{});
    else navigator.clipboard.writeText(shareData.url).then(()=>toast("Link copied"));
  }

  // ---------- wiring ----------
  document.getElementById("refresh").addEventListener("click", ()=> loadHeadlines(true));
  document.getElementById("search").addEventListener("input", (e)=>{
    query = e.target.value.trim();
    clearTimeout(window.__qT); window.__qT = setTimeout(()=> loadHeadlines(true), 300);
  });
  document.querySelectorAll("[data-section]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll("[data-section]").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      section = btn.dataset.section;
      loadHeadlines(true);
    });
  });
  document.getElementById("loadMore").addEventListener("click", ()=> loadHeadlines(false));
  window.addEventListener("DOMContentLoaded", ()=> loadHeadlines(true));
  </script>
</body>
</html>
