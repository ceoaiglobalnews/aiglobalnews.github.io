<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AIGLOBALNEWS</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: #0b1220;
    --card: #11192b;
    --muted:#8892a6;
    --text: #eaf0ff;
    --accent:#4da3ff;        /* brand accent */
    --accent-2:#7cc4ff;
    --success:#2ecc71;
    --warn:#ffce54;
    --danger:#ff6b6b;
    --ring: rgba(77,163,255,.45);
    --shadow: 0 6px 24px rgba(0,0,0,.28), 0 2px 6px rgba(0,0,0,.18);
    --radius:14px;
  }
  :root.light{
    --bg:#f6f8fc;
    --card:#ffffff;
    --text:#0b1220;
    --muted:#55607a;
    --shadow: 0 8px 28px rgba(16,24,40,.08), 0 2px 8px rgba(16,24,40,.06);
    --ring: rgba(25,119,243,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg);
    color:var(--text);
  }
  .wrapper{max-width:980px;margin-inline:auto;padding:18px}
  header{
    display:flex;align-items:center;gap:12px;justify-content:space-between;margin:6px 0 12px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .badge{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;font-weight:700}
  .title{font-weight:800;letter-spacing:.4px}
  .controls{display:flex;gap:8px;align-items:center}
  .iconbtn{
    width:40px;height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
    background:var(--card);color:var(--text);display:grid;place-items:center;cursor:pointer;
    box-shadow: var(--shadow);
  }
  .pillrow{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
  .pill{
    padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:var(--card);
    color:var(--text);cursor:pointer;font-size:14px
  }
  .pill.active{outline:2px solid var(--ring);border-color:transparent}
  .searchbar{display:flex;gap:8px;margin:6px 0 12px}
  .searchbar input{
    flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
    background:var(--card);color:var(--text);outline:none;box-shadow:var(--shadow)
  }
  .searchbar button{padding:12px 14px;border-radius:12px;border:none;background:var(--accent);color:#031225;font-weight:700;cursor:pointer}
  .notice{
    font-size:13px;color:var(--muted);border:1px dashed rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;background:color-mix(in oklab,var(--card) 85%, transparent)
  }

  /* Cards */
  .card{
    background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:14px 14px;margin:14px 0
  }
  .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px;margin-bottom:6px}
  .titlelink{
    color:var(--text);text-decoration:none;font-weight:800;line-height:1.25;font-size:20px
  }
  .snippet{color:var(--muted);margin:8px 0 10px;font-size:15px;line-height:1.45}
  .toolbar{
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px
  }
  @media (min-width:520px){
    .toolbar{grid-template-columns:repeat(4,1fr)}
  }
  .btn{
    display:flex;align-items:center;justify-content:center;gap:8px;
    padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);
    background:color-mix(in oklab,var(--card) 80%, #0a0a0a 20%);color:var(--text);cursor:pointer;
    font-weight:700;box-shadow: var(--shadow);
  }
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#051634;border-color:transparent}
  .btn:hover{filter:brightness(1.04)}
  .btn:active{transform:translateY(1px)}
  .result{
    border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;margin-top:10px;background:color-mix(in oklab,var(--card) 88%, transparent)
  }
  .result header{display:flex;justify-content:space-between;align-items:center;margin:0 0 8px}
  .result h4{margin:0;font-size:15px}
  .chip{font-size:12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);padding:4px 8px;color:var(--muted)}
  .close{
    margin-left:auto;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:700
  }
  .small{font-size:12px;color:var(--muted)}
  .spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(255,255,255,.15);border-top-color:var(--accent);border-radius:50%;animation:spin .9s linear infinite;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .center{display:flex;justify-content:center;align-items:center;padding:14px}
  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="brand">
        <div class="badge">AI</div>
        <div class="title">AIGLOBALNEWS</div>
      </div>
      <div class="controls">
        <button class="iconbtn" id="themeToggle" title="Toggle theme">ðŸŒ“</button>
      </div>
    </header>

    <div class="pillrow" id="sections">
      <button class="pill active" data-sec="all">All</button>
      <button class="pill" data-sec="nhs">NHS</button>
      <button class="pill" data-sec="workforce">Workforce</button>
      <button class="pill" data-sec="digital">Digital</button>
      <button class="pill" data-sec="economy">Economy</button>
      <button class="pill" data-sec="politics">Politics</button>
    </div>

    <div class="searchbar">
      <input id="q" placeholder="Search headlinesâ€¦" />
      <button id="refresh">Refresh</button>
    </div>

    <p class="notice">
      UK headlines (cached &amp; de-duplicated). Use ðŸ”Ž <strong>Fact-check</strong> (Google Fact Check + Worker fallback),
      âœ¨ <strong>AI Summary</strong> for quick context, and ðŸ”— <strong>Copy link</strong> for sharing. Summaries are informational; always read the source.
    </p>

    <div id="news"></div>
    <div class="center"><button id="loadMore" class="btn">Load more</button></div>
  </div>

<script>
(() => {
  // ----------- Theme
  const themeToggle = document.getElementById('themeToggle');
  const applyTheme = (t) => {
    document.documentElement.classList.toggle('light', t === 'light');
    localStorage.setItem('theme', t);
  };
  applyTheme(localStorage.getItem('theme') || 'dark');
  themeToggle.addEventListener('click', () => {
    applyTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light');
  });

  // ----------- State
  let page = 1;
  let section = 'all';
  let query = '';
  const newsEL = document.getElementById('news');

  // Helper: html escape
  const esc = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  // Helper: time
  const fmtTime = (iso) => {
    try {
      const d = new Date(iso);
      return d.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});
    } catch { return ''; }
  };

  // Small fetch helper with graceful errors
  async function api(path, params) {
    const url = new URL(path, location.origin);
    if (params) Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
    const r = await fetch(url, { headers: { 'Accept':'application/json' }});
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  // Build one card
  function renderCard(a, idx) {
    const id = `res-${idx}`;
    return `
      <article class="card" data-url="${esc(a.url)}">
        <div class="meta">
          <span>${esc(a.source || '')}</span>
          <span>â€¢</span>
          <span>${esc(fmtTime(a.publishedAt || ''))}</span>
        </div>
        <a class="titlelink" href="${esc(a.url)}" target="_blank" rel="noopener">${esc(a.title)}</a>
        ${a.description ? `<p class="snippet">${esc(a.description)}</p>` : ''}
        <div class="toolbar">
          <button class="btn" data-action="fact">${'ðŸ”Ž'}<span>Fact-check</span></button>
          <button class="btn primary" data-action="ai">${'âœ¨'}<span>AI Summary</span></button>
          <button class="btn" data-action="copy">${'ðŸ”—'}<span>Copy link</span></button>
          <button class="btn" data-action="share">${'ðŸ“¤'}<span>Share</span></button>
        </div>
        <div id="${id}" class="result hidden"></div>
      </article>
    `;
  }

  // Populate news
  async function load({reset=false}={}) {
    if (reset) { page = 1; newsEL.innerHTML=''; }
    // show skeleton loader
    const skel = document.createElement('div');
    skel.className = 'card';
    skel.innerHTML = `<div class="center"><span class="spinner"></span> Loadingâ€¦</div>`;
    newsEL.appendChild(skel);

    try{
      const data = await api('/aggregate', { page, section, q: query });
      skel.remove();
      const items = (data && data.articles) ? data.articles : [];
      if (!items.length && page === 1) {
        newsEL.innerHTML = `<div class="card"><div class="center small">No headlines found.</div></div>`;
        return;
      }
      items.forEach((a,i) => {
        newsEL.insertAdjacentHTML('beforeend', renderCard(a, `${page}-${i}`));
      });
      page++;
    }catch(err){
      skel.remove();
      newsEL.insertAdjacentHTML('beforeend',
        `<div class="card"><div class="center small" style="color:var(--danger)">Couldnâ€™t load headlines. Check logs.</div></div>`);
      console.error(err);
    }
  }

  // Collapsible result block handler
  function openResult(block, title, html){
    block.classList.remove('hidden');
    block.innerHTML = `
      <header>
        <h4>${esc(title)}</h4>
        <button class="close" data-action="close">Close âœ•</button>
      </header>
      <div class="content">${html}</div>
    `;
  }

  // Render fact-check response
  function renderFact(res){
    // Expected shapes handled: {ok, matches:[], related:[] } OR our earlier fallback {ok:true, note:'â€¦'}
    if (!res || res.ok === false) {
      return `<div class="small" style="color:var(--danger)">Fact-check unavailable for this item.</div>`;
    }
    if (res.note && !res.matches?.length) {
      return `<div class="small">${esc(res.note)}</div>`;
    }
    const m = res.matches?.slice(0,6).map(r => `
      <li>
        <strong>${esc(r.claim || r.title || 'Claim')}</strong>
        <div class="small">Rating: <b>${esc(r.textualRating || r.rating || 'â€”')}</b></div>
        ${r.url ? `<div class="small"><a href="${esc(r.url)}" target="_blank" rel="noopener">Source</a></div>`:''}
      </li>`).join('') || '<li class="small">No direct matches in Google Fact Check Tools. Try official sources.</li>';

    const rel = res.related?.slice(0,4).map(r => `
      <li><a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title || r.url)}</a></li>`).join('') || '';

    return `
      <div>
        <ul>${m}</ul>
        ${rel ? `<hr style="border:none;border-top:1px solid rgba(255,255,255,.12);margin:10px 0" />
                 <div class="small">Related:</div><ul>${rel}</ul>`:''}
      </div>
    `;
  }

  // Render AI summary response
  function renderAI(res){
    if (!res || res.ok === false) {
      return `<div class="small" style="color:var(--danger)">Couldnâ€™t generate a summary right now.</div>`;
    }
    const txt = res.summary || res.ai || res.text || '';
    return txt
      ? `<div style="white-space:pre-wrap;line-height:1.45">${esc(txt)}</div>`
      : `<div class="small">No summary was returned.</div>`;
  }

  // Event delegation for toolbar
  newsEL.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn, .close');
    if (!btn) return;

    // close panel
    if (btn.dataset.action === 'close') {
      const result = btn.closest('.result');
      if (result) result.classList.add('hidden');
      return;
    }

    const card = e.target.closest('.card');
    const url = card?.dataset.url;
    const result = card.querySelector('.result');

    // helper to set loading
    const setLoading = (label) => {
      openResult(result, label, `<div class="small"><span class="spinner"></span> Workingâ€¦</div>`);
    };

    try{
      if (btn.dataset.action === 'copy') {
        await navigator.clipboard.writeText(url);
        btn.innerHTML = 'âœ… <span>Copied</span>';
        setTimeout(()=> btn.innerHTML='ðŸ”— <span>Copy link</span>', 1200);
        return;
      }

      if (btn.dataset.action === 'share') {
        const shareData = { title: card.querySelector('.titlelink')?.textContent?.trim() || 'Headline', url };
        if (navigator.share) {
          try { await navigator.share(shareData); } catch {}
        } else {
          await navigator.clipboard.writeText(url);
          btn.innerHTML = 'âœ… <span>Copied</span>';
          setTimeout(()=> btn.innerHTML='ðŸ“¤ <span>Share</span>', 1200);
        }
        return;
      }

      if (btn.dataset.action === 'fact') {
        // toggle behaviour: close if already visible
        if (!result.classList.contains('hidden')) { result.classList.add('hidden'); return; }
        setLoading('Fact-check');
        // We try google-tools first (Worker does that), fallback path is inside Worker
        const res = await api('/factcheck', { q: url });
        openResult(result, 'Fact-check', renderFact(res));
        return;
      }

      if (btn.dataset.action === 'ai') {
        if (!result.classList.contains('hidden')) { result.classList.add('hidden'); return; }
        setLoading('AI Summary');
        // Try /summary?url= first; if Worker only exposes /ai?q= then we fallback
        let res;
        try {
          res = await api('/summary', { url });
        } catch {
          res = await api('/ai', { q: url }).catch(()=>({ok:false}));
        }
        openResult(result, 'AI Summary', renderAI(res));
        return;
      }
    }catch(err){
      console.error(err);
      openResult(result,'Error', `<div class="small" style="color:var(--danger)">Something went wrong.</div>`);
    }
  });

  // Filters, search, refresh
  document.getElementById('refresh').addEventListener('click', () => {
    query = document.getElementById('q').value.trim();
    load({reset:true});
  });
  document.getElementById('q').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') document.getElementById('refresh').click();
  });

  document.getElementById('sections').addEventListener('click', (e)=>{
    const b = e.target.closest('.pill'); if (!b) return;
    document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
    b.classList.add('active');
    section = b.dataset.sec || 'all';
    load({reset:true});
  });

  document.getElementById('loadMore').addEventListener('click', ()=> load());

  // Initial load
  load({reset:true});
})();
</script>
</body>
</html>
