<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>AIGLOBALNEWS ‚Ä¢ UK headlines</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#0b1020;
      --card:#111831;
      --text:#e7ecff;
      --muted:#9fb0ffcc;
      --brand:#4f7cff;
      --brand-2:#22c55e;
      --danger:#ef4444;
      --chip:#1a2346;
      --border:#26335f;
    }
    :root.light{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1020;
      --muted:#334155cc;
      --brand:#335dff;
      --brand-2:#16a34a;
      --danger:#b91c1c;
      --chip:#eef2ff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
    }
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:980px;margin-inline:auto;padding:18px}
    header{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom:8px;
    }
    .logo{
      display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px;
    }
    .ai-badge{
      width:36px;height:36px;border-radius:10px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,#4f7cff, #22c55e);
      color:white;font-weight:900;
    }
    .toggle{
      margin-left:auto;display:flex;align-items:center;gap:8px;
      user-select:none;
    }
    .switch{position:relative;width:52px;height:28px;background:var(--chip);border-radius:999px;cursor:pointer;border:1px solid var(--border)}
    .knob{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:#fff;transition:transform 200ms ease}
    :root.light .knob{transform:translateX(24px)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .chip{
      padding:8px 12px;border-radius:999px;background:var(--chip);
      border:1px solid var(--border);cursor:pointer
    }
    .chip.active{outline:2px solid var(--brand)}
    .row{display:flex;gap:8px;align-items:center}
    .search{
      flex:1;min-width:180px;display:flex;align-items:center;
      gap:8px
    }
    input[type="search"]{
      flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:var(--card);color:var(--text)
    }
    button{
      border:1px solid var(--border);border-radius:10px;padding:10px 12px;
      background:var(--card);color:var(--text);cursor:pointer
    }
    button.primary{background:var(--brand);border-color:transparent;color:#fff}
    button.ghost{background:transparent}
    .hint{
      font-size:13px;color:var(--muted);margin:10px 0 14px
    }
    .cards{display:grid;gap:14px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:16px;
      padding:14px 14px 10px
    }
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .title{
      font-weight:800;margin:0 0 6px;font-size:18px;line-height:1.25;
      word-wrap:break-word
    }
    .desc{margin:0 0 10px;color:var(--muted)}
    .actions{
      display:flex;gap:8px;flex-wrap:wrap
    }
    .actions button{flex:1}
    .result{
      margin-top:10px;border-top:1px dashed var(--border);padding-top:10px;
      font-size:15px;white-space:pre-wrap
    }
    .err{color:var(--danger);font-weight:700}
    .center{display:grid;place-items:center;margin:24px 0}
    .badge{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:var(--chip)}
    @media (max-width:560px){
      .actions button{flex:1 1 calc(50% - 4px)}
      .title{font-size:17px}
      header{gap:12px}
      .toggle{order:3;margin-left:0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="ai-badge">AI</div>
        <div>AIGLOBALNEWS</div>
      </div>

      <div class="toggle" id="themeToggle" title="Toggle light/dark">
        <span>üåô/‚òÄÔ∏è</span>
        <div class="switch"><div class="knob"></div></div>
      </div>
    </header>

    <div class="chips" id="sections">
      <div class="chip active" data-section="all">All</div>
      <div class="chip" data-section="nhs">NHS</div>
      <div class="chip" data-section="workforce">Workforce</div>
      <div class="chip" data-section="digital">Digital</div>
      <div class="chip" data-section="economy">Economy</div>
      <div class="chip" data-section="politics">Politics</div>
    </div>

    <div class="row">
      <div class="search">
        <input id="q" type="search" placeholder="Search headlines‚Ä¶" />
      </div>
      <button id="refresh">Refresh</button>
    </div>

    <div class="hint">
      Use üîé <strong>Fact-check</strong> (Google Fact Check + Worker fallback), ‚ú® <strong>AI Summary</strong> for quick context, and üîó <strong>Share</strong> for native share. Summaries are informational; always read the source.
    </div>

    <div id="cards" class="cards"></div>

    <div class="center">
      <button id="loadMore" class="badge">Load more</button>
    </div>
  </div>

  <script>
    // ---------- Theme (persisted)
    const applyTheme = (mode) => {
      document.documentElement.classList.toggle('light', mode === 'light');
      localStorage.setItem('theme', mode);
    };
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);
    document.getElementById('themeToggle').addEventListener('click', () => {
      const next = document.documentElement.classList.contains('light') ? 'dark' : 'light';
      applyTheme(next);
    });

    // ---------- API base (same-origin worker)
    const API_BASE = ''; // same-origin: /aggregate, /summary, /factcheck

    // helper: JSON POST
    async function postJSON(path, payload) {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload || {})
      });
      if (!res.ok) {
        const t = await res.text().catch(() => '');
        throw new Error(`${res.status} ${res.statusText}${t ? ' ‚Äì ' + t : ''}`);
      }
      return res.json();
    }

    // state
    let section = 'all';
    let page = 1;
    let q = '';

    // UI refs
    const cards = document.getElementById('cards');
    const btnMore = document.getElementById('loadMore');
    const inputQ = document.getElementById('q');

    // section chips
    document.getElementById('sections').addEventListener('click', (e) => {
      const el = e.target.closest('.chip');
      if (!el) return;
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      el.classList.add('active');
      section = el.dataset.section;
      page = 1;
      cards.innerHTML = '';
      load();
    });

    // refresh
    document.getElementById('refresh').addEventListener('click', () => {
      page = 1;
      cards.innerHTML = '';
      load();
    });

    // search (debounced)
    let tSearch;
    inputQ.addEventListener('input', () => {
      clearTimeout(tSearch);
      tSearch = setTimeout(() => {
        q = inputQ.value.trim();
        page = 1;
        cards.innerHTML = '';
        load();
      }, 350);
    });

    // more
    btnMore.addEventListener('click', () => {
      page += 1;
      load();
    });

    // headline fetch (POST)
    async function fetchHeadlines() {
      return postJSON('/aggregate', { section, page, q });
    }

    // helpers
    const clean = (s='') =>
      String(s)
        .replace(/<!\[CDATA\[(.*?)\]\]>/g, '$1')
        .replace(/<[^>]+>/g, '')
        .replace(/\s+/g, ' ')
        .trim();

    function cardHTML(item) {
      const src = clean(item.source || '');
      const title = clean(item.title || 'Untitled');
      const desc = clean(item.description || '');
      const url = item.url || '#';
      const time = item.publishedAt ? new Date(item.publishedAt).toLocaleString() : '';

      return `
        <article class="card" data-url="${encodeURIComponent(url)}">
          <div class="meta">${src}${time ? ' ‚Ä¢ ' + time : ''}</div>
          <h3 class="title"><a href="${url}" target="_blank" rel="noopener">${title}</a></h3>
          ${desc ? `<p class="desc">${desc}</p>` : ''}
          <div class="actions">
            <button class="fact">Fact-check</button>
            <button class="summary primary">‚ú® AI Summary</button>
            <button class="share">Share</button>
          </div>
          <div class="result" hidden></div>
        </article>
      `;
    }

    async function load() {
      try {
        const data = await fetchHeadlines();
        const items = (data && data.articles) || [];
        if (page === 1 && items.length === 0) {
          cards.innerHTML = `<div class="card"><div class="err">Couldn't load headlines.</div><div class="hint">${clean(data && data.error || '')}</div></div>`;
          return;
        }
        const frag = document.createElement('div');
        items.forEach(i => frag.insertAdjacentHTML('beforeend', cardHTML(i)));
        cards.appendChild(frag);
      } catch (err) {
        if (page === 1) {
          cards.innerHTML = `<div class="card"><div class="err">Couldn't load headlines.</div><div class="hint">${clean(err.message)}</div></div>`;
        }
      }
    }

    // actions: summary / fact-check / share
    cards.addEventListener('click', async (e) => {
      const card = e.target.closest('.card');
      if (!card) return;
      const url = decodeURIComponent(card.dataset.url || '');
      const result = card.querySelector('.result');

      if (e.target.classList.contains('summary')) {
        result.hidden = false;
        result.innerHTML = 'Summarising‚Ä¶';
        try {
          const r = await postJSON('/summary', { url });
          result.textContent = clean(r.summary || r.result || JSON.stringify(r));
        } catch (err) {
          result.innerHTML = `<span class="err">AI summary failed:</span> ${clean(err.message)}`;
        }
      }

      if (e.target.classList.contains('fact')) {
        result.hidden = false;
        result.innerHTML = 'Checking facts‚Ä¶';
        try {
          const r = await postJSON('/factcheck', { url });
          const out = r.matches && r.matches.length
            ? r.matches.map(m => `‚Ä¢ ${clean(m.title)} ‚Äî ${clean(m.claimant || m.source || '')}`).join('\n')
            : (r.message || 'No direct matches in Google Fact Check Tools. Try official sources.');
          result.textContent = clean(out);
        } catch (err) {
          result.innerHTML = `<span class="err">Fact-check failed:</span> ${clean(err.message)}`;
        }
      }

      if (e.target.classList.contains('share')) {
        try {
          const a = card.querySelector('a');
          const title = a ? a.textContent.trim() : 'AIGLOBALNEWS';
          if (navigator.share) {
            await navigator.share({ title, url });
          } else {
            await navigator.clipboard.writeText(url);
            e.target.textContent = 'Copied!';
            setTimeout(()=> e.target.textContent='Share', 900);
          }
        } catch {}
      }
    });

    // initial load
    load();
  </script>
</body>
</html>
