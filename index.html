<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIGLOBALNEWS</title>
  <meta name="theme-color" content="#0b1324" />
  <style>
    :root{
      --bg:#0b1324;       /* page */
      --card:#111a32;     /* cards */
      --muted:#9fb3c8;    /* meta text */
      --text:#e7eef7;     /* main text */
      --accent:#4da3ff;   /* brand accent */
      --accent-2:#3dd1a4; /* success accent */
      --chip:#172140;
      --btn:#162345;
      --btn-alt:#1a274f;
      --border:#22325f;
      --warn:#ffc857;
      --error:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:linear-gradient(180deg,#0b1324 0%, #0a1120 100%);
    }

    /* header */
    .wrap{max-width:900px;margin:auto;padding:0 16px}
    header{
      position:sticky;top:0;z-index:20;
      backdrop-filter:saturate(120%) blur(8px);
      background:color-mix(in hsl, var(--bg) 88%, transparent);
      border-bottom:1px solid var(--border);
    }
    .brand{
      display:flex;align-items:center;gap:10px;padding:12px 0;
    }
    .logo{
      width:28px;height:28px;display:grid;place-items:center;
      border-radius:8px;background:var(--accent);color:#00132a;
      font-weight:800;
    }
    .brand h1{font-size:18px;margin:0;letter-spacing:.5px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}
    .chip{
      background:var(--chip);color:var(--text);
      border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;cursor:pointer;
      user-select:none;transition:all .15s ease;
      font-weight:600
    }
    .chip:hover{border-color:var(--accent)}
    .chip.active{background:var(--accent); color:#00132a; border-color:var(--accent)}
    .searchRow{display:flex;gap:8px;align-items:center}
    .search{
      flex:1; background:var(--card); border:1px solid var(--border);
      color:var(--text); padding:10px 12px;border-radius:10px;outline:none;
    }
    .btn{
      background:var(--btn);border:1px solid var(--border);color:var(--text);
      padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:700
    }
    .btn:hover{border-color:var(--accent)}

    /* info bar */
    .info{
      font-size:13px;color:var(--muted);padding:10px 12px;border:1px dashed var(--border);
      border-radius:10px;background:var(--card);margin:12px 0
    }

    /* list */
    .list{display:grid;gap:14px;margin:18px 0 80px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;
      box-shadow:0 10px 22px rgba(0,0,0,.18)
    }
    .meta{display:flex;gap:10px;color:var(--muted);font-size:13px;align-items:center;margin-bottom:6px}
    .source{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border)}
    .title{font-size:18px;font-weight:800;margin:6px 0 4px;line-height:1.35}
    .desc{color:var(--muted);margin:0 0 10px}
    .actions{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center
    }
    .action{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;
      background:var(--btn);border:1px solid var(--border);color:var(--text);
      min-width:0;
    }
    .action.primary{background:var(--accent);border-color:var(--accent);color:#00132a}
    .action:disabled{opacity:.55;cursor:not-allowed}
    .action .icon{font-style:normal}

    .inline{
      margin-top:10px;border:1px solid var(--border);background:#0d1630;border-radius:10px;padding:10px;color:var(--text)
    }
    .muted{color:var(--muted)}
    .loadMore{display:block;margin:18px auto 0}

    /* small screens tweaks */
    @media (max-width:520px){
      .title{font-size:17px}
      .action{padding:8px 9px}
    }

    /* toast */
    .toast{
      position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
      background:#102040;border:1px solid var(--border);color:var(--text);
      padding:10px 14px;border-radius:10px;z-index:50;display:none;box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .toast.show{display:block}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">AI</div>
        <h1>AIGLOBALNEWS</h1>
      </div>

      <!-- Sections -->
      <div class="controls" id="sections">
        <button class="chip active" data-tag="all">All</button>
        <button class="chip" data-tag="nhs">NHS</button>
        <button class="chip" data-tag="workforce">Workforce</button>
        <button class="chip" data-tag="digital">Digital</button>
        <button class="chip" data-tag="economy">Economy</button>
        <button class="chip" data-tag="politics">Politics</button>
      </div>

      <div class="searchRow">
        <input id="q" class="search" type="search" placeholder="Search headlinesâ€¦" />
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>

      <div class="info">
        UK headlines (cached &amp; de-duplicated). Use ðŸ”Ž <b>Fact-check</b> (Google Fact Check + Worker fallback), âœ¨ <b>AI Summary</b> (inline), and ðŸ”— <b>Copy</b> for links. Summaries are informational; always read the source.
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="list" class="list" role="feed" aria-live="polite"></div>
    <button class="btn loadMore" id="loadMoreBtn">Load more</button>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Copied!</div>

  <script>
    // ========= CONFIG =========
    const WORKER_BASE = 'https://aiglobalnews-worker.bmbotelho.workers.dev'; // <â€” your backend
    // Endpoints expected:
    //  GET /aggregate?tag=all&page=1&q= (returns {ok:true, articles:[{title,description,url,source,publishedAt}]})
    //  GET /factcheck?q={query or url} (returns {ok:true, matches:[...]} OR {ok:true, note:"..."} )
    //  GET /ai?q={title or url} (returns {ok:true, text:"..."} )

    // ========= STATE =========
    let tag = 'all';
    let page = 1;
    let loading = false;

    const els = {
      list: document.getElementById('list'),
      loadMore: document.getElementById('loadMoreBtn'),
      q: document.getElementById('q'),
      sections: document.getElementById('sections'),
      refresh: document.getElementById('refreshBtn'),
      toast: document.getElementById('toast'),
    };

    // ========= HELPERS =========
    const fmtTime = (iso) => {
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined,{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      }catch{ return '' }
    };

    const showToast = (msg='Done')=>{
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(()=>els.toast.classList.remove('show'), 1400);
    };

    const fetchJSON = async (url) => {
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    };

    const qs = (sel, root=document)=>root.querySelector(sel);

    // ========= RENDER =========
    const renderCard = (a) => {
      const card = document.createElement('article');
      card.className = 'card';

      const safeTitle = a.title?.replace(/^<!\[CDATA\[(.*)\]\]>$/,'$1') ?? '';
      const safeDesc = a.description ?? '';

      card.innerHTML = `
        <div class="meta">
          <span class="source">${a.source || 'source'}</span>
          <span class="muted">â€¢</span>
          <span class="muted">${fmtTime(a.publishedAt)}</span>
        </div>
        <h2 class="title"><a href="${a.url}" target="_blank" rel="noopener noreferrer">${safeTitle}</a></h2>
        ${safeDesc ? `<p class="desc">${safeDesc}</p>` : ''}

        <div class="actions">
          <button class="action" data-act="fact" title="Fact-check"><i class="icon">ðŸ”Ž</i><span>Fact-check</span></button>
          <button class="action primary" data-act="ai" title="AI Summary"><i class="icon">âœ¨</i><span>AI Summary</span></button>
          <button class="action" data-act="copy" title="Copy link"><i class="icon">ðŸ”—</i><span>Copy</span></button>
          <button class="action" data-act="share" title="Share"><i class="icon">ðŸ“¤</i><span>Share</span></button>
        </div>
        <div class="inline" hidden></div>
      `;

      // Wire actions
      const inline = qs('.inline', card);

      card.addEventListener('click', async (e)=>{
        const btn = e.target.closest('.action');
        if(!btn) return;

        const act = btn.dataset.act;

        // Disable while processing
        const lock = ()=>btn.setAttribute('disabled','');
        const free = ()=>btn.removeAttribute('disabled');

        try{
          if(act === 'copy'){
            await navigator.clipboard.writeText(a.url);
            showToast('Link copied');
          }
          else if(act === 'share'){
            if(navigator.share){
              await navigator.share({title: safeTitle, url: a.url, text: 'AI Global News'});
            }else{
              await navigator.clipboard.writeText(a.url);
              showToast('Link copied (no native share)');
            }
          }
          else if(act === 'ai'){
            lock();
            inline.hidden = false;
            inline.innerHTML = `<span class="muted">Generating summaryâ€¦</span>`;
            const j = await fetchJSON(`${WORKER_BASE}/ai?q=${encodeURIComponent(a.title || a.url)}`);
            if(j?.ok && j.text){
              inline.innerHTML = `<strong>AI summary</strong><br>${j.text}`;
            }else{
              inline.innerHTML = `<span class="muted">No summary available.</span>`;
            }
          }
          else if(act === 'fact'){
            lock();
            inline.hidden = false;
            inline.innerHTML = `<span class="muted">Checking factsâ€¦</span>`;
            const searchQ = a.title ? `${a.title}` : a.url;
            const j = await fetchJSON(`${WORKER_BASE}/factcheck?q=${encodeURIComponent(searchQ)}`);
            if(j?.ok){
              if(Array.isArray(j.matches) && j.matches.length){
                const items = j.matches.slice(0,5).map(m=>`
                  <li>
                    <a href="${m.url}" target="_blank" rel="noopener">${m.title || m.claim || 'Source'}</a>
                    ${m.rating ? ` â€” <em>${m.rating}</em>`:''}
                    ${m.publisher ? ` <span class="muted">(${m.publisher})</span>`:''}
                  </li>`).join('');
                inline.innerHTML = `<strong>Fact-check sources</strong><ul>${items}</ul>`;
              }else if(j.note){
                inline.innerHTML = `<span class="muted">${j.note}</span>`;
              }else{
                inline.innerHTML = `<span class="muted">No direct matches found.</span>`;
              }
            }else{
              inline.innerHTML = `<span class="muted">Fact-check unavailable.</span>`;
            }
          }
        }catch(err){
          console.error(err);
          showToast('Something went wrong');
        }finally{
          free();
        }
      });

      return card;
    };

    // ========= LOAD =========
    const buildQuery = () => {
      const params = new URLSearchParams();
      params.set('tag', tag);
      params.set('page', String(page));
      const q = els.q.value.trim();
      if(q) params.set('q', q);
      return params.toString();
    };

    const load = async (reset=false) => {
      if(loading) return;
      loading = true;

      try{
        if(reset){
          page = 1;
          els.list.innerHTML = '';
        }

        const url = `${WORKER_BASE}/aggregate?${buildQuery()}`;
        const data = await fetchJSON(url);
        const articles = data?.articles || [];

        if(reset && articles.length === 0){
          els.list.innerHTML = `<div class="card"><div class="muted">No headlines found.</div></div>`;
          els.loadMore.style.display = 'none';
          return;
        }

        for(const a of articles){
          els.list.appendChild(renderCard(a));
        }

        // Show/Hide load more
        els.loadMore.style.display = articles.length >= 10 ? 'block' : 'none';
        page++;
      }catch(err){
        console.error(err);
        els.list.innerHTML = `<div class="card"><div class="muted">Couldnâ€™t load headlines. Check your Worker.</div></div>`;
        els.loadMore.style.display = 'none';
      }finally{
        loading = false;
      }
    };

    // ========= EVENTS =========
    els.sections.addEventListener('click', (e)=>{
      const b = e.target.closest('.chip'); if(!b) return;
      els.sections.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      b.classList.add('active');
      tag = b.dataset.tag || 'all';
      load(true);
    });

    els.refresh.addEventListener('click', ()=>load(true));

    els.q.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ load(true); }
    });

    els.loadMore.addEventListener('click', ()=>load(false));

    // ========= FIRST LOAD =========
    load(true);
  </script>
</body>
</html>
