<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AIGLOBALNEWS</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg: #0b1220;
      --card: #121a2b;
      --text: #e7edf8;
      --muted:#9fb0cf;
      --accent:#4da3ff;
      --accent-2:#7bc6ff;
      --border:#1e2a44;
      --ok:#23d18b;
      --warn:#ffd35a;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
      --pad:14px;
      --gap:12px;
      --btn:#18243d;
      --btn-text:#e7edf8;
    }
    :root.light{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0d1b2a;
      --muted:#546380;
      --accent:#0b6bcb;
      --accent-2:#389cff;
      --border:#dbe5f4;
      --btn:#eef4ff;
      --btn-text:#0d1b2a;
      --shadow:0 6px 20px rgba(15,29,61,.08);
    }
    @media (prefers-color-scheme: light){
      :root:not(.dark){ /* default to system light unless user picked */
        --bg:#f6f8fc; --card:#fff; --text:#0d1b2a; --muted:#546380; --accent:#0b6bcb; --accent-2:#389cff; --border:#dbe5f4; --btn:#eef4ff; --btn-text:#0d1b2a; --shadow:0 6px 20px rgba(15,29,61,.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1000px; margin:0 auto; padding:16px clamp(12px,4vw,20px) 80px}
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(1.2) blur(8px);
      background:color-mix(in srgb, var(--bg) 86%, transparent);
      border-bottom:1px solid var(--border);
    }
    .top{
      display:flex; align-items:center; gap:10px; padding:10px 0;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;
    }
    .badge{inline-size:30px; block-size:30px; display:grid; place-items:center; color:#fff; font-weight:800; border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      box-shadow:0 6px 14px rgba(53,147,255,.35);
    }
    .pillbar{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 10px}
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--muted);
      cursor:pointer; user-select:none; font-size:.9rem;
    }
    .pill.active{color:var(--text); border-color:color-mix(in srgb,var(--accent) 50%, var(--border)); box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--accent) 45%, transparent)}
    .row{display:flex; gap:10px}
    .search{
      flex:1; display:flex; gap:8px; align-items:center; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:8px 10px;
    }
    .search input{flex:1; border:0; outline:0; background:transparent; color:var(--text); font-size:15px}
    .btn{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--btn-text);
      cursor:pointer; font-weight:600;
    }
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; border:0}
    .btn.small{padding:8px 10px; font-size:.9rem}
    .btn.ghost{background:transparent}
    .toggle{
      margin-left:auto; display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:999px; border:1px solid var(--border); background:var(--card)
    }
    .switch{appearance:none; inline-size:42px; block-size:24px; border-radius:999px; background:var(--border); position:relative; outline:0; cursor:pointer; border:1px solid var(--border)}
    .switch:after{content:""; position:absolute; inset:2px auto 2px 2px; inline-size:20px; border-radius:50%; background:var(--btn); transition:transform .2s ease}
    .switch:checked{background:linear-gradient(135deg,var(--accent),var(--accent-2))}
    .switch:checked:after{transform:translateX(18px); background:#fff}
    .hint{font-size:.86rem; color:var(--muted)}
    main{margin-top:12px; display:grid; gap:14px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
      padding:var(--pad);
    }
    .meta{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:.85rem; margin-bottom:6px}
    .title{font-weight:800; font-size:1.05rem; margin:4px 0 8px}
    .desc{color:var(--muted); font-size:.95rem}
    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px}
    .action{
      flex:1 1 auto; display:flex; justify-content:center; align-items:center; gap:8px; min-inline-size:0;
      padding:10px; background:var(--btn); color:var(--btn-text); border:1px solid var(--border); border-radius:10px; font-weight:700; cursor:pointer;
    }
    .action.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; border:0}
    .result{margin-top:10px; padding:10px; border:1px solid var(--border); background:color-mix(in srgb,var(--card) 85%, transparent); border-radius:10px}
    .result .close{float:right; color:var(--muted); cursor:pointer}
    .center{display:grid; place-items:center; color:var(--muted)}
    .footer-space{height:60px}
    @media (max-width:560px){
      .wrap{padding-bottom:90px}
      .action{flex:1 0 calc(33.33% - 6px); font-size:.95rem; padding:10px 8px}
      .actions{gap:6px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="badge">AI</div>
          <div>AIGLOBALNEWS</div>
        </div>
        <div class="toggle" title="Day/Night">
          <span class="hint">Theme</span>
          <input id="themeSwitch" class="switch" type="checkbox" />
        </div>
      </div>
      <div class="pillbar" id="sections">
        <!-- pills injected -->
      </div>
      <div class="row">
        <div class="search">
          <input id="q" placeholder="Search headlinesâ€¦" autocomplete="off" />
        </div>
        <button id="refreshBtn" class="btn small">Refresh</button>
      </div>
      <div class="hint" style="margin-top:10px">
        UK headlines (cached &amp; de-duplicated). Use ðŸ”Ž <strong>Fact-check</strong> (Google Fact Check + Worker fallback),
        âœ¨ <strong>AI Summary</strong> for quick context, and ðŸ”— <strong>Share</strong> for native share. Summaries are informational; always read the source.
      </div>
    </div>
  </header>

  <div class="wrap">
    <main id="feed"></main>
    <div class="center" style="margin-top:12px">
      <button id="loadMore" class="btn">Load more</button>
    </div>
    <div class="footer-space"></div>
  </div>

  <script>
    // ---------- Config ----------
    const API_BASE = ""; // same-origin Worker bound to your domain
    const SECTIONS = [
      { key:"all", label:"All" },
      { key:"nhs", label:"NHS" },
      { key:"workforce", label:"Workforce" },
      { key:"digital", label:"Digital" },
      { key:"economy", label:"Economy" },
      { key:"politics", label:"Politics" },
    ];

    // ---------- Theme (day/night) ----------
    const root = document.documentElement;
    const switchEl = document.getElementById('themeSwitch');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') root.classList.add('light');
    if (savedTheme === 'dark') root.classList.add('dark');
    // reflect initial switch
    switchEl.checked = root.classList.contains('light');
    switchEl.addEventListener('change', ()=>{
      if (switchEl.checked){
        root.classList.remove('dark'); root.classList.add('light');
        localStorage.setItem('theme','light');
      } else {
        root.classList.remove('light'); root.classList.add('dark');
        localStorage.setItem('theme','dark');
      }
    });

    // ---------- State ----------
    let page = 1;
    let section = 'all';
    let query = '';
    let loading = false;

    const feed = document.getElementById('feed');
    const q = document.getElementById('q');
    const refreshBtn = document.getElementById('refreshBtn');
    const loadMoreBtn = document.getElementById('loadMore');

    // Build section pills
    const secWrap = document.getElementById('sections');
    SECTIONS.forEach(s=>{
      const b = document.createElement('button');
      b.className = 'pill' + (s.key===section?' active':'');
      b.textContent = s.label;
      b.dataset.key = s.key;
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        section = s.key; page = 1; feed.innerHTML = '';
        load(true);
      });
      secWrap.appendChild(b);
    });

    refreshBtn.addEventListener('click', ()=>{ page = 1; feed.innerHTML=''; load(true); });
    q.addEventListener('input', debounce(()=>{
      query = q.value.trim();
      page = 1; feed.innerHTML=''; load(true);
    }, 350));
    loadMoreBtn.addEventListener('click', ()=> load(false));

    // ---------- Helpers ----------
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    const clean = s => (s||'')
        .replace(/^<!\[CDATA\[/,'').replace(/\]\]>$/,'')
        .replace(/]]>$/,'').trim();

    const fmtTime = iso=>{
      try{
        const d = new Date(iso); if (isNaN(d)) return '';
        return d.toLocaleString(undefined,{ day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
      }catch{ return ''; }
    };

    function button(label, cls=''){ const b=document.createElement('button'); b.className='action '+cls; b.textContent=label; return b; }

    async function api(path, params={}){
      const url = new URL(path, location.origin);
      Object.entries(params).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') url.searchParams.set(k,v); });
      const r = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
      if (!r.ok) throw new Error(`${r.status}`);
      return r.json();
    }

    async function load(reset=false){
      if (loading) return;
      loading = true; loadMoreBtn.disabled = true; loadMoreBtn.textContent = 'Loadingâ€¦';
      try{
        const data = await api('/aggregate', { page, section, q: query });
        if (reset) feed.innerHTML = '';
        if (!data || !Array.isArray(data.articles) || data.articles.length===0){
          if (page===1) feed.innerHTML = `<div class="center hint" style="margin:20px 0">No headlines. Try Refresh.</div>`;
          return;
        }
        data.articles.forEach(addCard);
        page++;
      }catch(err){
        console.error(err);
        if (page===1){
          feed.innerHTML = `<div class="center hint" style="margin:20px 0">Couldn't load headlines. Check logs.</div>`;
        }
      }finally{
        loading = false; loadMoreBtn.disabled = false; loadMoreBtn.textContent = 'Load more';
      }
    }

    function addCard(a){
      const card = document.createElement('article'); card.className='card';
      const src = a.source || '';

      const title = clean(a.title || '');
      const desc  = (a.description||'').trim();
      const link  = a.url;

      // meta row
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<span>${src || 'â€”'}</span> Â· <span>${fmtTime(a.publishedAt)}</span>`;
      card.appendChild(meta);

      // title
      const h = document.createElement('div'); h.className='title';
      if (link){ h.innerHTML = `<a href="${link}" target="_blank" rel="noopener">${escapeHtml(title)}</a>`; }
      else { h.textContent = title; }
      card.appendChild(h);

      // description
      if (desc){
        const p = document.createElement('div'); p.className='desc'; p.textContent = desc;
        card.appendChild(p);
      }

      // buttons
      const actions = document.createElement('div'); actions.className='actions';

      const bFact = button('Fact-check');
      const bSum  = button('AI Summary','primary');
      const bShare= button('Share');

      // result panel
      const res = document.createElement('div'); res.className='result'; res.hidden = true;
      const resBody = document.createElement('div');
      const close = document.createElement('a'); close.className='close'; close.textContent='Close'; close.addEventListener('click',()=>{res.hidden=true; resBody.innerHTML='';});
      res.appendChild(close); res.appendChild(resBody);

      bFact.addEventListener('click', async ()=>{
        bFact.disabled = true; res.hidden=false; resBody.textContent='Checking factsâ€¦';
        try{
          const data = await api('/factcheck', { url: link, q: title });
          if (data && Array.isArray(data.matches) && data.matches.length){
            resBody.innerHTML = data.matches.map(m => `
              <div style="margin:6px 0">
                <div><strong>${escapeHtml(m.title||'Claim')}</strong></div>
                <div class="hint">${escapeHtml(m.rating||'')}</div>
                ${m.url ? `<div><a href="${m.url}" target="_blank" rel="noopener">${m.publisher || m.url}</a></div>`:''}
              </div>
            `).join('');
          } else if (data && Array.isArray(data.related) && data.related.length){
            resBody.innerHTML = `<div class="hint">No direct matches. Related context:</div>` +
              data.related.map(r=>`<div style="margin:6px 0"><a href="${r.url}" target="_blank" rel="noopener">${escapeHtml(r.title||r.url)}</a></div>`).join('');
          } else {
            resBody.innerHTML = `<div class="hint">No direct matches in fact-check databases. Read multiple sources.</div>`;
          }
        }catch(e){
          console.error(e);
          resBody.innerHTML = `<div class="hint">Fact-check failed. Please try again.</div>`;
        }finally{ bFact.disabled=false; }
      });

      bSum.addEventListener('click', async ()=>{
        bSum.disabled = true; res.hidden=false; resBody.textContent='Summarisingâ€¦';
        try{
          const data = await api('/summary', { url: link, title });
          if (data && (data.summary || data.points)){
            if (Array.isArray(data.points) && data.points.length){
              resBody.innerHTML = `<ul style="margin:0 0 0 18px">${data.points.map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>`;
            }else{
              resBody.textContent = data.summary;
            }
          } else {
            resBody.innerHTML = `<div class="hint">No summary available.</div>`;
          }
        }catch(e){
          console.error(e);
          resBody.innerHTML = `<div class="hint">Summary failed. Please try again.</div>`;
        }finally{ bSum.disabled=false; }
      });

      bShare.addEventListener('click', async ()=>{
        const text = `${title}\n${link||''}`;
        try{
          if (navigator.share){
            await navigator.share({ title, text, url: link||location.href });
          }else{
            await navigator.clipboard.writeText(text);
            bShare.textContent = 'Copied!';
            setTimeout(()=>bShare.textContent='Share',1200);
          }
        }catch{}
      });

      actions.appendChild(bFact);
      actions.appendChild(bSum);
      actions.appendChild(bShare);

      card.appendChild(actions);
      card.appendChild(res);
      feed.appendChild(card);
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ---------- Kickoff ----------
    load(true);
  </script>
</body>
</html>
