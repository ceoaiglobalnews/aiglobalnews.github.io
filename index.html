<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AIGLOBALNEWS ‚Äî UK Headlines, Fact-check & AI Summaries</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0e1320; --panel:#131a2a; --ink:#e9eef8; --muted:#9fb0ce; --line:#1d2740;
    --accent:#3b82f6; --accent-ink:#fff; --good:#22c55e; --warn:#eab308; --bad:#ef4444;
    --radius:14px; --radius-sm:10px;
  }
  [data-theme="light"]{
    --bg:#f7f9ff; --panel:#ffffff; --ink:#0c1220; --muted:#51607b; --line:#e9edf6;
    --accent:#2563eb; --accent-ink:#fff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:400 16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit}
  .app{max-width:980px;margin:0 auto;padding:72px 16px 80px}
  /* Header */
  .hdr{position:sticky;top:0;z-index:50;background:linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,0)) ;backdrop-filter:saturate(140%) blur(8px)}
  .hdr-inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:var(--bg)}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
  .pill{inline-size:28px;block-size:28px;border-radius:9px;background:var(--accent);display:grid;place-items:center;color:var(--accent-ink);font-weight:700}
  .hdr-actions{display:flex;gap:8px;align-items:center}
  .iconbtn{border:1px solid var(--line);background:var(--panel);color:var(--ink);border-radius:10px;inline-size:40px;block-size:40px;display:grid;place-items:center;cursor:pointer}
  .iconbtn:active{transform:translateY(1px)}
  /* Categories */
  .cats{margin:8px 16px 0;overflow:auto;padding-bottom:8px}
  .cats-inner{display:flex;gap:8px;min-width:max-content}
  .chip{border:1px solid var(--line);background:var(--panel);color:var(--ink);border-radius:999px;padding:8px 12px;font-weight:600;white-space:nowrap;cursor:pointer}
  .chip.active{background:var(--accent);border-color:var(--accent);color:var(--accent-ink)}
  /* Search */
  .searchbar{display:flex;gap:10px;margin:12px 16px}
  .searchbar input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--ink)}
  .btn{border:1px solid var(--line);background:var(--panel);color:var(--ink);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:var(--accent-ink)}
  /* Card */
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px 14px;margin:12px 0}
  .card .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
  .title{font-weight:800;font-size:18px;margin:6px 0}
  .desc{color:var(--muted);font-size:14px;margin-top:4px}
  .toolbar{display:grid;grid-template-columns:1fr;gap:8px;margin-top:12px}
  @media(min-width:560px){ .toolbar{grid-template-columns:repeat(4,1fr)} }
  .tbtn{display:flex;align-items:center;justify-content:center;gap:8px;background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700}
  .tbtn .badge{background:var(--line);padding:2px 6px;border-radius:6px;color:var(--muted);font-size:12px}
  .tbtn.primary{background:var(--accent);border-color:var(--accent);color:var(--accent-ink)}
  .drawer{display:none;margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:12px;background:color-mix(in oklab,var(--panel),var(--line) 10%)}
  .drawer.open{display:block;animation:fade .15s ease}
  .drawer .hdrline{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .small{font-size:13px;color:var(--muted)}
  .toast{position:fixed;inset:auto 16px 18px;z-index:60;background:var(--ink);color:var(--bg);padding:10px 14px;border-radius:10px;font-weight:700;display:none}
  .toast.show{display:block;animation:fade .14s ease}
  @keyframes fade{from{opacity:.6;transform:translateY(4px)} to{opacity:1;transform:none}}
  /* Settings modal */
  dialog{border:none;border-radius:16px;padding:0;max-width:520px;width:92%;background:var(--panel);color:var(--ink)}
  .modal{padding:18px;border-bottom:1px solid var(--line)}
  .modal h3{margin:0 0 12px}
  .field{display:flex;gap:8px}
  .field input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--bg);color:var(--ink)}
  .modal .hint{font-size:13px;color:var(--muted);margin-top:8px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 18px}
  /* Empty state */
  .empty{margin:24px auto;border:1px dashed var(--line);border-radius:16px;padding:18px;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <header class="hdr" role="banner">
    <div class="hdr-inner">
      <div class="brand" aria-label="AIGLOBALNEWS">
        <span class="pill">AI</span> <span>AIGLOBALNEWS</span>
      </div>
      <div class="hdr-actions">
        <button class="iconbtn" id="toggleTheme" title="Toggle light/dark" aria-label="Toggle light/dark">üåì</button>
        <button class="iconbtn" id="openSettings" title="Settings" aria-label="Settings">‚öôÔ∏è</button>
      </div>
    </div>
    <nav class="cats" aria-label="Sections">
      <div class="cats-inner" id="catBar">
        <button class="chip active" data-topic="all">All</button>
        <button class="chip" data-topic="nhs">NHS</button>
        <button class="chip" data-topic="workforce">Workforce</button>
        <button class="chip" data-topic="digital">Digital</button>
        <button class="chip" data-topic="economy">Economy</button>
        <button class="chip" data-topic="politics">Politics</button>
      </div>
    </nav>
    <div class="searchbar" role="search">
      <input id="search" placeholder="Search headlines‚Ä¶" inputmode="search" />
      <button class="btn" id="refreshBtn" title="Refresh">Refresh</button>
    </div>
  </header>

  <main class="app" id="app" role="main">
    <div class="empty" id="emptyState">Paste your Cloudflare Worker URL in <strong>Settings</strong> to load headlines.</div>
    <div id="list"></div>
    <div style="display:flex;justify-content:center;margin-top:16px">
      <button class="btn primary" id="loadMore">Load more</button>
    </div>
  </main>

  <!-- Settings modal -->
  <dialog id="settings">
    <div class="modal">
      <h3>Settings</h3>
      <div class="field">
        <input id="workerUrl" placeholder="https://aiglobalnews-worker.YOURNAME.workers.dev" />
        <button class="btn" id="saveSettings">Save</button>
      </div>
      <div class="hint">We only store this locally in your browser. It should be the <strong>base</strong> URL to your Worker (no trailing slash).</div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="closeSettings">Close</button>
    </div>
  </dialog>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  // --- State ---
  const S = {
    base: localStorage.getItem('worker_base') || '',
    topic: 'all',
    page: 1,
    pageSize: 20,
    allItems: [],
    filtered: []
  };

  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const list = $('#list');
  const empty = $('#emptyState');

  // --- Helpers ---
  const showToast = (msg) => {
    const t = $('#toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 1800);
  };

  const fmtDate = iso => {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
  };

  const setTheme = (want) => {
    const el = document.documentElement;
    const next = want || (el.getAttribute('data-theme')==='dark'?'light':'dark');
    el.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  };

  // --- Rendering ---
  function render(items){
    list.innerHTML = '';
    if (!items.length){
      empty.style.display='block';
      return;
    }
    empty.style.display='none';
    const frag = document.createDocumentFragment();
    items.forEach((it, idx) => frag.appendChild(renderCard(it, idx)));
    list.appendChild(frag);
  }

  function renderCard(it, idx){
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <div class="meta"><span>üì∞ ${it.source || ''}</span> ‚Ä¢ <span>${fmtDate(it.date)}</span></div>
      <h2 class="title"><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></h2>
      ${it.description ? `<div class="desc">${it.description.slice(0,220)}${it.description.length>220?'‚Ä¶':''}</div>`:''}
      <div class="toolbar" role="group" aria-label="Actions">
        <button class="tbtn" data-act="fact" data-i="${idx}" aria-label="Fact-check this headline">üîé Fact-check</button>
        <button class="tbtn primary" data-act="ai" data-i="${idx}" aria-label="AI summary">‚ú® AI Summary</button>
        <button class="tbtn" data-act="copy" data-i="${idx}" aria-label="Copy link">üîó Copy link</button>
        <button class="tbtn" data-act="share" data-i="${idx}" aria-label="Share">üì§ Share</button>
      </div>
      <div class="drawer" id="drawer-${idx}">
        <div class="hdrline">
          <strong id="drawerTitle-${idx}">Result</strong>
          <button class="btn" data-act="close" data-i="${idx}" aria-label="Collapse">Close</button>
        </div>
        <div class="small" id="drawerBody-${idx}">Working‚Ä¶</div>
      </div>
    `;
    return card;
  }

  function toggleDrawer(i, open, title, bodyHTML){
    const d = document.getElementById(`drawer-${i}`);
    if (!open){ d.classList.remove('open'); return; }
    // close any other open drawer
    $$('.drawer.open').forEach(x => x.classList.remove('open'));
    d.classList.add('open');
    if (title) document.getElementById(`drawerTitle-${i}`).textContent = title;
    if (bodyHTML !== undefined) document.getElementById(`drawerBody-${i}`).innerHTML = bodyHTML;
    // scroll into view nicely on mobile
    d.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // --- Data ---
  async function loadHeadlines(reset=false){
    if (!S.base){ empty.style.display='block'; return; }
    if (reset){ S.page=1; S.allItems.length=0; }
    const url = `${S.base}/aggregate?count=${S.pageSize}&topic=${encodeURIComponent(S.topic)}`;
    const r = await fetch(url);
    if (!r.ok) { showToast('Could not load headlines'); return; }
    const j = await r.json();
    S.allItems = (reset ? j.items : [...S.allItems, ...j.items]);
    S.filtered = S.allItems;
    applySearch($('#search').value);
  }

  function applySearch(q){
    const term = (q||'').trim().toLowerCase();
    const items = term ? S.filtered.filter(x =>
      (x.title||'').toLowerCase().includes(term) || (x.source||'').toLowerCase().includes(term)
    ) : S.filtered;
    render(items);
  }

  // --- Actions ---
  list.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button.tbtn, button.btn');
    if (!btn) return;
    const i = btn.getAttribute('data-i');
    const act = btn.getAttribute('data-act');
    const item = S.filtered[i];

    if (act === 'close'){ toggleDrawer(i,false); return; }

    if (act === 'copy'){
      try {
        await navigator.clipboard.writeText(item.link);
        showToast('Link copied');
      } catch {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = item.link; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); ta.remove();
        showToast('Link copied');
      }
      return;
    }

    if (act === 'share'){
      const data = { title:item.title, text:item.title, url:item.link };
      if (navigator.share){
        try { await navigator.share(data); } catch {} // user cancel is fine
      } else {
        // iOS Safari < 12 / desktop fallback: copy link then toast
        try { await navigator.clipboard.writeText(item.link); } catch {}
        showToast('Sharing not supported ‚Äî link copied');
      }
      return;
    }

    if (act === 'fact'){
      toggleDrawer(i, true, 'Fact-check', '<div class="small">Looking up Google Fact Check Tools‚Ä¶</div>');
      try{
        const r = await fetch(`${S.base}/factcheck?q=${encodeURIComponent(item.title)}`);
        const j = await r.json();
        const parts = [];
        if (j.claims && j.claims.length){
          parts.push('<strong>Matches</strong><ul>');
          j.claims.slice(0,6).forEach(c=>{
            const rev = (c.claimReview||[])[0] || {};
            parts.push(`<li><a href="${rev.url||'#'}" target="_blank" rel="noopener">${rev.publisher?.name||'Fact-check'}</a> ‚Äî ${rev.textualRating||''}</li>`);
          });
          parts.push('</ul>');
        } else {
          parts.push('<em>No direct matches in Google Fact Check Tools.</em>');
        }
        if (j.wiki?.extract){
          parts.push(`<div style="margin-top:8px"><strong>Wikipedia</strong><div class="small">${j.wiki.extract} <a href="${j.wiki.url}" target="_blank" rel="noopener">read more</a></div></div>`);
        }
        if (j.ai){
          parts.push(`<div style="margin-top:8px"><strong>AI credibility scan</strong><div class="small">${j.ai}</div></div>`);
        }
        toggleDrawer(i, true, 'Fact-check', parts.join(''));
      }catch{
        toggleDrawer(i, true, 'Fact-check', '<span class="small">Unable to fetch fact-check.</span>');
      }
      return;
    }

    if (act === 'ai'){
      toggleDrawer(i, true, 'AI Summary', '<div class="small">Generating concise summary‚Ä¶</div>');
      try{
        const r = await fetch(`${S.base}/summary?title=${encodeURIComponent(item.title)}&url=${encodeURIComponent(item.link)}`);
        const j = await r.json();
        if (j.ok && j.summary){
          toggleDrawer(i, true, 'AI Summary', `<div class="small">${j.summary.replace(/\n/g,'<br/>')}</div>`);
        } else {
          toggleDrawer(i, true, 'AI Summary', '<span class="small">AI summary unavailable.</span>');
        }
      }catch{
        toggleDrawer(i, true, 'AI Summary', '<span class="small">AI summary failed.</span>');
      }
      return;
    }
  });

  // --- UI wiring ---
  $('#toggleTheme').addEventListener('click', ()=> setTheme());
  $('#openSettings').addEventListener('click', ()=> {
    $('#workerUrl').value = S.base;
    $('#settings').showModal();
  });
  $('#closeSettings').addEventListener('click', ()=> $('#settings').close());
  $('#saveSettings').addEventListener('click', ()=>{
    const v = ($('#workerUrl').value||'').replace(/\/+$/,'');
    if (!/^https?:\/\/[^ ]+$/i.test(v)) { showToast('Enter a valid https URL'); return; }
    S.base = v; localStorage.setItem('worker_base', v);
    $('#settings').close();
    loadHeadlines(true);
  });

  $('#refreshBtn').addEventListener('click', ()=> loadHeadlines(true));
  $('#loadMore').addEventListener('click', ()=> { S.page++; loadHeadlines(false); });

  $('#search').addEventListener('input', (e)=> applySearch(e.target.value));

  $('#catBar').addEventListener('click', (e)=>{
    const b = e.target.closest('.chip'); if (!b) return;
    $$('#catBar .chip').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    S.topic = b.dataset.topic;
    loadHeadlines(true);
  });

  // --- boot ---
  (function init(){
    // theme
    const savedTheme = localStorage.getItem('theme'); if (savedTheme) setTheme(savedTheme);
    if (S.base) loadHeadlines(true);
  })();

})();
</script>
</body>
</html>
