<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AIGLOBALNEWS</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1220;--card:#11192b;--muted:#8b97b2;--text:#ecf2ff;
    --accent:#4da3ff;--accent-2:#7cc4ff;--ring:rgba(77,163,255,.42);
    --danger:#ff6b6b;--radius:14px;--shadow:0 6px 22px rgba(0,0,0,.28),0 2px 6px rgba(0,0,0,.18)
  }
  :root.light{--bg:#f6f8fc;--card:#ffffff;--text:#0b1220;--muted:#55607a;--shadow:0 8px 28px rgba(16,24,40,.08),0 2px 8px rgba(16,24,40,.06);--ring:rgba(25,119,243,.25)}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin-inline:auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:6px 0 12px}
  .brand{display:flex;align-items:center;gap:12px}
  .badge{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#001632;font-weight:900}
  .title{font-weight:800;letter-spacing:.35px}
  .iconbtn{width:40px;height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:var(--card);color:var(--text);display:grid;place-items:center;cursor:pointer;box-shadow:var(--shadow)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:var(--card);color:var(--text);cursor:pointer;font-size:14px}
  .chip.active{outline:2px solid var(--ring);border-color:transparent}
  .searchrow{display:flex;gap:8px;margin:6px 0 12px}
  .searchrow input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:var(--card);color:var(--text);outline:none;box-shadow:var(--shadow)}
  .searchrow button{padding:12px 14px;border-radius:12px;border:none;background:var(--accent);color:#031225;font-weight:800;cursor:pointer}
  .notice{font-size:13px;color:var(--muted);border:1px dashed rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;background:color-mix(in oklab,var(--card) 85%, transparent)}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:14px 0}
  .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px;margin-bottom:6px}
  .hlink{color:var(--text);text-decoration:none;font-weight:850;line-height:1.25;font-size:20px}
  .snippet{color:var(--muted);margin:8px 0 10px;font-size:15px;line-height:1.45}
  .toolbar{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  @media (min-width:640px){.toolbar{grid-template-columns:repeat(4,1fr)}}
  .btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:color-mix(in oklab,var(--card) 80%, #0a0a0a 20%);color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#061437;border-color:transparent}
  .result{border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;margin-top:10px;background:color-mix(in oklab,var(--card) 88%, transparent)}
  .rhead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .rhead h4{margin:0;font-size:15px}
  .close{margin-left:auto;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:800}
  .small{font-size:12px;color:var(--muted)}
  .center{display:flex;justify-content:center;align-items:center;padding:14px}
  .spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(255,255,255,.16);border-top-color:var(--accent);border-radius:50%;animation:spin .9s linear infinite;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="badge">AI</div>
      <div class="title">AIGLOBALNEWS</div>
    </div>
    <button id="theme" class="iconbtn" title="Toggle theme">ðŸŒ“</button>
  </header>

  <div class="chips" id="sections">
    <button class="chip active" data-sec="all">All</button>
    <button class="chip" data-sec="nhs">NHS</button>
    <button class="chip" data-sec="workforce">Workforce</button>
    <button class="chip" data-sec="digital">Digital</button>
    <button class="chip" data-sec="economy">Economy</button>
    <button class="chip" data-sec="politics">Politics</button>
  </div>

  <div class="searchrow">
    <input id="q" placeholder="Search headlinesâ€¦" />
    <button id="refresh">Refresh</button>
  </div>

  <p class="notice">
    UK headlines (cached &amp; de-duplicated). Use ðŸ”Ž <b>Fact-check</b> (Google Fact Check + Worker fallback),
    âœ¨ <b>AI Summary</b> for quick context, and ðŸ”— <b>Copy link</b>. Summaries are informational â€” always read the source.
  </p>

  <div id="news"></div>
  <div class="center"><button id="more" class="btn">Load more</button></div>
</div>

<script>
(() => {
  /* ------------ CONNECTION STRATEGY -------------
     1) Try your domain routes at /api/*
     2) Try a saved Worker URL in localStorage (if ever set)
     3) Try a hard-coded workers.dev fallback (set below)
  ------------------------------------------------ */
  const HARDCODED_WORKER = ''; // e.g. 'https://aiglobalnews-worker.YOURNAME.workers.dev' (leave empty if Routes exist)

  const themeBtn = document.getElementById('theme');
  const setTheme = t => { document.documentElement.classList.toggle('light', t==='light'); localStorage.setItem('theme', t); };
  setTheme(localStorage.getItem('theme')||'dark');
  themeBtn.addEventListener('click',()=>setTheme(document.documentElement.classList.contains('light')?'dark':'light'));

  let page=1, section='all', query='';
  const newsEL = document.getElementById('news');
  const esc = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const when = iso => { try{ const d=new Date(iso); return d.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});}catch{return '';} };

  const candidates = [
    location.origin + '/api',                         // Cloudflare Routes on your domain
    localStorage.getItem('workerBase') || '',        // saved base (if you ever store it)
    HARDCODED_WORKER                                 // hard-coded fallback (fill if not routing)
  ].filter(Boolean);

  async function api(path, params) {
    const qs = new URLSearchParams(params||{}).toString();
    const paths = candidates.map(b => b.replace(/\/$/,'') + path + (qs?`?${qs}`:''));
    let lastErr;
    for (const u of paths) {
      try {
        const r = await fetch(u, { headers:{'Accept':'application/json'} });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return await r.json();
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error('All endpoints failed');
  }

  function cardHTML(a, idx){
    return `
      <article class="card" data-url="${esc(a.url)}">
        <div class="meta"><span>${esc(a.source||'')}</span><span>â€¢</span><span>${esc(when(a.publishedAt))}</span></div>
        <a class="hlink" href="${esc(a.url)}" target="_blank" rel="noopener">${esc(a.title)}</a>
        ${a.description?`<p class="snippet">${esc(a.description)}</p>`:''}
        <div class="toolbar">
          <button class="btn" data-action="fact">ðŸ”Ž Fact-check</button>
          <button class="btn primary" data-action="ai">âœ¨ AI Summary</button>
          <button class="btn" data-action="copy">ðŸ”— Copy link</button>
          <button class="btn" data-action="share">ðŸ“¤ Share</button>
        </div>
        <div class="result" hidden>
          <div class="rhead">
            <h4 class="rtitle"></h4>
            <button class="close" data-action="close">Close âœ•</button>
          </div>
          <div class="rbody small">â€”</div>
        </div>
      </article>`;
  }

  function showResult(card, title, html) {
    const res = card.querySelector('.result');
    res.hidden = false;
    card.querySelector('.rtitle').textContent = title;
    card.querySelector('.rbody').innerHTML = html;
  }
  function hideResult(card){
    const res = card.querySelector('.result');
    if (res) res.hidden = true;
  }

  function factHTML(res) {
    if(!res || res.ok===false){
      return `<div class="small" style="color:var(--danger)">Fact-check unavailable for this item.</div>`;
    }
    if (res.matches?.length) {
      const items = res.matches.slice(0,6).map(m => `
        <li>
          <strong>${esc(m.claim||m.title||'Claim')}</strong>
          <div class="small">Rating: <b>${esc(m.textualRating||m.rating||'â€”')}</b></div>
          ${m.url?`<div class="small"><a href="${esc(m.url)}" target="_blank" rel="noopener">Source</a></div>`:''}
        </li>`).join('');
      return `<ul>${items}</ul>`;
    }
    // helper when there are no direct matches
    return `
      <div class="small">No direct matches in Google Fact Check Tools.</div>
      ${res.note?`<div class="small" style="margin-top:6px">${esc(res.note)}</div>`:''}
      ${res.related?.length?`<hr style="border:none;border-top:1px solid rgba(255,255,255,.12);margin:8px 0"/><div class="small">Related:</div><ul>${res.related.slice(0,4).map(r=>`<li><a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title||r.url)}</a></li>`).join('')}</ul>`:''}
    `;
  }
  function aiHTML(res) {
    if(!res || res.ok===false) return `<div class="small" style="color:var(--danger)">Couldn't generate a summary right now.</div>`;
    const txt = res.summary || res.ai || res.text || '';
    return txt ? `<div style="white-space:pre-wrap;line-height:1.5">${esc(txt)}</div>` : `<div class="small">No summary was returned.</div>`;
  }

  async function load({reset=false}={}){
    if(reset){ page=1; newsEL.innerHTML=''; }
    const skel = document.createElement('div'); skel.className='card'; skel.innerHTML=`<div class="center"><span class="spinner"></span> Loadingâ€¦</div>`; newsEL.appendChild(skel);
    try{
      const data = await api('/aggregate', { page, section, q: query });
      skel.remove();
      const items = data?.articles || [];
      if(!items.length && page===1){
        newsEL.insertAdjacentHTML('beforeend', `<div class="card"><div class="center small">No headlines found.</div></div>`);
        return;
      }
      items.forEach((a,i)=> newsEL.insertAdjacentHTML('beforeend', cardHTML(a, `${page}-${i}`)));
      page++;
    }catch(e){
      skel.remove();
      newsEL.insertAdjacentHTML('beforeend', `<div class="card"><div class="center small" style="color:var(--danger)">Couldn't load headlines. Check logs.</div></div>`);
      console.error(e);
    }
  }

  newsEL.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btn,.close'); if(!btn) return;
    const card = e.target.closest('.card'); const url = card?.dataset.url;
    if(btn.dataset.action==='close'){ hideResult(card); return; }

    if(btn.dataset.action==='copy'){
      try{ await navigator.clipboard.writeText(url); btn.innerHTML='âœ… Copied'; setTimeout(()=>btn.innerHTML='ðŸ”— Copy link',1200);}catch{}
      return;
    }
    if(btn.dataset.action==='share'){
      const data={title:card.querySelector('.hlink')?.textContent?.trim()||'Headline', url};
      if(navigator.share){ try{ await navigator.share(data);}catch{} } else { try{ await navigator.clipboard.writeText(url); btn.innerHTML='âœ… Copied'; setTimeout(()=>btn.innerHTML='ðŸ“¤ Share',1200);}catch{} }
      return;
    }

    // collapse/expand behaviour
    const opened = !card.querySelector('.result').hidden;
    if(opened){ hideResult(card); return; }

    showResult(card, btn.dataset.action==='fact'?'Fact-check':'AI Summary', `<div class="small"><span class="spinner"></span> Workingâ€¦</div>`);

    try{
      if(btn.dataset.action==='fact'){
        const res = await api('/factcheck', { q: url });
        showResult(card,'Fact-check', factHTML(res));
        return;
      }
      if(btn.dataset.action==='ai'){
        // try /summary?url=, then /ai?q=
        let res, err;
        try{ res = await api('/summary', { url }); }
        catch(e1){ err=e1; try{ res = await api('/ai', { q: url }); }catch(e2){ err=e2; } }
        showResult(card, 'AI Summary', aiHTML(res||{ok:false}));
        return;
      }
    }catch(e){
      console.error(e);
      showResult(card, 'Error', `<div class="small" style="color:var(--danger)">Something went wrong.</div>`);
    }
  });

  document.getElementById('refresh').addEventListener('click',()=>{ query=document.getElementById('q').value.trim(); load({reset:true}); });
  document.getElementById('q').addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('refresh').click(); });
  document.getElementById('sections').addEventListener('click',(e)=>{ const c=e.target.closest('.chip'); if(!c) return; document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); c.classList.add('active'); section=c.dataset.sec||'all'; load({reset:true}); });
  document.getElementById('more').addEventListener('click',()=>load());

  load({reset:true});
})();
</script>
</body>
</html>
