<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AIGLOBALNEWS</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1020; --card:#121933; --text:#e8ecff; --muted:#9fb2ff; --accent:#4f7dff; --ok:#1fb950; --warn:#f59e0b; --bad:#ef4444; --chip:#1a2452;
  }
  .light{
    --bg:#f7f9ff; --card:#ffffff; --text:#0b1020; --muted:#4b5a88; --accent:#2850ff; --ok:#138a3c; --warn:#b57406; --bad:#b91c1c; --chip:#e9eeff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:960px; margin:0 auto; padding:16px}
  header{display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:34px; height:34px; display:grid; place-items:center; border-radius:10px; background:var(--accent); color:#fff; font-weight:700}
  .title{font-weight:800; letter-spacing:.2px}
  .toggle{display:flex; align-items:center; gap:8px; user-select:none}
  .toggle input{appearance:none; width:44px; height:24px; border-radius:24px; background:var(--chip); position:relative; outline:none; cursor:pointer}
  .toggle input:before{content:""; width:18px; height:18px; border-radius:50%; background:#fff; position:absolute; top:3px; left:3px; transition:.2s ease}
  .toggle input:checked:before{transform:translateX(20px)}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0}
  .chip{padding:8px 12px; border-radius:999px; background:var(--chip); color:var(--text); border:1px solid transparent; cursor:pointer}
  .chip.active{background:var(--accent); color:#fff}
  .bar{display:flex; gap:8px; margin:8px 0 14px}
  .bar input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid transparent; background:var(--card); color:var(--text)}
  .bar button{padding:10px 12px; border-radius:10px; border:1px solid transparent; background:var(--accent); color:#fff; cursor:pointer}
  .hint{font-size:13px; color:var(--muted); margin-bottom:12px}
  .card{background:var(--card); border-radius:14px; padding:14px; margin:12px 0; box-shadow:0 2px 10px rgba(0,0,0,.15)}
  .meta{font-size:12px; color:var(--muted); margin-bottom:6px}
  .card h3{margin:0 0 6px; font-size:17px}
  .snippet{color:var(--text); opacity:.9; font-size:14px}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .btn{padding:10px 12px; border-radius:10px; background:var(--chip); border:1px solid #0000; color:var(--text); cursor:pointer}
  .btn.primary{background:var(--accent); color:#fff}
  .btn.ok{background:color-mix(in oklab, var(--ok) 80%, black 0%) ; color:#fff}
  .btn.share{background:var(--chip)}
  .result{margin-top:10px; padding:10px; border-radius:10px; background:var(--chip); font-size:14px; white-space:pre-wrap}
  .error{color:var(--bad)}
  .center{display:grid; place-items:center; padding:18px}
  .load{margin:16px auto; display:block}
  a{color:var(--accent); text-decoration:underline}
  @media (max-width:480px){ .title{font-size:18px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AI</div>
        <div class="title">AIGLOBALNEWS</div>
      </div>
      <label class="toggle" title="Day / Night">
        <span>üåô/‚òÄÔ∏è</span>
        <input id="themeToggle" type="checkbox" />
      </label>
    </header>

    <div class="tabs" id="tabs">
      <button class="chip active" data-sec="all">All</button>
      <button class="chip" data-sec="nhs">NHS</button>
      <button class="chip" data-sec="workforce">Workforce</button>
      <button class="chip" data-sec="digital">Digital</button>
      <button class="chip" data-sec="economy">Economy</button>
      <button class="chip" data-sec="politics">Politics</button>
    </div>

    <div class="bar">
      <input id="q" placeholder="Search headlines‚Ä¶" />
      <button id="refresh">Refresh</button>
    </div>

    <div class="hint">
      Use üîé <b>Fact-check</b> (Google Fact Check + Worker fallback), ‚ú® <b>AI Summary</b> for quick context, and üîó <b>Share</b> for native share. Summaries are informational; always read the source.
    </div>

    <div id="feed"></div>
    <div class="center"><button id="more" class="btn load">Load more</button></div>
  </div>

<script>
(() => {
  // --- SETTINGS (use your domain so no workers.dev needed)
  const API_BASE = "https://aiglobalnews.co.uk";

  // --- THEME
  const themeToggle = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.classList.toggle('light', savedTheme === 'light');
  themeToggle.checked = savedTheme === 'light';
  themeToggle.addEventListener('change', () => {
    const mode = themeToggle.checked ? 'light' : 'dark';
    document.body.classList.toggle('light', mode === 'light');
    localStorage.setItem('theme', mode);
  });

  // --- STATE
  let page = 1;
  let section = 'all';
  let currentQ = '';

  const feed = document.getElementById('feed');
  const moreBtn = document.getElementById('more');

  // --- HELPERS
  const clean = (s) => (s || '').replace(/<!\[CDATA\[|\]\]>/g, '').replace(/<[^>]+>/g,'').trim();
  const ellipsis = (s, n=280) => s.length > n ? s.slice(0, n-1) + '‚Ä¶' : s;
  const fmtTime = (iso) => {
    try { return new Date(iso).toLocaleString(); } catch { return ''; }
  };

  function button(label, cls='btn'){
    const b = document.createElement('button');
    b.className = cls;
    b.textContent = label;
    return b;
  }

  function renderItem(item){
    const card = document.createElement('div');
    card.className = 'card';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = `${item.source || ''} ‚Ä¢ ${fmtTime(item.publishedAt)}`;
    card.append(meta);

    const h = document.createElement('h3');
    const url = item.url || '';
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.rel = 'noopener';
    a.textContent = clean(item.title || 'Untitled');
    h.append(a);
    card.append(h);

    if (item.description){
      const sn = document.createElement('div');
      sn.className = 'snippet';
      sn.textContent = ellipsis(clean(item.description));
      card.append(sn);
    }

    const actions = document.createElement('div');
    actions.className = 'actions';

    const fact = button('üîé Fact-check');
    const sum  = button('‚ú® AI Summary', 'btn primary');
    const share= button('üîó Share','btn share');

    actions.append(fact, sum, share);
    card.append(actions);

    // where results show
    const result = document.createElement('div');
    result.className = 'result';
    result.style.display = 'none';
    card.append(result);

    // handlers
    fact.addEventListener('click', async () => {
      result.style.display = 'block';
      result.textContent = 'Checking facts‚Ä¶';
      try{
        const u = new URL(`${API_BASE}/factcheck`);
        if (url) u.searchParams.set('url', url);
        if (!url && item.title) u.searchParams.set('q', clean(item.title));
        const r = await fetch(u, { headers: { 'Accept': 'application/json' }});
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        const data = await r.json();
        if (data.ok && data.matches && data.matches.length){
          const lines = data.matches.slice(0,3).map(m => `‚Ä¢ ${m.claim} ‚Äî ${m.rating || 'See source'}\n  ${m.url}`);
          result.textContent = `Fact-check matches:\n\n${lines.join('\n\n')}`;
        } else if (data.ok && data.related && data.related.length){
          const lines = data.related.slice(0,3).map(m => `‚Ä¢ ${m.title}\n  ${m.url}`);
          result.textContent = `No direct matches. Related coverage:\n\n${lines.join('\n\n')}`;
        } else {
          result.textContent = 'No direct matches in Google Fact Check Tools. Try official sources: Google News, Wikipedia.';
        }
      }catch(err){
        result.innerHTML = `<span class="error">Fact-check failed:</span> ${err.message}`;
      }
    });

    sum.addEventListener('click', async () => {
      result.style.display = 'block';
      result.textContent = 'Summarising‚Ä¶';
      try{
        const u = new URL(`${API_BASE}/summary`);
        if (url) u.searchParams.set('url', url);
        if (!url && item.title) u.searchParams.set('title', clean(item.title));
        const r = await fetch(u, { headers: { 'Accept': 'application/json' }});
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        const data = await r.json();
        if (data.ok && data.summary){
          result.textContent = data.summary.trim();
        } else if (data.ok && data.url){
          result.textContent = `URL: ${data.url}`;
        } else {
          result.textContent = 'No summary returned.';
        }
      }catch(err){
        result.innerHTML = `<span class="error">AI summary failed:</span> ${err.message}`;
      }
    });

    share.addEventListener('click', async () => {
      try{
        if (navigator.share){
          await navigator.share({ title: clean(item.title || 'AIGLOBALNEWS'), text: 'Shared via AIGLOBALNEWS', url });
        } else {
          await navigator.clipboard.writeText(url);
          share.textContent = '‚úÖ Copied';
          setTimeout(()=> share.textContent='üîó Share', 1200);
        }
      }catch{}
    });

    return card;
  }

  async function load(reset=false){
    if (reset){ page = 1; feed.innerHTML=''; }
    const q = (document.getElementById('q').value || '').trim();
    currentQ = q;
    const u = new URL(`${API_BASE}/aggregate`);
    u.searchParams.set('page', String(page));
    u.searchParams.set('section', section);
    u.searchParams.set('q', q);
    try{
      moreBtn.disabled = true; moreBtn.textContent = 'Loading‚Ä¶';
      const r = await fetch(u, { headers: { 'Accept':'application/json' }});
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      const data = await r.json();
      if (!data.ok) throw new Error('Worker error');
      const items = data.articles || [];
      if (reset && items.length === 0){
        feed.innerHTML = `<div class="result error">Couldn't load headlines. ${data.error || ''}</div>`;
      }
      for (const it of items){
        feed.append( renderItem(it) );
      }
      if (items.length > 0){ page += 1; }
    }catch(err){
      feed.innerHTML = `<div class="result error">Couldn't load headlines. ${err.message}</div>`;
    }finally{
      moreBtn.disabled = false; moreBtn.textContent = 'Load more';
    }
  }

  // tabs
  document.getElementById('tabs').addEventListener('click', (e) => {
    const b = e.target.closest('.chip'); if (!b) return;
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    b.classList.add('active');
    section = b.dataset.sec || 'all';
    load(true);
  });

  document.getElementById('refresh').addEventListener('click', ()=> load(true));
  moreBtn.addEventListener('click', ()=> load(false));

  // initial
  load(true);
})();
</script>
</body>
</html>
