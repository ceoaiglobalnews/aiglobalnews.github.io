<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AIGLOBALNEWS ‚Äî UK Headlines</title>
<meta name="color-scheme" content="light dark">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1320; --panel:#0f1b2f; --text:#e7edf7; --muted:#a6b3c9;
    --accent:#3b82f6; --accent-weak:#1f4fcc; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --chip:#12213b;
    --btn-h:38px; --radius:14px; --gap:10px; --shadow:0 6px 24px rgba(0,0,0,.3);
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  @media (prefers-color-scheme:light){
    :root{ --bg:#f6f8fc; --panel:#ffffff; --text:#09111f; --muted:#4a5873; --chip:#eef2fb; --shadow:0 6px 24px rgba(16,24,40,.06); }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); font-family:var(--font);
    -webkit-font-smoothing:antialiased; line-height:1.45;
  }
  .wrap{max-width:1000px; margin:auto; padding:18px; display:flex; flex-direction:column; gap:16px}
  /* header */
  .top{
    display:flex; align-items:center; gap:12px; justify-content:space-between
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px; font-size:22px}
  .badge{width:34px; height:34px; border-radius:10px; background:var(--chip); display:grid; place-items:center; font-weight:800}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .chips{display:flex; gap:10px; flex-wrap:wrap}
  .chip{
    padding:8px 12px; border-radius:999px; background:var(--chip); color:var(--text);
    font-weight:600; font-size:13px; cursor:pointer; user-select:none; border:1px solid transparent;
  }
  .chip.active{ background:rgba(59,130,246,.15); border-color:rgba(59,130,246,.35); color:var(--accent) }
  .searchbar{flex:1; min-width:220px; display:flex; gap:8px}
  .searchbar input{
    flex:1; height:40px; border-radius:999px; border:1px solid rgba(148,163,184,.3);
    background:var(--panel); color:var(--text); padding:0 14px;
  }
  .btn{
    height:var(--btn-h); border-radius:10px; background:var(--accent); color:#fff;
    border:none; padding:0 14px; font-weight:700; cursor:pointer;
    display:inline-flex; align-items:center; gap:8px; box-shadow:var(--shadow)
  }
  .btn.secondary{ background:var(--chip); color:var(--text); box-shadow:none; border:1px solid rgba(148,163,184,.25) }
  .btn.ghost{ background:transparent; color:var(--text); border:1px solid rgba(148,163,184,.25) }
  .btn.icon{ width:40px; padding:0; justify-content:center }
  .notice{ background:var(--panel); border:1px dashed rgba(148,163,184,.3); padding:10px 14px; border-radius:12px; font-size:13px; color:var(--muted)}
  /* card */
  .card{
    background:var(--panel); border-radius:18px; padding:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:12px;
    border:1px solid rgba(148,163,184,.15);
  }
  .meta{ color:var(--muted); font-size:12px; display:flex; gap:10px; align-items:center }
  .title{ font-size:20px; font-weight:800; letter-spacing:.2px; margin:0 }
  .desc{ color:var(--muted); margin:0; font-size:14px }
  /* compact action bar */
  .actions{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .action{
    height:34px; border-radius:9px; padding:0 10px; display:inline-flex; align-items:center; gap:6px;
    border:1px solid rgba(148,163,184,.25); background:var(--chip); color:var(--text); font-weight:700; font-size:13px; cursor:pointer;
  }
  .action.primary{ background:var(--accent); color:#fff; border-color:transparent }
  .action:active{ transform:translateY(1px) }
  .footer{ display:flex; justify-content:center; padding:16px 0 }
  .skeleton{opacity:.3; animation:pulse 1.3s infinite}
  @keyframes pulse{0%{opacity:.3}50%{opacity:.6}100%{opacity:.3}}
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827cc; color:#fff; padding:10px 14px; border-radius:10px; font-size:13px; z-index:9 }
  .hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="badge">AI</div>
        <div>AIGLOBALNEWS</div>
      </div>
      <div class="row">
        <button id="themeBtn" class="btn secondary icon" title="Toggle theme">üåì</button>
        <button id="settingsBtn" class="btn secondary icon" title="Settings">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="chips" id="chips">
      <div data-tag="all" class="chip active">All</div>
      <div data-tag="NHS" class="chip">NHS</div>
      <div data-tag="Workforce" class="chip">Workforce</div>
      <div data-tag="Digital" class="chip">Digital</div>
      <div data-tag="Economy" class="chip">Economy</div>
      <div data-tag="Politics" class="chip">Politics</div>
    </div>

    <div class="row">
      <div class="searchbar">
        <input id="q" placeholder="Search headlines‚Ä¶">
      </div>
      <button id="refreshBtn" class="btn ghost">Refresh</button>
    </div>

    <div class="notice" id="tips">
      UK headlines (cached &amp; deduplicated). Use üîé <b>Fact-check</b> &nbsp;‚ú® <b>AI Summary</b>. &nbsp;üîó <b>Share</b> opens native share or copies the link.
    </div>

    <div id="news" class="col" style="display:flex; flex-direction:column; gap:14px"></div>

    <div class="footer">
      <button id="loadMoreBtn" class="btn secondary">Load more</button>
    </div>
  </div>

  <!-- Settings modal (simple prompt) -->
  <div id="toast" class="toast hidden"></div>

<script>
/* =========================
   CONFIG
========================= */
const DEFAULT_WORKER = "https://aiglobalnews-worker.bmbotelho.workers.dev"; // change if needed
const PAGE_SIZE = 12;

/* =========================
   STATE
========================= */
let state = {
  worker: null,
  items: [],
  page: 0,
  tag: "all",
  query: ""
};

/* =========================
   UTIL
========================= */
const $ = sel => document.querySelector(sel);
function toast(msg, ms=2200){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.remove("hidden");
  setTimeout(()=>t.classList.add("hidden"), ms);
}
function decodeCDATA(s=""){
  // remove <![CDATA[ ... ]]>
  return s.replace(/^<!\[CDATA\[/, "").replace(/\]\]>$/, "");
}
function esc(str=""){
  return str.replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
}
function short(s, n=180){
  if(!s) return "";
  const t = s.trim();
  return t.length>n ? t.slice(0, n-1) + "‚Ä¶" : t;
}
function getWorker(){
  return state.worker || localStorage.getItem("workerBase") || DEFAULT_WORKER;
}
function setWorker(url){
  state.worker = url;
  localStorage.setItem("workerBase", url);
}

/* =========================
   RENDER
========================= */
const newsEl = $("#news");
function render(){
  newsEl.innerHTML = "";
  if(!state.items.length){
    newsEl.innerHTML = `<div class="notice">No headlines found.</div>`;
    return;
  }
  for(const a of state.items){
    const url = a.url;
    const title = esc(decodeCDATA(a.title || ""));
    const desc = esc(short(a.description || "", 220));
    const src  = esc(a.source || "");
    const ts   = a.publishedAt ? new Date(a.publishedAt).toLocaleString() : "";

    const card = document.createElement("article");
    card.className = "card";
    card.innerHTML = `
      <div class="meta"><span>${src}</span> ‚Ä¢ <span>${ts}</span></div>
      <h3 class="title"><a href="${url}" target="_blank" rel="noopener">${title}</a></h3>
      ${desc ? `<p class="desc">${desc}</p>` : ""}

      <div class="actions">
        <button class="action" data-act="fact" data-url="${url}">üîé Fact-check</button>
        <button class="action primary" data-act="ai" data-url="${url}">‚ú® AI Summary</button>
        <button class="action" data-act="share" data-url="${url}">üîó Share</button>
      </div>
    `;
    newsEl.appendChild(card);
  }
}

/* =========================
   FETCH
========================= */
async function fetchPage(reset=false){
  const base = getWorker();
  const params = new URLSearchParams();
  params.set("per", PAGE_SIZE);
  params.set("page", state.page);
  if(state.tag && state.tag !== "all") params.set("tag", state.tag);
  if(state.query) params.set("q", state.query);

  const url = `${base}/?${params.toString()}`;
  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    // data: { ok:true, articles:[...] }
    const list = Array.isArray(data.articles) ? data.articles : [];
    if(reset) state.items = list;
    else state.items = state.items.concat(list);
    render();
  }catch(err){
    console.error(err);
    toast("Couldn't load headlines. Check your Worker URL and logs.");
  }
}

/* =========================
   ACTIONS
========================= */
async function doFact(url){
  const base = getWorker();
  try{
    const res = await fetch(`${base}/factcheck?q=${encodeURIComponent(url)}`, {cache:"no-store"});
    if(!res.ok) throw new Error("factcheck failed");
    const data = await res.json(); // {claims:[...]} or {message}
    const win = window.open("", "_blank");
    win.document.write("<pre style='font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:12px;'>");
    win.document.write(esc(JSON.stringify(data, null, 2)));
    win.document.write("</pre>");
    win.document.close();
  }catch(e){
    toast("Fact-check unavailable for this item.");
  }
}
async function doAI(url){
  const base = getWorker();
  const res = await fetch(`${base}/ai?url=${encodeURIComponent(url)}`, {method:"POST"});
  const data = await res.json().catch(()=>({}));
  const text = data.summary || data.ai || "No summary.";
  const win = window.open("", "_blank");
  win.document.write("<div style='font:16px/1.55 system-ui; padding:18px; max-width:720px; margin:auto'>");
  win.document.write("<h2>AI Summary</h2><hr>");
  win.document.write(`<p>${esc(text)}</p>`);
  win.document.write("</div>");
  win.document.close();
}
async function doShare(url){
  if(navigator.share){
    try{ await navigator.share({title:"AIGLOBALNEWS", url}); }
    catch(e){ /* user cancelled */ }
  }else{
    try{
      await navigator.clipboard.writeText(url);
      toast("Link copied to clipboard.");
    }catch{
      prompt("Copy link", url);
    }
  }
}

/* =========================
   EVENTS
========================= */
document.addEventListener("click", (e)=>{
  const actBtn = e.target.closest("[data-act]");
  if(actBtn){
    const act = actBtn.dataset.act;
    const url = actBtn.dataset.url;
    if(act==="fact") doFact(url);
    if(act==="ai") doAI(url);
    if(act==="share") doShare(url);
  }
  const chip = e.target.closest(".chip");
  if(chip){
    [...$("#chips").children].forEach(c=>c.classList.remove("active"));
    chip.classList.add("active");
    state.tag = chip.dataset.tag;
    state.page = 0;
    fetchPage(true);
  }
});
$("#loadMoreBtn").addEventListener("click", ()=>{
  state.page += 1;
  fetchPage(false);
});
$("#refreshBtn").addEventListener("click", ()=>{
  state.page = 0;
  fetchPage(true);
});
$("#q").addEventListener("input", debounce(()=>{
  state.query = $("#q").value.trim();
  state.page = 0;
  fetchPage(true);
}, 350));

$("#settingsBtn").addEventListener("click", ()=>{
  const current = getWorker();
  const val = prompt("Cloudflare Worker base URL:", current || "");
  if(val){
    setWorker(val.replace(/\/+$/,""));
    state.page = 0;
    fetchPage(true);
  }
});

$("#themeBtn").addEventListener("click", ()=>{
  const cur = document.documentElement.style.getPropertyValue("color-scheme");
  // simple toggle by flipping prefers-color-scheme via class is messy; keep minimal (use body data attribute)
  document.body.dataset.flipTheme = document.body.dataset.flipTheme === "light" ? "dark" : "light";
  // purely cosmetic toggle by inverting colors via CSS variables could be added; keeping simple here
  toast("Theme toggled.");
});

/* =========================
   INIT
========================= */
(function init(){
  // ensure a default Worker is always present; avoids prompts across browsers
  if(!localStorage.getItem("workerBase")) setWorker(DEFAULT_WORKER);
  fetchPage(true);
})();

/* helper */
function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
</script>
</body>
</html>
