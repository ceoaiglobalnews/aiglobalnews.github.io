<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AIGLOBALNEWS ‚Äî UK Headlines, Verified & Summarised</title>

  <!-- SEO / Social -->
  <meta name="description" content="AIGLOBALNEWS curates top UK headlines with de-duplication, fact-checks, and concise AI summaries." />
  <meta name="theme-color" content="#0B1220" />
  <meta property="og:title" content="AIGLOBALNEWS ‚Äî UK Headlines, Verified & Summarised" />
  <meta property="og:description" content="Top UK headlines. De-duplicated. Fact-checked. Summarised." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.aiglobalnews.co.uk/" />
  <meta property="og:image" content="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'><rect width='1200' height='630' fill='%230B1220'/><text x='600' y='330' fill='%23fff' font-size='78' font-family='Inter,Arial' text-anchor='middle'>AIGLOBALNEWS</text><text x='600' y='400' fill='%2399E2FF' font-size='34' font-family='Inter,Arial' text-anchor='middle'>UK Headlines ‚Ä¢ Fact-checks ‚Ä¢ AI Summaries</text></svg>" />

  <!-- Favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="%230B1220"/><text x="16" y="22" font-size="16" text-anchor="middle" fill="%2399E2FF" font-family="Arial" font-weight="700">AI</text></svg>' />

  <!-- Tailwind (CDN) -->
  <script>tailwind={darkMode:'class'}</script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand-bg:#0B1220;         /* deep navy */
      --brand-bg-soft:#0F172A;    /* slate-ish */
      --brand-ink:#FFFFFF;
      --brand-accent:#1E90FF;     /* electric blue */
      --brand-accent-2:#99E2FF;   /* soft cyan */
      --brand-card:#0F182B;
    }
    .card{ @apply rounded-2xl border border-slate-200/70 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm hover:shadow transition; }
    .btn{ @apply inline-flex items-center gap-2 rounded-xl border px-3 py-2 text-sm font-semibold dark:border-slate-600 hover:shadow; }
    .btn-primary{ background:var(--brand-accent); color:white; border-color:transparent; }
    .btn-outline{ @apply border-slate-300 dark:border-slate-600; }
    .btn-icon{ @apply p-2 rounded-xl border dark:border-slate-600; }
    .badge{ @apply inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium border; }
    .muted{ @apply text-slate-500 dark:text-slate-400; }
    .skeleton{ @apply animate-pulse rounded-md bg-slate-200 dark:bg-slate-700; }
    .headline-link{ @apply decoration-2 hover:underline underline-offset-2; }
    .toolbar{ position:sticky; top:0; z-index:40; border-bottom:1px solid rgba(148,163,184,.25); backdrop-filter:blur(6px); }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .chip{ @apply px-3 py-1 rounded-full border text-[13px]; border-color:rgba(148,163,184,.5); }
    .chip.active{ background:var(--brand-accent); color:white; border-color:transparent; }
    @media (prefers-color-scheme: dark){
      .toolbar{ background:rgba(11,18,32,.86); }
      body{ background:var(--brand-bg-soft); }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-[var(--brand-bg)] dark:text-slate-100">
  <!-- Auto-upgrade to HTTPS when on your domain -->
  <script>
    (function(){
      const host = location.hostname.replace(/^www\./,'');
      const ours = ['aiglobalnews.co.uk','ceoaiglobalnews.github.io'];
      if (location.protocol==='http:' && ours.includes(host)) {
        location.replace(location.href.replace(/^http:/,'https:'));
      }
    })();
  </script>

  <!-- Header / Nav -->
  <header class="toolbar bg-white dark:bg-[rgba(11,18,32,.86)]">
    <div class="max-w-5xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex items-center gap-2 sm:gap-3">
      <a class="flex items-center gap-2 sm:gap-3" href="/" aria-label="AIGLOBALNEWS Home">
        <div class="h-9 w-9 sm:h-10 sm:w-10 rounded-xl grid place-items-center text-[var(--brand-accent-2)] font-black" style="background:var(--brand-bg);">AI</div>
        <span class="text-xl sm:text-2xl font-extrabold tracking-tight">AIGLOBALNEWS</span>
      </a>

      <!-- Categories (scrollable on mobile) -->
      <nav class="ml-2 sm:ml-4 flex-1 overflow-x-auto no-scrollbar">
        <div class="flex gap-2 sm:gap-3 text-[13px] sm:text-sm whitespace-nowrap" id="chips">
          <button class="chip active" data-chip="all">All</button>
          <button class="chip" data-chip="nhs">NHS</button>
          <button class="chip" data-chip="work">Workforce</button>
          <button class="chip" data-chip="digital">Digital</button>
          <button class="chip" data-chip="econ">Economy</button>
          <button class="chip" data-chip="politics">Politics</button>
        </div>
      </nav>

      <div class="ml-auto flex items-center gap-2">
        <label class="sr-only" for="q">Search headlines</label>
        <input id="q" type="search" inputmode="search" placeholder="Search‚Ä¶" class="w-[9rem] sm:w-56 md:w-72 border rounded-xl px-3 py-2 text-sm dark:bg-slate-900 dark:border-slate-700" />
        <button id="theme" class="btn-icon" title="Toggle theme" aria-pressed="false">üåì</button>
        <button id="refresh" class="btn-icon" title="Refresh">‚Üª</button>
      </div>
    </div>
  </header>

  <!-- Intro / Controls -->
  <section class="max-w-5xl mx-auto px-3 sm:px-4 pt-3 sm:pt-5">
    <div class="card p-3 sm:p-4">
      <p class="text-[13px] sm:text-sm">
        Top UK headlines (cached & de-duplicated). Tap <b>üîé Fact-check</b> for credibility sources and <b>‚ú® AI Summary</b> for quick context. One-click <b>üìù Republish</b> gives Markdown with attribution.
      </p>
      <div class="mt-3 flex flex-wrap items-center gap-3">
        <label class="text-sm">Sort</label>
        <select id="sortSel" class="border rounded-xl px-3 py-2 text-sm dark:bg-slate-900 dark:border-slate-700">
          <option value="latest">Latest</option>
          <option value="source">Source A‚ÄìZ</option>
          <option value="title">Title A‚ÄìZ</option>
        </select>
        <label class="text-sm ml-1">Show</label>
        <select id="pageSize" class="border rounded-xl px-3 py-2 text-sm dark:bg-slate-900 dark:border-slate-700">
          <option>20</option><option>40</option><option>80</option>
        </select>
        <span class="ml-auto text-xs muted">Brand: <span style="color:var(--brand-accent)">‚óè</span> Electric blue accents</span>
      </div>
    </div>
  </section>

  <!-- Article list -->
  <main class="max-w-5xl mx-auto px-3 sm:px-4 pt-3">
    <section id="list" class="grid gap-3 sm:gap-4" aria-live="polite"></section>
    <div id="pager" class="mt-4 flex justify-center">
      <button id="more" class="btn btn-outline">Load more</button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="max-w-5xl mx-auto px-3 sm:px-4 py-12 text-xs muted">
    <div class="flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
      <p>¬© <span id="yr"></span> AIGLOBALNEWS ‚Ä¢ Headlines aggregated from UK outlets; summaries are informational. Cite and link sources.</p>
      <p><a class="underline" href="/">Home</a></p>
    </div>
  </footer>

  <!-- Templates -->
  <template id="cardTpl">
    <article class="card p-3 sm:p-4" role="article">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <img class="h-5 w-5 rounded-sm border border-slate-200 dark:border-slate-700" alt="" aria-hidden="true" />
            <span class="text-[11px] sm:text-xs badge border-slate-300 dark:border-slate-600 source"></span>
            <time class="text-[11px] sm:text-xs muted pub"></time>
          </div>
          <h2 class="mt-1 font-bold text-base sm:text-lg leading-snug">
            <a class="headline headline-link break-words" target="_blank" rel="noopener"></a>
          </h2>
        </div>

        <!-- Action buttons (wrap on mobile) -->
        <div class="flex gap-2 flex-wrap justify-end shrink-0">
          <button class="btn btn-outline factBtn" aria-label="Fact-check">üîé <span class="hidden sm:inline">Fact-check</span></button>
          <button class="btn btn-primary aiBtn" aria-label="AI summary">‚ú® <span class="hidden sm:inline">AI Summary</span></button>
          <button class="btn btn-outline repubBtn" aria-label="Download Markdown">üìù <span class="hidden sm:inline">Republish</span></button>
          <button class="btn btn-outline shareBtn" aria-label="Share link">üîó <span class="hidden sm:inline">Share</span></button>
        </div>
      </div>

      <p class="mt-2 text-[13px] sm:text-sm leading-6 desc"></p>
      <div class="mt-3 hidden evidence space-y-3"></div>
    </article>
  </template>

  <template id="skelTpl">
    <div class="card p-3 sm:p-4">
      <div class="flex items-start gap-3">
        <div class="skeleton h-5 w-16"></div>
        <div class="skeleton h-5 w-24"></div>
      </div>
      <div class="skeleton h-5 sm:h-6 w-3/4 mt-3"></div>
      <div class="skeleton h-4 w-1/2 mt-2"></div>
      <div class="flex gap-2 mt-3">
        <div class="skeleton h-8 w-24"></div>
        <div class="skeleton h-8 w-24"></div>
        <div class="skeleton h-8 w-24"></div>
      </div>
    </div>
  </template>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-xl shadow bg-slate-900 text-white text-sm hidden" role="status" aria-live="polite"></div>

  <script>
    // =========================
    // CONFIG (hardcoded)
    // =========================
    const WORKER = "https://aiglobalnews-worker.bmbotelho.workers.dev";

    // =========================
    // Theme toggle
    // =========================
    const themeBtn = document.getElementById('theme');
    function applyTheme(){
      const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const saved = localStorage.getItem('theme') || 'auto';
      const dark = saved==='auto' ? prefers : (saved==='dark');
      document.documentElement.classList.toggle('dark', dark);
      themeBtn.setAttribute('aria-pressed', String(dark));
    }
    themeBtn.onclick = () => {
      const cur = localStorage.getItem('theme') || 'auto';
      const next = cur==='dark' ? 'light' : (cur==='light' ? 'auto' : 'dark');
      localStorage.setItem('theme', next);
      applyTheme();
      toast(`Theme: ${next}`);
    };
    applyTheme();

    // =========================
    // Helpers (placed BEFORE usage)
    // =========================
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const escapeHTML = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    const clean = html => (html||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
    const niceTime = d => { const dt=new Date(d); return dt.toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}); };
    const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),1600); }

    function norm(s){ return (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim(); }
    function dice(a,b){ const g=s=>{const t=norm(s);const out=[];for(let i=0;i<t.length-1;i++) out.push(t.slice(i,i+2));return out;}; const A=g(a),B=g(b); const map=new Map(); B.forEach(x=>map.set(x,(map.get(x)||0)+1)); let o=0; for(const x of A){const c=map.get(x); if(c){o++; map.set(x,c-1);} } return (2*o)/(A.length+B.length||1); }
    function fuzzyDedup(list,th=0.82){ const out=[],used=new Array(list.length).fill(false); for(let i=0;i<list.length;i++){ if(used[i])continue; const g=[list[i]]; used[i]=true; for(let j=i+1;j<list.length;j++){ if(used[j])continue; if(dice(list[i].title,list[j].title)>=th){used[j]=true; g.push(list[j]);}} g.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate)); out.push(g[0]); } return out; }
    function isDuplicateBlurb(title, blurb){ const t=norm(title), d=norm(blurb||''); if(!d) return true; if(t===d) return true; if(d.startsWith(t)||t.startsWith(d)) return true; return dice(t,d)>=0.90; }

    const LOGOS = {
      'bbc.co.uk':'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="#000"/><text x="50%" y="56%" fill="#fff" font-size="26" text-anchor="middle" font-family="Arial" font-weight="700">BBC</text></svg>',
      'theguardian.com':'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="#052962"/><text x="50%" y="56%" fill="#fff" font-size="24" text-anchor="middle" font-family="Georgia" font-weight="700">G</text></svg>',
      'independent.co.uk':'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="#b91c1c"/><text x="50%" y="56%" fill="#fff" font-size="20" text-anchor="middle" font-family="Georgia" font-weight="700">IND</text></svg>',
      'standard.co.uk':'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="#111827"/><text x="50%" y="56%" fill="#fff" font-size="16" text-anchor="middle" font-family="Georgia" font-weight="700">ES</text></svg>',
    };
    const logoFor = src => {
      const key = Object.keys(LOGOS).find(k=>src.includes(k));
      const svg = key?LOGOS[key]:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="#334155"/><text x="50%" y="56%" fill="#fff" font-size="16" text-anchor="middle" font-family="Arial" font-weight="700">NEWS</text></svg>';
      return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg);
    };

    // ---- Render helpers (moved ABOVE usage to avoid "not defined") ----
    function renderClaims(claims){
      return `<div class="border rounded-xl p-3 bg-slate-50/60 dark:bg-slate-800/60">
        <h4 class="font-semibold">Fact-checks found</h4>
        <div class="mt-2 space-y-2">${claims.map(c=>{
          const r=c.claimReview?.[0]||{};
          const rating=r.textualRating||'Assessment available';
          const pub=r.publisher?.name||'Fact-checker';
          const href=r.url||c.url||'#';
          return `<div class="p-2 border rounded-lg dark:border-slate-600">
            <div class="flex items-center justify-between gap-2">
              <div class="badge border-slate-300 dark:border-slate-600">${escapeHTML(pub)}</div>
              <div class="badge border-slate-300 dark:border-slate-600">${escapeHTML(rating)}</div>
            </div>
            <p class="mt-1 text-sm">${escapeHTML(c.text||'')}</p>
            <a class="text-sm underline" href="${href}" target="_blank" rel="noopener">Read review</a>
          </div>`;
        }).join('')}</div>
      </div>`;
    }
    function buildWikiBlock(w){
      return `<div class="border rounded-xl p-3">
        <div class="badge border-slate-300 dark:border-slate-600">Wikipedia</div>
        <p class="mt-2 text-sm">${escapeHTML(w.summary||'')}</p>
        <a class="text-sm underline" href="${w.url||'#'}" target="_blank" rel="noopener">Read on Wikipedia</a>
      </div>`;
    }
    function buildAIBlock(text){
      const t = (text || '').toString().trim();
      if (!t) return `<div class="text-sm muted">No AI summary available.</div>`;
      return `<div class="border rounded-xl p-3" style="background:linear-gradient(0deg, rgba(30,144,255,.08), rgba(30,144,255,.08))">
        <div class="badge" style="border-color:rgba(30,144,255,.4); color:var(--brand-accent)">AI credibility scan</div>
        <p class="mt-2 text-sm leading-6">${escapeHTML(t)}</p>
      </div>`;
    }

    // Wikipedia summary lookup (fallback context)
    async function wikiLookup(title){
      const q = encodeURIComponent(title);
      const s = await (await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${q}&format=json&origin=*`)).json();
      const top = s?.query?.search?.[0]; if(!top) return null;
      const page = encodeURIComponent(top.title);
      const d = await (await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${page}`)).json();
      return { title: top.title, url: d?.content_urls?.desktop?.page, summary: d?.extract };
    }

    const heuristic = t => t.split(/(?<=[.!?])\s+/).slice(0,4).join(' ');

    // =========================
    // State & bindings
    // =========================
    const state = { raw:[], cooked:[], page:1, filter:'all' };
    $('#yr').textContent = new Date().getFullYear();

    // chips
    $$('#chips .chip').forEach(btn=>{
      btn.onclick = ()=>{
        $$('#chips .chip').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        state.filter = btn.dataset.chip;
        state.page = 1; cook(); render();
      };
    });

    // search/sort/paging
    $('#q').addEventListener('input', debounce(()=>{ state.page=1; cook(); render(); }, 200));
    $('#sortSel').onchange = ()=>{ state.page=1; cook(); render(); };
    $('#pageSize').onchange = ()=>{ state.page=1; render(); };
    $('#more').onclick = ()=>{ state.page++; render(); };
    $('#refresh').onclick = ()=> reload();

    // =========================
    // Data load / cook / render
    // =========================
    async function reload(){
      showSkeletons(7);
      try{
        const r = await fetch(`${WORKER}/aggregate`, {cache:'no-store'});
        const j = await r.json();
        const items = (j?.items || j || []).map(x=>({
          ...x,
          pubDate: x.pubDate || x.pubdate || x.pub_date || x.date,
          source: x.source || new URL(x.link).hostname.replace(/^www\./,'')
        }));
        state.raw = items;
        state.page = 1;
        cook(); render();
        welcomeOnce();
      }catch(e){
        console.error(e);
        $('#list').innerHTML = `<div class="card p-4 text-red-600">Failed to load headlines: ${escapeHTML(e.message)}</div>`;
      }
    }

    function cook(){
      const deduped = fuzzyDedup(state.raw, 0.82);
      const q = $('#q').value.trim().toLowerCase();

      function filterByChip(a){
        const blob = (a.title+' '+(a.description||'')).toLowerCase();
        switch(state.filter){
          case 'nhs': return /\bnhs\b|hospital|patient|gp|waiting/.test(blob);
          case 'work': return /workforce|staff|recruit|retain|strike|union/.test(blob);
          case 'digital': return /\bai\b|digital|data|cyber|electronic|ehr|NHS App/.test(blob);
          case 'econ': return /inflation|gdp|economy|cost of living|budget/.test(blob);
          case 'politics': return /parliament|prime minister|tory|labour|election|policy/.test(blob);
          default: return true;
        }
      }

      let cooked = deduped.filter(a=>{
        const okChip = filterByChip(a);
        if(!q) return okChip;
        const blob = (a.title+' '+(a.description||'')+' '+a.source).toLowerCase();
        return okChip && blob.includes(q);
      });

      const sort = $('#sortSel').value;
      if (sort==='source') cooked.sort((a,b)=> (a.source||'').localeCompare(b.source||''));
      else if (sort==='title') cooked.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
      else cooked.sort((a,b)=> new Date(b.pubDate) - new Date(a.pubDate));

      state.cooked = cooked;
    }

    function render(){
      const container = $('#list');
      const pageSize = parseInt($('#pageSize').value,10);
      const end = state.page * pageSize;
      const slice = state.cooked.slice(0,end);

      container.innerHTML = '';
      const tpl = $('#cardTpl');

      slice.forEach(a=>{
        const frag = tpl.content.cloneNode(true);
        const article = frag.querySelector('article');
        article.dataset.article = JSON.stringify(a);

        const img = frag.querySelector('img');
        img.src = logoFor(a.source||'');
        img.alt = `${a.source||'News'} logo`;

        frag.querySelector('.source').textContent = a.source || '';
        const h = frag.querySelector('.headline');
        h.textContent = a.title || '';
        h.href = a.link || '#';
        const t = frag.querySelector('.pub');
        t.textContent = a.pubDate ? `¬∑ ${niceTime(a.pubDate)}` : '';

        const desc = clean(a.description);
        const descEl = frag.querySelector('.desc');
        if (desc && !isDuplicateBlurb(a.title, desc)) descEl.textContent = desc; else descEl.classList.add('hidden');

        container.appendChild(frag);
      });

      $('#pager').classList.toggle('hidden', state.cooked.length <= end);
    }

    function showSkeletons(n=6){
      const container = $('#list');
      const tpl = $('#skelTpl');
      container.innerHTML = '';
      for(let i=0;i<n;i++) container.appendChild(tpl.content.cloneNode(true));
    }

    // =========================
    // Actions (delegated)
    // =========================
    $('#list').addEventListener('click', async (e)=>{
      const card = e.target.closest('article'); if(!card) return;
      const a = JSON.parse(card.dataset.article||'{}');
      const panel = card.querySelector('.evidence');

      if (e.target.closest('.factBtn')) {
        e.preventDefault(); await doFactCheck(a, panel);
      } else if (e.target.closest('.aiBtn')) {
        e.preventDefault(); const btn=e.target.closest('button'); await doAISummary(btn, a, panel);
      } else if (e.target.closest('.repubBtn')) {
        e.preventDefault(); doRepublish(a); toast('Markdown downloaded.');
      } else if (e.target.closest('.shareBtn')) {
        e.preventDefault(); try{ await navigator.clipboard.writeText(`${a.title} ‚Äî ${a.source}\n${a.link}`); toast('Link copied.'); }catch{ toast('Copy failed.'); }
      }
    });

    async function doFactCheck(article, panel){
      panel.classList.remove('hidden');
      panel.innerHTML = '<div class="text-sm muted">Checking‚Ä¶</div>';
      try{
        let res = await fetch(`${WORKER}/factcheck?q=${encodeURIComponent(article.title)}`);
        let data = await res.json().catch(()=>({}));
        if(!data.wiki){ try{ data.wiki = await wikiLookup(article.title); }catch{} }

        const blocks=[];
        if (data?.claims?.length) blocks.push(renderClaims(data.claims));
        else blocks.push('<div class="text-sm">No direct matches in Google Fact Check Tools.</div>');
        if (data?.wiki?.summary) blocks.push(buildWikiBlock(data.wiki));
        if (data?.ai) blocks.push(buildAIBlock(data.ai));

        panel.innerHTML = blocks.join('\n');
      }catch(err){
        console.error(err);
        panel.innerHTML = `<div class="text-sm text-red-600">Fact-check failed: ${escapeHTML(err.message)}</div>`;
      }
    }

    async function doAISummary(btn, article, panel){
      panel.classList.remove('hidden');
      panel.innerHTML = '<div class="text-sm muted">Summarising‚Ä¶</div>';
      const prev = btn.textContent; btn.disabled=true; btn.textContent='Summarising‚Ä¶';
      try{
        const body = {text: (article.title+'\n\n'+clean(article.description)).slice(0, 3000)};
        let sum='';
        try{
          const r = await fetch(`${WORKER}/summarize`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
          const j = await r.json().catch(()=>({}));
          if(r.ok && (j.summary||'').trim()) sum = j.summary; else throw new Error(j.error||`HTTP ${r.status}`);
        }catch{
          const r2 = await fetch(`${WORKER}/summary?q=${encodeURIComponent(article.title)}`);
          const j2 = await r2.json().catch(()=>({}));
          if(r2.ok && (j2.summary||'').trim()) sum = j2.summary;
          else sum = heuristic(article.title+' '+clean(article.description));
        }
        panel.innerHTML = buildAIBlock(sum);
      }catch(err){
        console.error(err);
        panel.innerHTML = `<div class="text-sm text-red-600">AI summary failed: ${escapeHTML(err.message)}</div>`;
      }finally{
        btn.disabled=false; btn.textContent=prev;
      }
    }

    function doRepublish(a){
      const pubISO = new Date(a.pubDate||Date.now()).toISOString();
      const md = `# ${a.title}\n\n> Source: [${a.source}](${a.link})  \\\nPublished: ${pubISO}\n\n**Summary (from RSS):**\n\n${clean(a.description)}\n\n**Fact-check notes:** Add verdicts and links from reputable fact-checkers.\n`;
      const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const dn = `${a.title}`.replace(/[^a-z0-9\-\s\[\]\(\)\._]/gi,'_').slice(0,100)+'.md';
      const el=document.createElement('a'); el.href=url; el.download=dn; el.click(); URL.revokeObjectURL(url);
    }

    function welcomeOnce(){
      if (sessionStorage.getItem('welcomed')) return;
      toast('Tip: tap üîé Fact-check or ‚ú® AI Summary on any headline.'); sessionStorage.setItem('welcomed','1');
    }

    // Boot
    (function boot(){ showSkeletons(7); reload(); })();
  </script>
</body>
</html>
