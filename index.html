<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AIGLOBALNEWS ‚Äî UK Headlines</title>

  <!-- üîí Hardcoded Worker base: never ask the user again -->
  <meta name="worker-base" content="https://aiglobalnews-worker.bmbotelho.workers.dev/">

  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

  <style>
    :root{
      --bg: #0b1220; --card:#111a2b; --muted:#93a4c8; --text:#e9eefc; --brand:#4c8dff; --pill:#1c2842; --ok:#35c27e; --warn:#ffcc66; --link:#9bbcff; --border:#22304d;
    }
    :root.light{
      --bg:#ffffff; --card:#ffffff; --muted:#5a6a85; --text:#111a2b; --brand:#2257d8; --pill:#e9f0ff; --ok:#1fa36c; --warn:#9a6a00; --link:#1b4ed8; --border:#e5e7ef;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:860px;margin:0 auto;padding:16px 16px 80px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;font-size:20px;letter-spacing:.3px}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--brand),#7aa6ff);display:grid;place-items:center;color:#fff;font-weight:900}
    .controls{display:flex;gap:8px;align-items:center}
    .iconbtn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;padding:10px;line-height:0;cursor:pointer}
    .iconbtn:active{transform:scale(.98)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .chip{border:1px solid var(--border);background:var(--pill);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .chip.active{outline:2px solid color-mix(in oklab, var(--brand) 60%, transparent)}
    .searchbar{display:flex;gap:8px;margin:8px 0 12px}
    .searchbar input{flex:1;border:1px solid var(--border);background:var(--card);color:var(--text);padding:12px 14px;border-radius:12px;outline:none}
    .btn{border:1px solid var(--border);background:var(--pill);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.brand{background:var(--brand);border-color:transparent;color:#fff}
    .hint{border:1px dashed var(--border);background:var(--card);color:var(--muted);padding:10px 12px;border-radius:12px;font-size:14px}
    .card{border:1px solid var(--border);background:var(--card);border-radius:18px;padding:14px 14px 10px;margin:12px 0}
    .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px;margin-bottom:6px}
    .title{font-weight:800;font-size:18px;margin:6px 0 4px}
    .desc{color:var(--muted);font-size:14px;margin:0 0 8px}
    .actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    .action{border:1px solid var(--border);background:var(--pill);color:var(--text);padding:10px 10px;border-radius:12px;cursor:pointer;text-align:center;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .action.brand{background:var(--brand);border-color:transparent;color:#fff}
    .panel{margin-top:10px;border:1px solid var(--border);background:var(--bg);border-radius:14px;padding:12px;display:none}
    .panel.show{display:block}
    .panel h4{margin:0 0 8px;font-size:14px;color:var(--muted)}
    .muted{color:var(--muted)}
    .center{display:grid;place-items:center;margin:16px 0}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);padding:10px 14px;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.28);color:var(--text);z-index:50;opacity:0;pointer-events:none;transition:.2s}
    .toast.show{opacity:1}
    .footer{color:var(--muted);font-size:12px;margin-top:16px;text-align:center}
    @media (max-width:560px){
      .title{font-size:17px}
      .actions{grid-template-columns:repeat(2,1fr)} /* two-per-row on phones */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AI</div>
        <div>AIGLOBALNEWS</div>
      </div>
      <div class="controls">
        <button id="themeBtn" class="iconbtn" title="Dark / Light">üåó</button>
        <button id="refreshBtn" class="iconbtn" title="Refresh">‚ü≥</button>
      </div>
    </header>

    <div class="chips" id="chips">
      <button class="chip active" data-cat="all">All</button>
      <button class="chip" data-cat="nhs">NHS</button>
      <button class="chip" data-cat="workforce">Workforce</button>
      <button class="chip" data-cat="digital">Digital</button>
      <button class="chip" data-cat="economy">Economy</button>
      <button class="chip" data-cat="politics">Politics</button>
    </div>

    <div class="searchbar">
      <input id="q" placeholder="Search headlines‚Ä¶" inputmode="search" />
      <button id="go" class="btn">Refresh</button>
    </div>

    <div class="hint">UK headlines (cached & de-duplicated). Tap üîé <b>Fact-check</b> for sources, ‚ú® <b>AI Summary</b> for quick context. üñáÔ∏è <b>Copy</b> copies URL, and <b>Share</b> opens native share.</div>

    <div id="news"></div>
    <div class="center"><button id="more" class="btn brand">Load more</button></div>

    <div class="footer">¬© AIGLOBALNEWS ¬∑ Summaries are informational. Always cite and link sources.</div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ---------- Theme persistence ---------- */
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') root.classList.add('light');
    themeBtn.addEventListener('click', () => {
      root.classList.toggle('light');
      localStorage.setItem('theme', root.classList.contains('light') ? 'light' : 'dark');
    });

    /* ---------- Worker base (hardcoded, no prompts) ---------- */
    const WORKER_BASE =
      document.querySelector('meta[name="worker-base"]')?.content
      || "https://aiglobalnews-worker.bmbotelho.workers.dev/"; // fallback

    /* ---------- State ---------- */
    let page = 1;
    const per = 20;
    let currentCat = 'all';
    let currentQ = '';
    const newsEl = document.getElementById('news');
    const moreBtn = document.getElementById('more');

    /* ---------- Tiny utils ---------- */
    const toast = (msg) => {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1400);
    };
    const fmtDate = (iso) => {
      try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
      } catch { return '' }
    };

    /* ---------- Fetch + Render ---------- */
    async function fetchNews({ reset=false } = {}) {
      if (reset) { page = 1; newsEl.innerHTML = ''; }
      const catParam = currentCat && currentCat!=='all' ? `&cat=${encodeURIComponent(currentCat)}` : '';
      const qParam   = currentQ ? `&q=${encodeURIComponent(currentQ)}` : '';
      const url = `${WORKER_BASE}?per=${per}&page=${page}${catParam}${qParam}`;

      try {
        const res = await fetch(url, { headers: { 'accept':'application/json' }});
        const data = await res.json();

        // Support either {items:[...]} or array [...]
        const items = Array.isArray(data) ? data : (data.items || []);
        if (!items.length && page===1) {
          newsEl.innerHTML = `<p class="muted">No headlines found.</p>`;
          return;
        }

        for (const it of items) newsEl.appendChild(renderCard(it));
        page++;
      } catch (err) {
        newsEl.innerHTML = `<p style="color:#ff6969">‚ö†Ô∏è Couldn‚Äôt load headlines from ${WORKER_BASE}. Check logs.</p>`;
        console.error(err);
      }
    }

    function renderCard(item) {
      const { link, title, description, source, pubDate } = normalize(item);

      const wrap = document.createElement('article');
      wrap.className = 'card';
      wrap.innerHTML = `
        <div class="meta"><span>${source}</span> ¬∑ <span class="muted">${fmtDate(pubDate)}</span></div>
        <div class="title"><a href="${link}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a></div>
        <p class="desc">${escapeHtml(description || '')}</p>

        <div class="actions">
          <button class="action" data-act="fact"    title="Fact-check">üîé Fact-check</button>
          <button class="action brand" data-act="sum"     title="AI Summary">‚ú® AI Summary</button>
          <button class="action" data-act="copy"    title="Copy link">üñáÔ∏è Copy</button>
          <button class="action" data-act="share"   title="Share">üì§ Share</button>
        </div>

        <div class="panel" hidden>
          <h4 class="muted">Result</h4>
          <div class="panel-body muted">Loading‚Ä¶</div>
        </div>
      `;

      // Delegated click handling
      wrap.querySelector('.actions').addEventListener('click', async (e) => {
        const btn = e.target.closest('.action');
        if (!btn) return;
        const act = btn.dataset.act;
        if (act === 'copy') {
          await navigator.clipboard.writeText(link);
          toast('Link copied');
        } else if (act === 'share') {
          if (navigator.share) {
            try { await navigator.share({ title, text: title, url: link }); }
            catch {}
          } else {
            await navigator.clipboard.writeText(link);
            toast('Share not supported ‚Äî link copied');
          }
        } else if (act === 'fact' || act === 'sum') {
          const panel = wrap.querySelector('.panel');
          const body  = wrap.querySelector('.panel-body');
          // toggle open/close
          if (panel.classList.contains('show')) {
            panel.classList.remove('show'); panel.hidden = true; return;
          }
          panel.hidden = false; panel.classList.add('show');
          body.textContent = 'Loading‚Ä¶';
          try {
            const endpoint = act === 'fact'
              ? `${WORKER_BASE}factcheck?q=${encodeURIComponent(title)}`
              : `${WORKER_BASE}summary?url=${encodeURIComponent(link)}`;
            const r = await fetch(endpoint);
            const j = await r.json();
            body.innerHTML = renderResult(act, j);
          } catch (err) {
            body.innerHTML = `<span style="color:#ff8080">Failed to load (${act}).</span>`;
          }
        }
      });

      return wrap;
    }

    function renderResult(act, j){
      // Try to be flexible with Worker outputs
      if (act==='fact'){
        if (j && j.claims && j.claims.length){
          const rows = j.claims.slice(0,5).map(c=>(
            `<div style="margin:.2rem 0">
              <div><b>${escapeHtml(c.text || c.claim || 'Claim')}</b></div>
              <div class="muted">${escapeHtml(c.publisher || c.site || '')} ¬∑ ${escapeHtml(c.rating || '')}</div>
              ${c.url ? `<div><a href="${c.url}" target="_blank" rel="noopener">Source</a></div>` : ``}
            </div>`
          )).join('');
          return rows || '<span class="muted">No details.</span>';
        }
        if (j && j.wiki) {
          return `<div><b>Wikipedia</b><div class="muted">${escapeHtml(j.wiki)}</div></div>`;
        }
        return `<span class="muted">No direct matches in Google Fact Check Tools.</span>`;
      } else {
        const txt = j && (j.summary || j.ai || j.text || '');
        return txt ? escapeHtml(txt) : `<span class="muted">No summary available.</span>`;
      }
    }

    function normalize(it){
      // Try to handle multiple shapes from Worker
      return {
        link: it.link || it.url || '#',
        title: it.title || it.headline || '',
        description: it.description || it.excerpt || '',
        source: it.source || it.site || new URL(it.link || it.url || 'https://example.com').hostname.replace(/^www\./,''),
        pubDate: it.pubDate || it.date || it.publishedAt || new Date().toISOString()
      }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])) }

    /* ---------- Interactions ---------- */
    document.getElementById('go').addEventListener('click', () => {
      currentQ = document.getElementById('q').value.trim();
      fetchNews({ reset:true });
    });
    document.getElementById('refreshBtn').addEventListener('click', () => fetchNews({ reset:true }));
    moreBtn.addEventListener('click', () => fetchNews());

    document.getElementById('chips').addEventListener('click', (e) => {
      const chip = e.target.closest('.chip'); if (!chip) return;
      for (const c of document.querySelectorAll('.chip')) c.classList.remove('active');
      chip.classList.add('active');
      currentCat = chip.dataset.cat;
      fetchNews({ reset:true });
    });

    /* ---------- Initial load ---------- */
    fetchNews({ reset:true });
  </script>
</body>
</html>
