<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>AIGLOBALNEWS — UK headlines, verified & summarised</title>
  <meta name="theme-color" content="#0B1220"/>
  <script>tailwind={darkMode:'class'}</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg:#0B1220;--card:#0F172A;--fg:#E6EDF3;--mut:#9AA4B2;--border:rgba(148,163,184,.25);--acc:#1E90FF;--ring:rgba(30,144,255,.35)}
    .bar{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(10px);background:rgba(11,18,32,.78);border-bottom:1px solid rgba(148,163,184,.18)}
    .news{border:1px solid var(--border);border-radius:16px;transition:.15s box-shadow,.15s transform}
    .news:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(2,6,23,.18)}
    .seg{display:flex;flex-wrap:wrap;gap:.5rem;background:rgba(148,163,184,.10);border:1px solid var(--border);padding:.5rem;border-radius:12px}
    .seg .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.62rem .85rem;border-radius:10px;font-weight:700;font-size:.9rem;border:1px solid transparent;background:#111827;color:#fff}
    .seg .btn.primary{background:var(--acc)}
    .evi{border:1px solid var(--border);border-radius:14px}
    .evi-hd{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.55rem .75rem;border-bottom:1px solid rgba(148,163,184,.2)}
    .evi-bd{padding:.85rem}
    .iconbtn{border:1px solid var(--border);padding:.45rem .55rem;border-radius:10px}
    .iconbtn:hover{box-shadow:0 0 0 3px var(--ring)}
    .skel{background:linear-gradient(90deg,#1f2937 25%,#293548 37%,#1f2937 63%);background-size:400% 100%;animation:s 1.2s ease-in-out infinite;border-radius:8px}
    @keyframes s{0%{background-position:100% 0}100%{background-position:-100% 0}}
  </style>
</head>
<body class="bg-[var(--bg)] text-[var(--fg)]">
<header class="bar">
  <div class="max-w-7xl mx-auto px-3 sm:px-4 py-2.5 flex items-center gap-3">
    <button id="homeBtn" class="flex items-center gap-2" type="button" aria-label="Home">
      <div class="h-9 w-9 rounded-xl grid place-items-center font-black text-white" style="background:var(--acc)">AI</div>
      <div class="text-xl sm:text-2xl font-extrabold tracking-tight">AIGLOBALNEWS</div>
    </button>
    <div class="ml-2 flex-1 overflow-x-auto no-scroll">
      <div class="flex gap-2 whitespace-nowrap text-sm" id="chips">
        <button class="chip px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900 active" data-chip="all">All</button>
        <button class="chip px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900" data-chip="nhs">NHS</button>
        <button class="chip px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900" data-chip="work">Workforce</button>
        <button class="chip px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900" data-chip="digital">Digital</button>
        <button class="chip px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900" data-chip="econ">Economy</button>
        <button class="chip px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-900" data-chip="politics">Politics</button>
      </div>
    </div>
    <div class="flex items-center gap-2 shrink-0">
      <input id="q" type="search" placeholder="Search headlines…" class="hidden md:block w-72 px-3 py-2 text-sm rounded-lg border border-slate-700 bg-slate-900"/>
      <button id="openAll" class="iconbtn" title="Open/close all">📂</button>
      <button id="theme" class="iconbtn" title="Dark/Light">🌓</button>
      <button id="refresh" class="iconbtn" title="Refresh">↻</button>
    </div>
  </div>
</header>

<div class="max-w-7xl mx-auto px-3 sm:px-4 pt-4">
  <section class="rounded-2xl border border-slate-700 bg-slate-900 p-3 sm:p-4">
    <div class="text-sm opacity-90">UK headlines (cached & de-duplicated). Use <b>🔎 Fact-check</b> & <b>✨ AI Summary</b>; <b>📝 Republish</b> downloads Markdown; <b>🔗 Share</b> opens native share.</div>
  </section>

  <section id="list" class="grid gap-3 sm:gap-4 mt-4" aria-live="polite"></section>

  <div id="pager" class="mt-6 mb-20 lg:mb-8 flex justify-center">
    <button id="more" class="px-4 py-2 rounded-lg border border-slate-600">Load more</button>
  </div>
</div>

<!-- Templates -->
<template id="cardTpl">
  <article class="news p-3 sm:p-4 bg-slate-900">
    <div class="min-w-0">
      <div class="flex items-center gap-2">
        <span class="text-xs opacity-70 source"></span>
        <time class="text-[12px] opacity-70 pub"></time>
      </div>
      <h2 class="mt-1 font-bold text-[1.06rem] sm:text-[1.18rem] leading-snug">
        <a class="headline underline-offset-4 hover:underline break-words" target="_blank" rel="noopener"></a>
      </h2>
      <p class="mt-2 text-[13.5px] leading-6 desc"></p>
    </div>

    <div class="mt-3 seg">
      <button class="btn factBtn" type="button" aria-label="Toggle fact-check"><span>🔎</span><span>Fact-check</span></button>
      <button class="btn primary aiBtn" type="button" aria-label="Toggle AI summary"><span>✨</span><span>AI Summary</span></button>
      <button class="btn repubBtn" type="button" aria-label="Download Markdown"><span>📝</span><span>Republish</span></button>
      <button class="btn shareBtn" type="button" aria-label="Share link"><span>🔗</span><span>Share</span></button>
    </div>

    <div class="mt-3 hidden evidence">
      <div class="evi">
        <div class="evi-hd">
          <div class="text-sm font-semibold">Evidence</div>
          <div class="flex items-center gap-2">
            <a class="text-xs underline hidden extLink" target="_blank" rel="noopener">Open source</a>
            <button class="iconbtn closePane text-xs px-2 py-1" type="button">Close</button>
          </div>
        </div>
        <div class="evi-bd space-y-3 body"></div>
      </div>
    </div>
  </article>
</template>

<template id="skelTpl">
  <div class="news p-3 sm:p-4 bg-slate-900">
    <div class="skel h-4 w-24"></div>
    <div class="skel h-5 w-3/4 mt-3"></div>
    <div class="skel h-4 w-1/2 mt-2"></div>
    <div class="mt-3 seg"><div class="skel h-9 w-28"></div><div class="skel h-9 w-28"></div><div class="skel h-9 w-28"></div></div>
  </div>
</template>

<div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-xl shadow bg-slate-900 text-white text-sm hidden" role="status" aria-live="polite"></div>

<script>
/* ===== CONFIG ===== */
const WORKER = (localStorage.getItem('worker') || "https://aiglobalnews-worker.bmbotelho.workers.dev").trim();

/* ===== THEME ===== */
const themeBtn = document.getElementById('theme');
function applyTheme(){
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.classList.toggle('dark', saved !== 'light');
  themeBtn.textContent = saved==='light'?'☀️':'🌓';
}
themeBtn.onclick = () => {
  const cur = localStorage.getItem('theme') || 'dark';
  const next = cur==='light' ? 'dark' : 'light';
  localStorage.setItem('theme', next); applyTheme();
};
applyTheme();

/* ===== UTILS ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const escapeHTML=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
const clean=html=>(html||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
const niceTime=d=>{const dt=new Date(d);return dt.toLocaleString('en-GB',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})};
function toast(msg){const el=$('#toast');el.textContent=msg;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),1600)}

/* ===== STATE ===== */
const state={raw:[],cooked:[],page:1,filter:'all',openAll:false}
document.getElementById('openAll').onclick=()=>{state.openAll=!state.openAll; $$('#list .evidence').forEach(p=>p.classList.toggle('hidden',!state.openAll))};
document.getElementById('refresh').onclick=reload;
document.getElementById('homeBtn').onclick=()=>{ state.filter='all'; state.page=1; $('#q').value=''; cook(); render(); toast('Filters reset'); };
$$('#chips .chip').forEach(b=>b.onclick=()=>{ $$('#chips .chip').forEach(x=>x.classList.toggle('active',x===b)); state.filter=b.dataset.chip; state.page=1; cook(); render(); });
$('#q').addEventListener('input',()=>{ state.page=1; cook(); render(); });
$('#more').onclick=()=>{ state.page++; render(); };

/* ===== FETCH / COOK / RENDER ===== */
async function reload(){
  showSkeletons(8);
  if(!/^https:\/\//.test(WORKER)){
    $('#list').innerHTML = `<div class="news p-4"><div class="font-semibold mb-1">Worker URL not set</div>
    <div class="text-sm opacity-80">Set it and reload:</div>
    <pre class="mt-2 text-xs bg-slate-800 p-2 rounded">localStorage.setItem('worker','https://YOUR-WORKER.workers.dev'); location.reload();</pre></div>`;
    return;
  }
  try{
    const r=await fetch(`${WORKER}/aggregate`,{cache:'no-store'});
    if(!r.ok) throw new Error(`Worker ${r.status}`);
    const j=await r.json();
    const items=(j?.items||j||[]).map(x=>({
      ...x,
      pubDate:x.pubDate||x.pubdate||x.pub_date||x.date||Date.now(),
      source:(x.source||new URL(x.link).hostname.replace(/^www\./,'')).toLowerCase()
    }));
    state.raw=items; state.page=1; cook(); render();
  }catch(e){
    $('#list').innerHTML=`<div class="news p-4"><div class="text-red-500 font-semibold mb-1">Couldn’t load headlines</div>
    <div class="text-sm opacity-80 mb-3">${escapeHTML(e.message||'Network error')}</div>
    <button id="retry" class="px-3 py-2 rounded-lg border border-slate-600">Retry</button></div>`;
    $('#retry').onclick=reload;
  }
}
function cook(){
  const q = ($('#q').value||'').toLowerCase();
  const chip = state.filter;
  const inChip=t=>{
    const b=(t.title+' '+(t.description||'')).toLowerCase();
    if(chip==='nhs') return /\bnhs\b|hospital|patient|gp|waiting/.test(b);
    if(chip==='work') return /workforce|staff|recruit|retain|strike|union/.test(b);
    if(chip==='digital') return /\bai\b|digital|data|cyber|ehr|app/.test(b);
    if(chip==='econ') return /inflation|gdp|economy|budget|living/.test(b);
    if(chip==='politics') return /parliament|prime|minister|election|policy|tory|labour/.test(b);
    return true;
  };
  let data=[...state.raw].filter(a=>inChip(a) && (!q || (a.title+' '+(a.description||'')+' '+a.source).toLowerCase().includes(q)));
  data.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
  state.cooked=data;
}
function render(){
  const wrap=$('#list');const pageSize=20;const end=state.page*pageSize;const slice=state.cooked.slice(0,end);
  wrap.innerHTML='';
  if(!slice.length){ wrap.innerHTML=`<div class="news p-4 text-sm">No headlines match. Try clearing search.</div>`; $('#pager').classList.add('hidden'); return; }
  const tpl=$('#cardTpl');
  slice.forEach(a=>{
    const frag=tpl.content.cloneNode(true);const el=frag.querySelector('article');el.dataset.article=JSON.stringify(a);
    frag.querySelector('.source').textContent=a.source||'';const h=frag.querySelector('.headline');h.textContent=a.title||'';h.href=a.link||'#';
    frag.querySelector('.pub').textContent=a.pubDate?`· ${niceTime(a.pubDate)}`:'';
    const d=clean(a.description); const desEl=frag.querySelector('.desc'); if(d) desEl.textContent=d; else desEl.classList.add('hidden');
    const panel=frag.querySelector('.evidence'); if(state.openAll) panel.classList.remove('hidden');
    frag.querySelector('.extLink').href = a.link || '#';
    wrap.appendChild(frag);
  });
  $('#pager').classList.toggle('hidden',state.cooked.length<=end);
}
function showSkeletons(n=6){const wrap=$('#list'),tpl=$('#skelTpl');wrap.innerHTML='';for(let i=0;i<n;i++)wrap.appendChild(tpl.content.cloneNode(true))}

/* ===== ACTIONS ===== */
$('#list').addEventListener('click',async e=>{
  const card=e.target.closest('article'); if(!card) return;
  const a=JSON.parse(card.dataset.article||'{}');
  const container = card.querySelector('.evidence');
  const body = card.querySelector('.evi .body');
  const ext = card.querySelector('.evi .extLink');

  if(e.target.closest('.closePane')){ container.classList.add('hidden'); return; }

  if(e.target.closest('.factBtn')){
    if(!container.classList.contains('hidden') && body.dataset.kind==='fact'){ container.classList.add('hidden'); return; }
    container.classList.remove('hidden'); body.dataset.kind='fact'; ext.classList.remove('hidden'); await doFactCheck(a, body);
  } else if(e.target.closest('.aiBtn')){
    if(!container.classList.contains('hidden') && body.dataset.kind==='ai'){ container.classList.add('hidden'); return; }
    container.classList.remove('hidden'); body.dataset.kind='ai'; ext.classList.add('hidden'); await doAISummary(e.target.closest('button'), a, body);
  } else if(e.target.closest('.repubBtn')){
    doRepublish(a); toast('Markdown downloaded.');
  } else if(e.target.closest('.shareBtn')){
    await doShare(a);
  }
});

async function doFactCheck(article, body){
  body.innerHTML='<div class="text-sm opacity-80">Checking…</div>';
  try{
    const r=await fetch(`${WORKER}/factcheck?q=${encodeURIComponent(article.title)}`);
    const data=await r.json().catch(()=>({}));
    const blocks=[];
    if(data?.claims?.length){
      blocks.push(`<div class="evi"><div class="evi-bd space-y-3">${
        data.claims.map(c=>{
          const r=c.claimReview?.[0]||{}; const rating=r.textualRating||'Assessment';
          const pub=r.publisher?.name||'Fact-checker'; const href=r.url||c.url||'#';
          return `<div class="border border-slate-700 rounded-lg p-2">
            <div class="flex items-center justify-between gap-2"><span class="text-xs">${escapeHTML(pub)}</span><span class="text-xs">${escapeHTML(rating)}</span></div>
            <p class="mt-1 text-sm">${escapeHTML(c.text||'')}</p><a class="text-sm underline" href="${href}" target="_blank" rel="noopener">Read review</a>
          </div>`
        }).join('')
      }</div></div>`);
    }else{
      blocks.push('<div class="evi"><div class="evi-bd text-sm">No direct matches in Google Fact Check Tools.</div></div>');
    }
    if(data?.wiki?.summary){
      blocks.push(`<div class="evi"><div class="evi-bd"><div class="text-xs opacity-70">Wikipedia</div><p class="mt-2 text-sm leading-6">${escapeHTML(data.wiki.summary)}</p><a class="text-sm underline" href="${data.wiki.url||'#'}" target="_blank" rel="noopener">Read on Wikipedia</a></div></div>`);
    }
    if(data?.ai){
      blocks.push(`<div class="evi" style="background:linear-gradient(0deg, rgba(30,144,255,.06), rgba(30,144,255,.06))"><div class="evi-bd"><div class="text-xs" style="color:var(--acc)">AI credibility scan</div><p class="mt-2 text-sm leading-6">${escapeHTML(data.ai)}</p></div></div>`);
    }
    body.innerHTML=blocks.join('\n');
  }catch(err){
    body.innerHTML=`<div class="evi"><div class="evi-bd text-sm text-red-400">Fact-check failed: ${escapeHTML(err.message)}</div></div>`;
  }
}

async function doAISummary(btn, article, body){
  const prev=btn.textContent; btn.disabled=true; btn.textContent='Summarising…';
  body.innerHTML='<div class="text-sm opacity-80">Summarising…</div>';
  try{
    const payload={text:(article.title+'\n\n'+clean(article.description)).slice(0,3000)};
    let sum='';
    try{
      const r=await fetch(`${WORKER}/summarize`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json().catch(()=>({})); if(r.ok&&(j.summary||'').trim()) sum=j.summary; else throw new Error(j.error||`HTTP ${r.status}`);
    }catch{
      const r2=await fetch(`${WORKER}/summary?q=${encodeURIComponent(article.title)}`); const j2=await r2.json().catch(()=>({}));
      if(r2.ok&&(j2.summary||'').trim()) sum=j2.summary; else sum=article.title;
    }
    body.innerHTML=`<div class="evi" style="background:linear-gradient(0deg, rgba(30,144,255,.06), rgba(30,144,255,.06))"><div class="evi-bd"><div class="text-xs" style="color:var(--acc)">AI summary</div><p class="mt-2 text-sm leading-6">${escapeHTML(sum)}</p></div></div>`;
  }catch(err){
    body.innerHTML=`<div class="evi"><div class="evi-bd text-sm text-red-400">AI summary failed: ${escapeHTML(err.message)}</div></div>`;
  }finally{ btn.disabled=false; btn.textContent=prev; }
}

function doRepublish(a){
  const md=`# ${a.title}\n\n> Source: [${a.source}](${a.link})\n\n${clean(a.description)}`;
  const blob=new Blob([md],{type:'text/markdown;charset=utf-8'});const url=URL.createObjectURL(blob);
  const dn=`${a.title}`.replace(/[^a-z0-9\-\s\[\]\(\)\._]/gi,'_').slice(0,100)+'.md'; const el=document.createElement('a'); el.href=url; el.download=dn; el.click(); URL.revokeObjectURL(url);
}

async function doShare(a){
  const title=(a?.title||'AIGLOBALNEWS').slice(0,120);
  const url=a?.link||location.href;
  const text=`${title}${a?.source?` — ${a.source}`:''}`;

  if(navigator.share){
    try{
      if(!navigator.canShare || navigator.canShare({title,text,url})){
        await navigator.share({title,text,url}); toast('Share opened'); return;
      }
    }catch(err){ if(err?.name==='AbortError') return; }
  }
  try{
    if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(`${text}\n${url}`); toast('Link copied'); return; }
  }catch{}
  try{
    const ta=document.createElement('textarea'); ta.value=`${text}\n${url}`; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.top='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast('Link copied'); return;
  }catch{}
  const subj=encodeURIComponent(title), body=encodeURIComponent(`${text}\n${url}`); location.href=`mailto:?subject=${subj}&body=${body}`;
}

/* ===== BOOT ===== */
function boot(){ applyTheme(); showSkeletons(8); reload(); }
document.addEventListener('DOMContentLoaded', boot);
setTimeout(()=>{ if(!state.raw.length){ try{ reload(); }catch{} } }, 1200);
</script>
</body>
</html>
<!-- Site Status Badge -->
<div id="site-status" style="
  background: #ffcc00;
  color: #000;
  text-align: center;
  padding: 10px;
  font-size: 14px;
  font-weight: bold;
">
  ⏳ Setting up secure connection... DNS/SSL propagation may take up to 24–48h.
</div>

<script>
  async function checkSiteStatus() {
    try {
      // Try to fetch your site over HTTPS
      const response = await fetch(window.location.href, { method: 'HEAD' });
      
      // If it works and returns HTTPS, hide the banner
      if (window.location.protocol === "https:" && response.ok) {
        document.getElementById("site-status").style.display = "none";
      }
    } catch (e) {
      // Leave the banner visible if fetch fails
      console.warn("Site status check failed", e);
    }
  }

  // Run on load and every 30 seconds until hidden
  checkSiteStatus();
  const interval = setInterval(() => {
    if (document.getElementById("site-status").style.display !== "none") {
      checkSiteStatus();
    } else {
      clearInterval(interval);
    }
  }, 30000);
</script>
