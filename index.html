<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AIGLOBALNEWS</title>
<meta name="color-scheme" content="dark light"/>
<style>
:root{
  --bg:#0b1220;--card:#121a2b;--text:#e7edf8;--muted:#9fb0cf;
  --accent:#4da3ff;--accent2:#86c7ff;--border:#1e2a44;--shadow:0 8px 24px rgba(0,0,0,.35);
  --chip:#18243d;--chip-text:#e7edf8;
}
:root.light{
  --bg:#f6f8fc;--card:#fff;--text:#0d1b2a;--muted:#55637d;
  --accent:#0b6bcb;--accent2:#389cff;--border:#dbe5f4;--shadow:0 6px 20px rgba(15,29,61,.08);
  --chip:#eef4ff;--chip-text:#0d1b2a;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
  font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.wrap{max-width:900px;margin:auto;padding:16px}
header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:10}
.header-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.brand{font-weight:800;display:flex;align-items:center;gap:8px}
.status{margin-left:auto;font-size:.75rem;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--chip-text)}
.pillbar{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}
.pill{padding:6px 12px;border-radius:999px;background:var(--card);border:1px solid var(--border);cursor:pointer}
.pill.active{background:var(--accent);color:#fff;border:0}
.row{display:flex;gap:8px}
.search{flex:1;display:flex;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:4px 10px}
.search input{flex:1;background:transparent;border:0;color:var(--text);outline:none}
.btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer}
.btn:hover{background:var(--chip)}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:12px 0;box-shadow:var(--shadow)}
.meta{font-size:.8rem;color:var(--muted);margin-bottom:6px}
.title{font-weight:800;margin:4px 0}
.desc{color:var(--muted)}
.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.action{padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--chip);color:var(--chip-text);cursor:pointer;text-align:center}
.action.primary{background:var(--accent);color:#fff;border:0}
.result{margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:8px}
.close{float:right;cursor:pointer;color:var(--muted)}
.toggle{display:flex;align-items:center;gap:6px}
.note{font-size:.85rem;color:var(--muted);margin:8px 0}
.center{display:flex;justify-content:center;margin:12px}
.error{color:#ff8585}
@media (max-width:560px){
  .actions{grid-template-columns:1fr 1fr 1fr}
}
</style>
</head>
<body>
<header class="wrap">
  <div class="header-row">
    <div class="brand">üì∞ AIGLOBALNEWS</div>
    <div id="statusChip" class="status">detecting‚Ä¶</div>
    <label class="toggle"><input id="themeSwitch" type="checkbox"/> üåô/‚òÄÔ∏è</label>
  </div>
  <div id="pillbar" class="pillbar"></div>
  <div class="row">
    <div class="search"><input id="q" placeholder="Search headlines‚Ä¶"></div>
    <button id="refreshBtn" class="btn">Refresh</button>
  </div>
  <div class="note">
    Use üîé <b>Fact-check</b> (Google Fact Check + Worker fallback), ‚ú® <b>AI Summary</b> for quick context, and üîó <b>Share</b> for native sharing. Summaries are informational; always read the source.
  </div>
</header>

<div class="wrap">
  <main id="feed"></main>
  <div class="center"><button id="loadMore" class="btn">Load more</button></div>
</div>

<script>
/* ========= BACKEND AUTO-DETECT =========
   1) try same-origin Worker routes (preferred)
   2) fallback to workers.dev (hardcoded)
*/
const WORKERS_DEV = "https://aiglobalnews-worker.bmbotelho.workers.dev";
let API_BASE = "";   // same-origin when the Cloudflare Route aiglobalnews.co.uk/* is active

const statusChip = document.getElementById("statusChip");
async function detectBackend(){
  try{
    const r = await fetch("/__health", {cache:"no-store"});
    if(r.ok){ API_BASE = ""; statusChip.textContent = "same-origin"; return; }
    throw new Error("same-origin failed");
  }catch{
    API_BASE = WORKERS_DEV;
    statusChip.textContent = "workers.dev";
  }
}
function apiUrl(path, params){
  const base = API_BASE || "";
  const url = new URL(path, base || location.origin);
  if(params) Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  return url.toString();
}

/* ========= THEME ========= */
const root=document.documentElement, switchEl=document.getElementById("themeSwitch");
const saved=localStorage.getItem("theme");
if(saved==="light"){ root.classList.add("light"); switchEl.checked=true; }
switchEl.onchange=()=>{ if(switchEl.checked){root.classList.add("light");localStorage.setItem("theme","light");}
                        else{root.classList.remove("light");localStorage.setItem("theme","dark");} };

/* ========= UI / STATE ========= */
const SECTIONS=[
  {key:"all",label:"All"},
  {key:"nhs",label:"NHS"},
  {key:"workforce",label:"Workforce"},
  {key:"digital",label:"Digital"},
  {key:"economy",label:"Economy"},
  {key:"politics",label:"Politics"},
];
let page=1, section="all", query="", loading=false;
const feed=document.getElementById("feed"),
      q=document.getElementById("q"),
      refreshBtn=document.getElementById("refreshBtn"),
      loadMoreBtn=document.getElementById("loadMore"),
      pillbar=document.getElementById("pillbar");

function pillUI(){
  pillbar.innerHTML="";
  SECTIONS.forEach(s=>{
    const b=document.createElement("button");
    b.className="pill"+(s.key===section?" active":"");
    b.textContent=s.label;
    b.onclick=()=>{section=s.key;document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
                   b.classList.add("active"); page=1; feed.innerHTML=""; load(true);};
    pillbar.appendChild(b);
  });
}
pillUI();

function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
q.oninput = debounce(()=>{query=q.value.trim();page=1;feed.innerHTML="";load(true)},400);
refreshBtn.onclick=()=>{page=1;feed.innerHTML="";load(true)};
loadMoreBtn.onclick=()=>load(false);

const clean = s => (s||"").replace(/^<!\[CDATA\[/,"").replace(/\]\]>$/,"").trim();
const tfmt = iso => { try{ return new Date(iso).toLocaleString(); }catch{return ""} };

async function api(path, params){
  const url = apiUrl(path, params);
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

async function load(reset=false){
  if(loading) return; loading=true; loadMoreBtn.textContent="Loading‚Ä¶";
  try{
    const data = await api("/aggregate", {page, section, q: query});
    if(reset) feed.innerHTML="";
    (data.articles||[]).forEach(addCard);
    page++;
  }catch(e){
    console.error(e);
    if(page===1) feed.innerHTML = `<div class="error">Couldn't load headlines.</div>`;
  }finally{
    loading=false; loadMoreBtn.textContent="Load more";
  }
}

function addCard(a){
  const card = document.createElement("div"); card.className="card";
  const title = clean(a.title);
  card.innerHTML = `
    <div class="meta">${a.source||""} ¬∑ ${tfmt(a.publishedAt)}</div>
    <div class="title">${a.url ? `<a href="${a.url}" target="_blank" rel="noopener">${title}</a>` : title}</div>
    <div class="desc">${a.description||""}</div>
  `;
  const actions = document.createElement("div"); actions.className="actions";
  const res = document.createElement("div"); res.className="result"; res.hidden=true;
  const body = document.createElement("div"); const close = document.createElement("span");
  close.className="close"; close.textContent="Close"; close.onclick=()=>res.hidden=true;
  res.appendChild(close); res.appendChild(body);

  const mkBtn=(label,cls,fn)=>{const b=document.createElement("button");b.className="action "+(cls||"");b.textContent=label;b.onclick=fn;return b};

  actions.appendChild(mkBtn("Fact-check","", async ()=>{
    res.hidden=false; body.textContent="Checking‚Ä¶";
    try{
      const d = await api("/factcheck", {url:a.url, q:a.title});
      if(d && d.matches && d.matches.length){
        body.innerHTML = d.matches.map(m=>`
          <div style="margin:6px 0">
            <div><b>${m.claim||"Claim"}</b> ‚Äî <i>${m.rating||"Unrated"}</i></div>
            <div class="meta">${m.publisher||""} ¬∑ <a href="${m.url}" target="_blank" rel="noopener">source</a></div>
          </div>`).join("");
      }else{
        body.innerHTML = `<span class="meta">No direct matches; try official sources: <a target="_blank" rel="noopener" href="https://news.google.com">Google News</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org">Wikipedia</a>.</span>`;
      }
    }catch{ body.textContent="Fact-check failed."; }
  }));

  actions.appendChild(mkBtn("AI Summary","primary", async ()=>{
    res.hidden=false; body.textContent="Summarising‚Ä¶";
    try{
      const d = await api("/summary", {url:a.url, title:a.title});
      body.textContent = d.summary || "No summary available.";
    }catch{ body.textContent="Summary failed."; }
  }));

  actions.appendChild(mkBtn("Share","", ()=>{
    if(a.url && navigator.share){ navigator.share({title:a.title, url:a.url}); }
    else if(a.url){ navigator.clipboard.writeText(a.url); body.textContent="Link copied."; res.hidden=false; }
  }));

  card.appendChild(actions); card.appendChild(res); feed.appendChild(card);
}

/* kick-off */
(async function init(){
  await detectBackend();      // sets API_BASE and status chip
  await load(true);
})();
</script>
</body>
</html>
